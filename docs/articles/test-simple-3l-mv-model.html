<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Simple 3-level Multivariate Normal Model • probly</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Test Simple 3-level Multivariate Normal Model">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">probly</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/age-and-puberty-data.html">Age and Puberty Data</a>
    </li>
    <li>
      <a href="../articles/collect-data.html">Collect and Clean SPLT Data</a>
    </li>
    <li>
      <a href="../articles/descriptive-statistics.html">Descriptive Statistics for SPLT data</a>
    </li>
    <li>
      <a href="../articles/fit-model-to-participant-data.html">Fit model to participant data</a>
    </li>
    <li>
      <a href="../articles/test-simple-3l-mv-model.html">Test Simple 3-level Multivariate Normal Model</a>
    </li>
    <li>
      <a href="../articles/test-simulated-data.html">Test Simulated Data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Test Simple 3-level Multivariate Normal Model</h1>
                        <h4 class="author">John Flournoy</h4>
            
            <h4 class="date">2018-03-29</h4>
      
      

    </div>

    
    
<div class="contents">
<p>The goal of this vignette is to demonstrate that the multivariate normal model that I will use for each parameter in the learning model is able to be estimated accurately and without prohibitively excessive computer time. In these examples I show that accounting for the nested structure of data with observations nested in participants nested in sample may be important. I also show that the 3-level model using both centered and non-centered parameterization of the 3rd level group means gives similar results. Finally, it may be helpful to note that the centered (that is, standard) parameterization finishes sampling in much less time than the non-centered model.</p>
<p>Generate data where there are 3 conditions, and individual variation in probability of choosing ‘left’ for each condition. Set the mean probability of left for each condition to values in <code>beta_mu</code> below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(probly)
<span class="kw">set.seed</span>(<span class="dv">150319</span>/<span class="dv">2018</span>)
j &lt;-<span class="st"> </span><span class="dv">300</span> <span class="co">#number of subjects</span>
t &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co">#number of trials</span>
g &lt;-<span class="st"> </span><span class="dv">4</span> <span class="co">#number of subsamples</span>
c &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co">#number of conditions</span>
n &lt;-<span class="st"> </span>t*c*j <span class="co">#number of observations</span>
gg &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span>:g, <span class="dt">size =</span> j, <span class="dt">replace =</span> T) <span class="co">#group IDs</span>

hyper_gamma_mu &lt;-<span class="st"> </span><span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>) <span class="co">#The mean population effect</span>
hyper_gamma_sigma &lt;-<span class="st"> </span><span class="dv">1</span>
gamma_mu &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(c*g, hyper_gamma_mu, hyper_gamma_sigma), <span class="dt">nrow =</span> g, <span class="dt">byrow =</span> T) <span class="co">#specific sample mean effects</span>
gamma_sigma &lt;-<span class="st"> </span><span class="kw">matrix</span>(
    <span class="kw">c</span>(<span class="dv">1</span>, .<span class="dv">2</span>, .<span class="dv">2</span>,
      .<span class="dv">2</span>, <span class="dv">1</span>, .<span class="dv">2</span>,
      .<span class="dv">2</span>, .<span class="dv">2</span>, <span class="dv">1</span>),
    <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">byrow =</span> T
) <span class="co">#correlation among random effects at between individuals in the same sample</span>

beta_j &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(gamma_mu[gg,], <span class="dv">1</span>, function(mu) {MASS::<span class="kw">mvrnorm</span>(<span class="dv">1</span>, mu, gamma_sigma)}))

beta_j_df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(beta_j)
beta_j_df$b0 &lt;-<span class="st"> </span>beta_j_df[,<span class="dv">1</span>]
beta_j_df$b1 &lt;-<span class="st"> </span>beta_j_df[,<span class="dv">2</span>] -<span class="st"> </span>beta_j_df[,<span class="dv">1</span>]
beta_j_df$b2 &lt;-<span class="st"> </span>beta_j_df[,<span class="dv">3</span>] -<span class="st"> </span>beta_j_df[,<span class="dv">1</span>]

<span class="kw">summary</span>(beta_j_df)
<span class="co">#&gt;        V1                V2                V3                 b0         </span>
<span class="co">#&gt;  Min.   :-4.0175   Min.   :-4.0880   Min.   :-2.42453   Min.   :-4.0175  </span>
<span class="co">#&gt;  1st Qu.:-1.9956   1st Qu.:-1.3693   1st Qu.:-0.02771   1st Qu.:-1.9956  </span>
<span class="co">#&gt;  Median :-1.2536   Median :-0.4523   Median : 0.82168   Median :-1.2536  </span>
<span class="co">#&gt;  Mean   :-1.2278   Mean   :-0.3233   Mean   : 0.79465   Mean   :-1.2278  </span>
<span class="co">#&gt;  3rd Qu.:-0.5697   3rd Qu.: 0.6316   3rd Qu.: 1.59760   3rd Qu.:-0.5697  </span>
<span class="co">#&gt;  Max.   : 2.7481   Max.   : 3.5546   Max.   : 4.13714   Max.   : 2.7481  </span>
<span class="co">#&gt;        b1                b2        </span>
<span class="co">#&gt;  Min.   :-3.3279   Min.   :-2.876  </span>
<span class="co">#&gt;  1st Qu.:-0.2630   1st Qu.: 1.144  </span>
<span class="co">#&gt;  Median : 0.7616   Median : 2.071  </span>
<span class="co">#&gt;  Mean   : 0.9045   Mean   : 2.022  </span>
<span class="co">#&gt;  3rd Qu.: 2.0397   3rd Qu.: 2.968  </span>
<span class="co">#&gt;  Max.   : 5.5926   Max.   : 5.951</span>
<span class="kw">cor</span>(beta_j_df[,<span class="dv">1</span>:<span class="dv">3</span>])
<span class="co">#&gt;           V1         V2         V3</span>
<span class="co">#&gt; V1 1.0000000  0.1689937  0.2237496</span>
<span class="co">#&gt; V2 0.1689937  1.0000000 -0.1868787</span>
<span class="co">#&gt; V3 0.2237496 -0.1868787  1.0000000</span>
<span class="kw">cor</span>(beta_j_df[,<span class="dv">4</span>:<span class="dv">6</span>])
<span class="co">#&gt;            b0         b1         b2</span>
<span class="co">#&gt; b0  1.0000000 -0.5600779 -0.6023876</span>
<span class="co">#&gt; b1 -0.5600779  1.0000000  0.1827144</span>
<span class="co">#&gt; b2 -0.6023876  0.1827144  1.0000000</span>

<span class="kw">lapply</span>(<span class="dv">1</span>:g, function(grp) <span class="kw">cor</span>(beta_j_df[gg ==<span class="st"> </span>grp,<span class="dv">1</span>:<span class="dv">3</span>]))
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt;           V1        V2        V3</span>
<span class="co">#&gt; V1 1.0000000 0.2093452 0.2796338</span>
<span class="co">#&gt; V2 0.2093452 1.0000000 0.3103567</span>
<span class="co">#&gt; V3 0.2796338 0.3103567 1.0000000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt;           V1        V2        V3</span>
<span class="co">#&gt; V1 1.0000000 0.2573429 0.4433277</span>
<span class="co">#&gt; V2 0.2573429 1.0000000 0.2593508</span>
<span class="co">#&gt; V3 0.4433277 0.2593508 1.0000000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt;           V1        V2        V3</span>
<span class="co">#&gt; V1 1.0000000 0.2500850 0.1578322</span>
<span class="co">#&gt; V2 0.2500850 1.0000000 0.0453528</span>
<span class="co">#&gt; V3 0.1578322 0.0453528 1.0000000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt;           V1        V2        V3</span>
<span class="co">#&gt; V1 1.0000000 0.1453341 0.3041265</span>
<span class="co">#&gt; V2 0.1453341 1.0000000 0.2680003</span>
<span class="co">#&gt; V3 0.3041265 0.2680003 1.0000000</span>

dd &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">as.factor</span>(<span class="dv">1</span>:j),
                 <span class="dt">grp =</span> <span class="kw">as.factor</span>(gg),
                 <span class="dt">condition =</span> <span class="kw">as.factor</span>(<span class="kw">rep</span>(<span class="kw">rep</span>(<span class="dv">1</span>:<span class="dv">3</span>, <span class="dt">each =</span> n/j/<span class="dv">3</span>), <span class="dt">each =</span> j)))

design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(~<span class="st"> </span><span class="dv">0</span> +<span class="st"> </span>id:condition, dd)

dd$theta &lt;-<span class="st">  </span>design %*%<span class="st"> </span><span class="kw">as.vector</span>(beta_j)

dd$p &lt;-<span class="st"> </span>arm::<span class="kw">invlogit</span>(dd$theta)
dd$y &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="kw">dim</span>(dd)[<span class="dv">1</span>], <span class="dv">1</span>, dd$p)

dplyr::<span class="kw">summarize</span>(
    dplyr::<span class="kw">group_by</span>(dd, grp), 
    <span class="dt">N =</span> <span class="kw">length</span>(<span class="kw">unique</span>(id)))
<span class="co">#&gt; # A tibble: 4 x 2</span>
<span class="co">#&gt;   grp       N</span>
<span class="co">#&gt;   &lt;fct&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 1        87</span>
<span class="co">#&gt; 2 2        68</span>
<span class="co">#&gt; 3 3        70</span>
<span class="co">#&gt; 4 4        75</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lme4)
<span class="co">#&gt; Loading required package: Matrix</span>
<span class="kw">library</span>(brms)
<span class="co">#&gt; Loading required package: Rcpp</span>
<span class="co">#&gt; Loading required package: ggplot2</span>
<span class="co">#&gt; Loading 'brms' package (version 2.1.0). Useful instructions</span>
<span class="co">#&gt; can be found by typing help('brms'). A more detailed introduction</span>
<span class="co">#&gt; to the package is available through vignette('brms_overview').</span>
<span class="co">#&gt; Run theme_set(theme_default()) to use the default bayesplot theme.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'brms'</span>
<span class="co">#&gt; The following object is masked from 'package:lme4':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     ngrps</span>
<span class="kw">library</span>(rstan)
<span class="co">#&gt; Loading required package: StanHeaders</span>
<span class="co">#&gt; rstan (Version 2.17.3, GitRev: 2e1f913d3ca3)</span>
<span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span>
<span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span>
<span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span>
<span class="co">#&gt; rstan_options(auto_write = TRUE)</span>
<span class="kw">library</span>(future)
<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(<span class="st">'multiprocess'</span>)

glm_fit &lt;-<span class="st"> </span><span class="kw">glm</span>(y ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span>condition, <span class="dt">data =</span> dd, <span class="dt">family =</span> <span class="st">'binomial'</span>)

lme4_fit_fn &lt;-<span class="st"> '/data/jflournoy/split/probly/lme4_test_fit.RDS'</span>
lme4_fit_future &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/future">future</a></span>(
    <span class="kw"><a href="../reference/CachedFit.html">CachedFit</a></span>(
        {
            lme4::<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span>condition +<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span>condition |<span class="st"> </span>grp/id), <span class="dt">data =</span> dd, <span class="dt">family =</span> <span class="st">'binomial'</span>)
        },
        <span class="dt">rds_filename =</span> lme4_fit_fn))

lme4_fit_2L_fn &lt;-<span class="st"> '/data/jflournoy/split/probly/lme4_test_fit_2L.RDS'</span>
lme4_fit_2L_future &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/future">future</a></span>(
    <span class="kw"><a href="../reference/CachedFit.html">CachedFit</a></span>(
        {
            lme4::<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span>condition +<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span>condition |<span class="st"> </span>id), <span class="dt">data =</span> dd, <span class="dt">family =</span> <span class="st">'binomial'</span>)
        },
        <span class="dt">rds_filename =</span> lme4_fit_2L_fn))

lme4_fit_2L_2rx_fn &lt;-<span class="st"> '/data/jflournoy/split/probly/lme4_test_fit_2L_2rx.RDS'</span>
lme4_fit_2L_2rx_future &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/future">future</a></span>(
    <span class="kw"><a href="../reference/CachedFit.html">CachedFit</a></span>(
        {
            lme4::<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span>condition +<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span>condition |<span class="st"> </span>id) +<span class="st"> </span>(<span class="dv">1</span> +<span class="st"> </span>condition |<span class="st"> </span>grp), 
                        <span class="dt">data =</span> dd, <span class="dt">family =</span> <span class="st">'binomial'</span>)
        },
        <span class="dt">rds_filename =</span> lme4_fit_2L_2rx_fn))

<span class="kw">summary</span>(glm_fit)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; glm(formula = y ~ 1 + condition, family = "binomial", data = dd)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -1.4492  -1.0791  -0.7933   0.9280   1.6183  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept) -0.99479    0.01301  -76.49   &lt;2e-16 ***</span>
<span class="co">#&gt; condition2   0.75904    0.01744   43.51   &lt;2e-16 ***</span>
<span class="co">#&gt; condition3   1.61427    0.01777   90.86   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 123997  on 89999  degrees of freedom</span>
<span class="co">#&gt; Residual deviance: 115011  on 89997  degrees of freedom</span>
<span class="co">#&gt; AIC: 115017</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 4</span>

<span class="kw">rbind</span>(
    <span class="dt">means =</span> <span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>]),
    <span class="dt">glm_coef =</span> <span class="kw">c</span>(<span class="kw">coef</span>(glm_fit)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw">coef</span>(glm_fit)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw">coef</span>(glm_fit)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])),
    <span class="dt">glm_p =</span> arm::<span class="kw">invlogit</span>(<span class="kw">c</span>(<span class="kw">coef</span>(glm_fit)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw">coef</span>(glm_fit)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw">coef</span>(glm_fit)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)]))))
<span class="co">#&gt;               mean1      mean2     mean3</span>
<span class="co">#&gt; means     0.2699667  0.4413333 0.6501000</span>
<span class="co">#&gt; glm_coef -0.9947917 -0.2357525 0.6194788</span>
<span class="co">#&gt; glm_p     0.2699667  0.4413333 0.6501000</span>

<span class="kw">Sys.sleep</span>(<span class="dv">3</span>)
if(<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/resolved">resolved</a></span>(lme4_fit_future)){
    lme4_fit &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/value">value</a></span>(lme4_fit_future)
    <span class="kw">print</span>(<span class="kw">summary</span>(lme4_fit))
    <span class="kw">rbind</span>(
        <span class="dt">means =</span> <span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>]),
        <span class="dt">lme4_coef =</span> <span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])),
        <span class="dt">lme4_p =</span> arm::<span class="kw">invlogit</span>(<span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)]))))
    <span class="kw">print</span>(
        ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(hyper_gamma_mu),
                       <span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit) +<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)])) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))
    <span class="kw">print</span>(
        ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(gamma_mu), 
                   <span class="kw">unlist</span>(<span class="kw">coef</span>(lme4_fit)$grp+
<span class="st">                              </span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>),<span class="kw">coef</span>(lme4_fit)$grp[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)]))) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))
    <span class="kw">print</span>(
        ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(beta_j), 
                   <span class="kw">unlist</span>(<span class="kw">coef</span>(lme4_fit)$<span class="st">`</span><span class="dt">id:grp</span><span class="st">`</span>+
<span class="st">                              </span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">dim</span>(beta_j)[<span class="dv">1</span>]),<span class="kw">coef</span>(lme4_fit)$<span class="st">`</span><span class="dt">id:grp</span><span class="st">`</span>[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)]))) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))
}
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: y ~ 1 + condition + (1 + condition | grp/id)</span>
<span class="co">#&gt;    Data: dd</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;  96318.7  96459.8 -48144.4  96288.7    89985 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -5.5537 -0.6271 -0.2850  0.6748  5.9928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups Name        Variance Std.Dev. Corr       </span>
<span class="co">#&gt;  id:grp (Intercept) 1.2781   1.1306              </span>
<span class="co">#&gt;         condition2  1.7325   1.3163   -0.69      </span>
<span class="co">#&gt;         condition3  1.5496   1.2448   -0.66  0.56</span>
<span class="co">#&gt;  grp    (Intercept) 0.0547   0.2339              </span>
<span class="co">#&gt;         condition2  0.7732   0.8793   -0.19      </span>
<span class="co">#&gt;         condition3  0.4639   0.6811   -0.49 -0.65</span>
<span class="co">#&gt; Number of obs: 90000, groups:  id:grp, 300; grp, 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept)  -1.2233     0.1319  -9.274  &lt; 2e-16 ***</span>
<span class="co">#&gt; condition2    0.8556     0.3979   2.150   0.0315 *  </span>
<span class="co">#&gt; condition3    2.0514     0.3217   6.377 1.81e-10 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;            (Intr) cndtn2</span>
<span class="co">#&gt; condition2 -0.230       </span>
<span class="co">#&gt; condition3 -0.515 -0.547</span></code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/unnamed-chunk-2-1.png" width="672"><img src="test-simple-3l-mv-model_files/figure-html/unnamed-chunk-2-2.png" width="672"><img src="test-simple-3l-mv-model_files/figure-html/unnamed-chunk-2-3.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/resolved">resolved</a></span>(lme4_fit_2L_future)){
    lme4_fit_2L &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/value">value</a></span>(lme4_fit_2L_future)
    <span class="kw">print</span>(<span class="kw">summary</span>(lme4_fit_2L))
    <span class="kw">rbind</span>(
        <span class="dt">means =</span> <span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>]),
        <span class="dt">lme4_coef =</span> <span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])),
        <span class="dt">lme4_p =</span> arm::<span class="kw">invlogit</span>(<span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)]))))
    <span class="kw">print</span>(
        ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(beta_j), 
                   <span class="kw">unlist</span>(<span class="kw">coef</span>(lme4_fit_2L)$<span class="st">`</span><span class="dt">id</span><span class="st">`</span>+
<span class="st">                              </span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">dim</span>(beta_j)[<span class="dv">1</span>]),<span class="kw">coef</span>(lme4_fit_2L)$id[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)]))) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))
}
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: y ~ 1 + condition + (1 + condition | id)</span>
<span class="co">#&gt;    Data: dd</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;  96575.2  96659.9 -48278.6  96557.2    89991 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -5.8025 -0.6205 -0.2837  0.6769  6.0092 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups Name        Variance Std.Dev. Corr       </span>
<span class="co">#&gt;  id     (Intercept) 1.332    1.154               </span>
<span class="co">#&gt;         condition2  2.595    1.611    -0.58      </span>
<span class="co">#&gt;         condition3  2.038    1.428    -0.61  0.20</span>
<span class="co">#&gt; Number of obs: 90000, groups:  id, 300</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept) -1.23053    0.06855 -17.951   &lt;2e-16 ***</span>
<span class="co">#&gt; condition2   0.93459    0.09535   9.802   &lt;2e-16 ***</span>
<span class="co">#&gt; condition3   2.02188    0.08524  23.721   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;            (Intr) cndtn2</span>
<span class="co">#&gt; condition2 -0.585       </span>
<span class="co">#&gt; condition3 -0.615  0.225</span></code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/unnamed-chunk-2-4.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
if(<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/resolved">resolved</a></span>(lme4_fit_2L_2rx_future)){
    lme4_fit_2L_2rx &lt;-<span class="st"> </span>future::<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/value">value</a></span>(lme4_fit_2L_2rx_future)
    <span class="kw">print</span>(<span class="kw">summary</span>(lme4_fit_2L_2rx))
    <span class="kw">rbind</span>(
        <span class="dt">means =</span> <span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>]),
        <span class="dt">lme4_coef =</span> <span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])),
        <span class="dt">lme4_p =</span> arm::<span class="kw">invlogit</span>(<span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="dv">1</span>], <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="dv">1</span>:<span class="dv">2</span>]), <span class="kw">sum</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/fixef">fixef</a></span>(lme4_fit_2L_2rx)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)]))))
    <span class="kw">print</span>(
        ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(beta_j), 
                   <span class="kw">unlist</span>(<span class="kw">coef</span>(lme4_fit_2L_2rx)$<span class="st">`</span><span class="dt">id</span><span class="st">`</span>+
<span class="st">                              </span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">dim</span>(beta_j)[<span class="dv">1</span>]),<span class="kw">coef</span>(lme4_fit_2L_2rx)$id[,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)]))) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))
}
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: binomial  ( logit )</span>
<span class="co">#&gt; Formula: y ~ 1 + condition + (1 + condition | id) + (1 + condition | grp)</span>
<span class="co">#&gt;    Data: dd</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span>
<span class="co">#&gt;  96318.7  96459.8 -48144.4  96288.7    89985 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Scaled residuals: </span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -5.5537 -0.6271 -0.2850  0.6748  5.9928 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups Name        Variance Std.Dev. Corr       </span>
<span class="co">#&gt;  id     (Intercept) 1.2781   1.1306              </span>
<span class="co">#&gt;         condition2  1.7325   1.3163   -0.69      </span>
<span class="co">#&gt;         condition3  1.5496   1.2448   -0.66  0.56</span>
<span class="co">#&gt;  grp    (Intercept) 0.0547   0.2339              </span>
<span class="co">#&gt;         condition2  0.7732   0.8793   -0.19      </span>
<span class="co">#&gt;         condition3  0.4639   0.6811   -0.49 -0.65</span>
<span class="co">#&gt; Number of obs: 90000, groups:  id, 300; grp, 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed effects:</span>
<span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept)  -1.2233     0.1319  -9.274  &lt; 2e-16 ***</span>
<span class="co">#&gt; condition2    0.8556     0.3979   2.150   0.0315 *  </span>
<span class="co">#&gt; condition3    2.0514     0.3217   6.377 1.81e-10 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Correlation of Fixed Effects:</span>
<span class="co">#&gt;            (Intr) cndtn2</span>
<span class="co">#&gt; condition2 -0.230       </span>
<span class="co">#&gt; condition3 -0.515 -0.547</span></code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/unnamed-chunk-2-5.png" width="672"></p>
<p>The Stan model that is being estimated is:</p>
<p><span class="math display">\[
\text{press_right}_{i} \sim \text{bernoulli_logit}(x_{i}\beta_{jj[i]}) \\
\beta_{j} \sim \mathcal{N}_{\text{mv}}(\delta_{mm[j]}, \Sigma_{\beta})  \\
\Sigma = \text{diag_matrix}(\tau) \Omega \text{diag_matrix}(\tau) \\
\tau_{k} \sim \text{Cauchy}(0, 2.5) \\
\Omega \sim \text{lkj_corr}(2)\\ 
\delta_{mk} \sim \mathcal{N} (\mu_{\delta k}, \sigma_{\delta})  \\
\mu_{\delta} \sim \mathcal{N} (0, 5) \\
\sigma_{\delta} \sim \text{exponential} (1)
\]</span></p>
<p>Where</p>
<ul>
<li>press_right is a binary indicator that the participant pressed the key on the right,</li>
<li>
<span class="math inline">\(x_{i}\)</span> is dummy coded for each trial’s condition,</li>
<li>
<span class="math inline">\(\beta_j\)</span> is a vector of subject-level (for subject <span class="math inline">\(jj[i]\)</span>) coefficients for all K conditions,</li>
<li>
<span class="math inline">\(\delta_m\)</span> is a vector of K means (again, per condition) for participant <span class="math inline">\(j\)</span>’s group <span class="math inline">\(mm[j]\)</span>,</li>
<li>
<span class="math inline">\(\Sigma_{\beta}\)</span> is the covariance matrix, optimized as recommended in the Stan manual via <span class="math inline">\(\tau\)</span> and <span class="math inline">\(\Omega\)</span>,</li>
<li>
<span class="math inline">\(\mu_{\delta}\)</span> is the population mean for each K condition,</li>
<li>and <span class="math inline">\(\sigma_{\delta}\)</span> is the scale parameter for the population means.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># data {</span>
  <span class="co"># int&lt;lower=1&gt; N; //number of subjects</span>
  <span class="co"># int&lt;lower=1&gt; T; //max number of trials</span>
  <span class="co"># int&lt;lower=2&gt; K; //number of trial predictors (in this case, conditions)</span>
  <span class="co"># int&lt;lower=1&gt; L; //number of subject-level predictors. 1 = intercept only</span>
  <span class="co"># int&lt;lower=1,upper=T&gt; Tsubj[N]; //trials per subject</span>
  <span class="co"># int&lt;lower=-1,upper=1&gt; press_right[N,T]; //choices "0" = left, "1" = right</span>
  <span class="co"># int&lt;lower=-1,upper=3&gt; condition[N,T]; //1 = ctrl, 2 = mateseeking, 3 = status</span>
  <span class="co"># matrix[N, L] u; //group predictors. u[,1] = 1 for intercept</span>
<span class="co"># }</span>
press_right_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(dd$y, <span class="dt">nrow =</span> j)
condition_mat &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">as.numeric</span>(dd$condition), <span class="dt">nrow =</span> j)
data_for_stan &lt;-<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">N =</span> j,
    <span class="dt">T =</span> t*c,
    <span class="dt">K =</span> c,
    <span class="dt">M =</span> g,
    <span class="dt">mm =</span> gg,
    <span class="dt">Tsubj =</span> <span class="kw">rep</span>(t*<span class="dv">3</span>, j),
    <span class="dt">press_right =</span> press_right_mat,
    <span class="dt">condition =</span> condition_mat
)

stan_fit_fn.orig &lt;-<span class="st"> '/data/jflournoy/split/probly/stan_test_fit_c_l3.RDS'</span>
stan_fit_fn.repar &lt;-<span class="st"> '/data/jflournoy/split/probly/stan_test_fit_non_c_l3.RDS'</span>
if(!<span class="kw">file.exists</span>(stan_fit_fn.orig)){
    <span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multiprocess)
    stan_m_c &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan_model">stan_model</a></span>(<span class="dt">file =</span> <span class="st">'../exec/splt_rl_mvnorm_test_c_l3.stan'</span>)
    stan_optim_c &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-optimizing">optimizing</a></span>(stan_m_c,
                                    <span class="dt">data =</span> data_for_stan)
    <span class="kw">round</span>(stan_optim_c$par[<span class="kw">grep</span>(<span class="st">'delta'</span>, <span class="kw">names</span>(stan_optim_c$par))],<span class="dv">3</span>)
    stan_fit_test_c_f &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/future">future</a></span>({rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan">stan</a></span>(<span class="dt">file =</span> <span class="st">'../exec/splt_rl_mvnorm_test_c_l3.stan'</span>,
                                             <span class="dt">data =</span> data_for_stan, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">iter =</span> <span class="dv">1500</span>,
                                             <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">open_progress =</span> T)})
    stan_fit_test_c &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/value">value</a></span>(stan_fit_test_c_f)
    <span class="kw">saveRDS</span>(stan_fit_test_c, stan_fit_fn.orig)
} else {
    stan_fit_test_c &lt;-<span class="st"> </span><span class="kw">readRDS</span>(stan_fit_fn.orig)
}
if(!<span class="kw">file.exists</span>(stan_fit_fn.repar)){
    <span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multiprocess)
    stan_m_nc &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan_model">stan_model</a></span>(<span class="dt">file =</span> <span class="st">'../exec/splt_rl_mvnorm_test_non_c_l3.stan'</span>)
    stan_optim_nc &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-optimizing">optimizing</a></span>(stan_m_nc,
                                    <span class="dt">data =</span> data_for_stan)
    <span class="kw">round</span>(stan_optim_nc$par[<span class="kw">grep</span>(<span class="st">'delta'</span>, <span class="kw">names</span>(stan_optim_nc$par))],<span class="dv">3</span>)
    stan_fit_test_nc_f &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/future">future</a></span>({rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan">stan</a></span>(<span class="dt">file =</span> <span class="st">'../exec/splt_rl_mvnorm_test_non_c_l3.stan'</span>,
                                              <span class="dt">data =</span> data_for_stan, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">iter =</span> <span class="dv">1500</span>,
                                              <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">open_progress =</span> T)})
    stan_fit_test_nc &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/value">value</a></span>(stan_fit_test_nc_f)
    <span class="kw">saveRDS</span>(stan_fit_test_nc, stan_fit_fn.repar)
} else {
    stan_fit_test_nc &lt;-<span class="st"> </span><span class="kw">readRDS</span>(stan_fit_fn.repar)
}

par_names.c &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">'(delta|beta)'</span>, <span class="kw">names</span>(stan_fit_test_c), <span class="dt">value =</span> T)
par_names.nc &lt;-<span class="st"> </span><span class="kw">grep</span>(<span class="st">'(delta|beta)'</span>, <span class="kw">names</span>(stan_fit_test_nc), <span class="dt">value =</span> T)
stan_fit_extract.c &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(stan_fit_test_c, <span class="dt">pars =</span> par_names.c)
stan_fit_extract.nc &lt;-<span class="st"> </span>rstan::<span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanfit-method-extract">extract</a></span>(stan_fit_test_nc, <span class="dt">pars =</span> par_names.nc)
bayesplot::<span class="kw">mcmc_dens</span>(<span class="kw">as.array</span>(stan_fit_test_c), <span class="dt">regex_pars =</span> <span class="st">'mu_delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">]'</span>)</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bayesplot::<span class="kw">mcmc_dens</span>(<span class="kw">as.array</span>(stan_fit_test_nc), <span class="dt">regex_pars =</span> <span class="st">'mu_delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">]'</span>)</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-2.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bayesplot::<span class="kw">mcmc_trace</span>(<span class="kw">as.array</span>(stan_fit_test_c), <span class="dt">regex_pars =</span> <span class="st">'mu_delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">]'</span>)</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-3.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bayesplot::<span class="kw">mcmc_trace</span>(<span class="kw">as.array</span>(stan_fit_test_nc), <span class="dt">regex_pars =</span> <span class="st">'mu_delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">]'</span>)</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-4.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stan_fit_c_means &lt;-<span class="st"> </span><span class="kw">lapply</span>(stan_fit_extract.c, mean)
stan_fit_nc_means &lt;-<span class="st"> </span><span class="kw">lapply</span>(stan_fit_extract.nc, mean)
<span class="kw">print</span>(
    ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(beta_j),
                   <span class="kw">as.numeric</span>(
                       stan_fit_c_means[<span class="kw">grep</span>(<span class="st">'beta</span><span class="ch">\\</span><span class="st">['</span>, <span class="kw">names</span>(stan_fit_c_means))])) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-5.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(
    ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(beta_j),
                   <span class="kw">as.numeric</span>(
                       stan_fit_nc_means[<span class="kw">grep</span>(<span class="st">'beta</span><span class="ch">\\</span><span class="st">['</span>, <span class="kw">names</span>(stan_fit_nc_means))])) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-6.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(
    ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(gamma_mu),
                   <span class="kw">as.numeric</span>(
                       stan_fit_c_means[<span class="kw">grep</span>(<span class="st">'delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d,'</span>, <span class="kw">names</span>(stan_fit_c_means))])) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-7.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(
    ggplot2::<span class="kw">qplot</span>(<span class="kw">as.vector</span>(gamma_mu),
                   <span class="kw">as.numeric</span>(
                       stan_fit_nc_means[<span class="kw">grep</span>(<span class="st">'delta</span><span class="ch">\\</span><span class="st">[</span><span class="ch">\\</span><span class="st">d,'</span>, <span class="kw">names</span>(stan_fit_nc_means))])) +
<span class="st">        </span><span class="kw">geom_abline</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="test-simple-3l-mv-model_files/figure-html/test-stan-mvnorm-8.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rbind</span>(<span class="dt">stan =</span> stan_fit_c_means[<span class="kw">grep</span>(<span class="st">'mu_delta'</span>, <span class="kw">names</span>(stan_fit_c_means))],
      <span class="dt">raw_p =</span> arm::<span class="kw">logit</span>(<span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>])),
      <span class="dt">group_p =</span> <span class="kw">apply</span>(gamma_mu, <span class="dv">2</span>, mean))
<span class="co">#&gt;         mu_delta[1] mu_delta[2] mu_delta[3]</span>
<span class="co">#&gt; stan    -1.190436   -0.3686154  0.836373   </span>
<span class="co">#&gt; raw_p   -0.9947917  -0.2357525  0.6194788  </span>
<span class="co">#&gt; group_p -1.227143   -0.4394004  0.7905008</span>
<span class="kw">rbind</span>(<span class="dt">stan =</span> stan_fit_nc_means[<span class="kw">grep</span>(<span class="st">'mu_delta'</span>, <span class="kw">names</span>(stan_fit_nc_means))],
      <span class="dt">raw_p =</span> arm::<span class="kw">logit</span>(<span class="kw">unlist</span>(dplyr::<span class="kw">summarize</span>(dplyr::<span class="kw">group_by</span>(dd, condition), <span class="dt">mean =</span> <span class="kw">mean</span>(y))[,<span class="dv">2</span>])),
      <span class="dt">group_p =</span> <span class="kw">apply</span>(gamma_mu, <span class="dv">2</span>, mean))
<span class="co">#&gt;         mu_delta[1] mu_delta[2] mu_delta[3]</span>
<span class="co">#&gt; stan    -1.162693   -0.3534274  0.8202649  </span>
<span class="co">#&gt; raw_p   -0.9947917  -0.2357525  0.6194788  </span>
<span class="co">#&gt; group_p -1.227143   -0.4394004  0.7905008</span>
stan_fit_c_means$sigma_delta
<span class="co">#&gt; [1] 0.8038438</span>
stan_fit_nc_means$sigma_delta
<span class="co">#&gt; [1] 0.8042396</span>

<span class="kw">summary</span>(stan_fit_test_c, <span class="dt">pars =</span> <span class="kw">grep</span>(<span class="st">'delta'</span>,par_names.c, <span class="dt">value =</span> T), <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>))$summary
<span class="co">#&gt;                    mean     se_mean        sd        2.5%         50%</span>
<span class="co">#&gt; mu_delta[1] -1.19043600 0.009175692 0.4103494 -2.00752410 -1.19217483</span>
<span class="co">#&gt; mu_delta[2] -0.36861538 0.009129239 0.4082720 -1.22505029 -0.37287830</span>
<span class="co">#&gt; mu_delta[3]  0.83637300 0.009292838 0.4155883  0.05159399  0.83590059</span>
<span class="co">#&gt; sigma_delta  0.80384382 0.004714157 0.2108235  0.50265092  0.76334216</span>
<span class="co">#&gt; delta[1,1]  -1.29003323 0.013280930 0.1278729 -1.53910172 -1.28924739</span>
<span class="co">#&gt; delta[2,1]  -1.30984239 0.009890188 0.1351301 -1.57096298 -1.30849534</span>
<span class="co">#&gt; delta[3,1]  -0.75797525 0.009174405 0.1317907 -1.01197304 -0.76139865</span>
<span class="co">#&gt; delta[4,1]  -1.48716536 0.010171997 0.1325258 -1.75646132 -1.48719736</span>
<span class="co">#&gt; delta[1,2]   1.06425176 0.006807915 0.1075503  0.83998079  1.06821022</span>
<span class="co">#&gt; delta[2,2]  -1.06330302 0.007814280 0.1228586 -1.30564928 -1.06457622</span>
<span class="co">#&gt; delta[3,2]  -0.45419537 0.011147326 0.1257497 -0.69478455 -0.45126109</span>
<span class="co">#&gt; delta[4,2]  -0.99447886 0.007960459 0.1184132 -1.22552953 -0.99331691</span>
<span class="co">#&gt; delta[1,3]  -0.05010475 0.007040183 0.1071256 -0.25501624 -0.05146253</span>
<span class="co">#&gt; delta[2,3]   0.74431965 0.008074109 0.1245280  0.49444595  0.73854894</span>
<span class="co">#&gt; delta[3,3]   0.97109405 0.007441031 0.1112167  0.76175588  0.97077260</span>
<span class="co">#&gt; delta[4,3]   1.65394947 0.006726480 0.1199622  1.41998688  1.65581808</span>
<span class="co">#&gt;                  97.5%     n_eff     Rhat</span>
<span class="co">#&gt; mu_delta[1] -0.3707453 2000.0000 1.002813</span>
<span class="co">#&gt; mu_delta[2]  0.4145897 2000.0000 1.001045</span>
<span class="co">#&gt; mu_delta[3]  1.6557548 2000.0000 1.001098</span>
<span class="co">#&gt; sigma_delta  1.3184927 2000.0000 1.001660</span>
<span class="co">#&gt; delta[1,1]  -1.0391111   92.7044 1.026023</span>
<span class="co">#&gt; delta[2,1]  -1.0501067  186.6788 1.001170</span>
<span class="co">#&gt; delta[3,1]  -0.5020760  206.3543 1.011909</span>
<span class="co">#&gt; delta[4,1]  -1.2296722  169.7418 1.017266</span>
<span class="co">#&gt; delta[1,2]   1.2622266  249.5715 1.011011</span>
<span class="co">#&gt; delta[2,2]  -0.8260618  247.1913 1.017098</span>
<span class="co">#&gt; delta[3,2]  -0.2081034  127.2544 1.025577</span>
<span class="co">#&gt; delta[4,2]  -0.7579529  221.2708 1.010884</span>
<span class="co">#&gt; delta[1,3]   0.1526026  231.5361 1.004511</span>
<span class="co">#&gt; delta[2,3]   1.0027901  237.8728 1.007483</span>
<span class="co">#&gt; delta[3,3]   1.1987591  223.3952 1.021901</span>
<span class="co">#&gt; delta[4,3]   1.8836240  318.0629 1.014358</span>
<span class="kw">summary</span>(stan_fit_test_nc, <span class="dt">pars =</span> <span class="kw">grep</span>(<span class="st">'delta'</span>,par_names.nc, <span class="dt">value =</span> T), <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>))$summary
<span class="co">#&gt;                       mean     se_mean        sd         2.5%         50%</span>
<span class="co">#&gt; mu_delta[1]    -1.16269273 0.018645989 0.3909543 -1.921430020 -1.17291204</span>
<span class="co">#&gt; mu_delta[2]    -0.35342743 0.021691910 0.4220587 -1.222371292 -0.33908163</span>
<span class="co">#&gt; mu_delta[3]     0.82026485 0.021207903 0.4154852  0.002475087  0.81519036</span>
<span class="co">#&gt; sigma_delta     0.80423959 0.009427298 0.2146855  0.500985535  0.76222704</span>
<span class="co">#&gt; delta_raw[1,1] -0.17332066 0.024531459 0.4962157 -1.141615488 -0.17300542</span>
<span class="co">#&gt; delta_raw[2,1] -0.19806005 0.024004897 0.5066053 -1.184894863 -0.20365825</span>
<span class="co">#&gt; delta_raw[3,1]  0.49234107 0.026892550 0.5292283 -0.539726178  0.48836849</span>
<span class="co">#&gt; delta_raw[4,1] -0.41767603 0.027082819 0.5074712 -1.426668662 -0.40875410</span>
<span class="co">#&gt; delta_raw[1,2]  1.87344300 0.029183943 0.6916709  0.545735634  1.86109362</span>
<span class="co">#&gt; delta_raw[2,2] -0.95714628 0.031046640 0.5810495 -2.087261079 -0.96042475</span>
<span class="co">#&gt; delta_raw[3,2] -0.16442341 0.027827881 0.5248824 -1.196405113 -0.16884929</span>
<span class="co">#&gt; delta_raw[4,2] -0.85334894 0.030022619 0.5598560 -1.942417786 -0.86572549</span>
<span class="co">#&gt; delta_raw[1,3] -1.16635987 0.028956949 0.5772055 -2.309412605 -1.16572935</span>
<span class="co">#&gt; delta_raw[2,3] -0.11593031 0.027258724 0.5133032 -1.144703974 -0.11131769</span>
<span class="co">#&gt; delta_raw[3,3]  0.19972561 0.029992453 0.5248678 -0.789251108  0.19482733</span>
<span class="co">#&gt; delta_raw[4,3]  1.08297439 0.026842785 0.5721005 -0.008156408  1.08077888</span>
<span class="co">#&gt; delta[1,1]     -1.30302100 0.011674998 0.1300011 -1.570785860 -1.30270619</span>
<span class="co">#&gt; delta[2,1]     -1.32292556 0.011158158 0.1419978 -1.596785537 -1.31461835</span>
<span class="co">#&gt; delta[3,1]     -0.79626986 0.019319648 0.1494726 -1.120883814 -0.78769049</span>
<span class="co">#&gt; delta[4,1]     -1.48819065 0.012061761 0.1272798 -1.726155344 -1.48449288</span>
<span class="co">#&gt; delta[1,2]      1.06436500 0.010606113 0.1156182  0.836098520  1.06652706</span>
<span class="co">#&gt; delta[2,2]     -1.07531380 0.010900829 0.1285082 -1.336286921 -1.07514393</span>
<span class="co">#&gt; delta[3,2]     -0.47523626 0.010237325 0.1207604 -0.708037366 -0.47760273</span>
<span class="co">#&gt; delta[4,2]     -0.99765519 0.010353594 0.1171438 -1.225488118 -0.99821446</span>
<span class="co">#&gt; delta[1,3]     -0.06408593 0.008913977 0.1085670 -0.280036197 -0.06438867</span>
<span class="co">#&gt; delta[2,3]      0.73036346 0.008036718 0.1183135  0.504117751  0.72644345</span>
<span class="co">#&gt; delta[3,3]      0.97218021 0.011412725 0.1240980  0.737036405  0.97051666</span>
<span class="co">#&gt; delta[4,3]      1.63862731 0.008423839 0.1183751  1.421051838  1.63574630</span>
<span class="co">#&gt;                      97.5%     n_eff      Rhat</span>
<span class="co">#&gt; mu_delta[1]    -0.36455101 439.62370 1.0022321</span>
<span class="co">#&gt; mu_delta[2]     0.50292445 378.57349 1.0076629</span>
<span class="co">#&gt; mu_delta[3]     1.68946098 383.80940 0.9992077</span>
<span class="co">#&gt; sigma_delta     1.32556907 518.59811 1.0094901</span>
<span class="co">#&gt; delta_raw[1,1]  0.81585166 409.16104 1.0008227</span>
<span class="co">#&gt; delta_raw[2,1]  0.80898873 445.38923 1.0014697</span>
<span class="co">#&gt; delta_raw[3,1]  1.56650393 387.27744 1.0039714</span>
<span class="co">#&gt; delta_raw[4,1]  0.57659683 351.10348 1.0088500</span>
<span class="co">#&gt; delta_raw[1,2]  3.28230814 561.70863 1.0048237</span>
<span class="co">#&gt; delta_raw[2,2]  0.18990517 350.26530 1.0138111</span>
<span class="co">#&gt; delta_raw[3,2]  0.86858851 355.76545 1.0093772</span>
<span class="co">#&gt; delta_raw[4,2]  0.25850845 347.74076 1.0084607</span>
<span class="co">#&gt; delta_raw[1,3] -0.03491447 397.33359 0.9999503</span>
<span class="co">#&gt; delta_raw[2,3]  0.85658033 354.59848 1.0002144</span>
<span class="co">#&gt; delta_raw[3,3]  1.21080203 306.24985 1.0039193</span>
<span class="co">#&gt; delta_raw[4,3]  2.21068176 454.24435 1.0014899</span>
<span class="co">#&gt; delta[1,1]     -1.04495529 123.98826 1.0353946</span>
<span class="co">#&gt; delta[2,1]     -1.04768055 161.94900 1.0225393</span>
<span class="co">#&gt; delta[3,1]     -0.51450487  59.85837 1.0344928</span>
<span class="co">#&gt; delta[4,1]     -1.24166774 111.35182 1.0692491</span>
<span class="co">#&gt; delta[1,2]      1.28610298 118.83377 1.0263070</span>
<span class="co">#&gt; delta[2,2]     -0.83775743 138.97683 1.0456529</span>
<span class="co">#&gt; delta[3,2]     -0.24210940 139.14780 1.0199574</span>
<span class="co">#&gt; delta[4,2]     -0.76762090 128.01375 1.0523552</span>
<span class="co">#&gt; delta[1,3]      0.14670704 148.33805 1.0255314</span>
<span class="co">#&gt; delta[2,3]      0.97308325 216.72600 1.0072571</span>
<span class="co">#&gt; delta[3,3]      1.20641255 118.23631 1.0371555</span>
<span class="co">#&gt; delta[4,3]      1.87519548 197.46969 1.0267197</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Flournoy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
