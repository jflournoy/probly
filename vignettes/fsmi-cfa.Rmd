---
title: "Fundamental Social Motives Confirmatory Factor Analysis"
author: "John Flournoy"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: yes
    toc_depth: 3
    number_sections: FALSE
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "/home/jflournoy/Rlibs/probly/bib/dissertation.bib"
csl: "/home/jflournoy/Rlibs/probly/bib/apa-old-doi-prefix.csl"
---

Below, I begin to examine the fit of scales measuring behaviors, beliefs, attitudes, and strategies relevant to mate-seeking and status motives. After examining the item distributions to see if there are any very problematic subsets, I fit a confirmatory factor analysis to remaining scales. I also confirm that an exploratory factor analysis shows expected factor structure.

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = F, error = F,warning = F, echo = F, collapse = T,
  comment = "#>"
)
```

```{r setupoptions}
college_rubric_dir <- system.file('scoring_rubrics', 'college', package = 'probly')
adolescent_rubric_dir <- system.file('scoring_rubrics', 'adolescent', package = 'probly')

relationship_status <- c('long_term' = 1, 'actively_dating' = 2, 'single_nodate' = 3, 'single_neverdate' = 4)

##FORDEVLOPMENT:
college_rubric_dir <- '~/code_new/probly/inst/scoring_rubrics/college/'
adolescent_rubric_dir <- '~/code_new/probly/inst/scoring_rubrics/adolescent/'
###
make_factor_item_labels <- function(scale_key, factor_name_prefix = T, remove_string_from_factor = NULL){
    items <- milav::get_items_from_keys(scale_key)
    itemnames <- unlist(items)
    
    itemlabels <- unlist(
        lapply(seq_along(items), 
               function(i) {
                   if(!is.null(remove_string_from_factor)){
                       factor_name <- gsub(remove_string_from_factor, '', names(scale_key)[i])
                   } else {
                       factor_name <- names(scale_key)[i]
                   }
                   paste0(
                       factor_name, 
                       '_',
                       gsub('.*?(\\d+)', '\\1', items[[i]]))
               }))
    return(list(names = itemnames, labels = itemlabels))
}

plot_item_histograms <- function(item_data, scale_key, factor_name_prefix = T, remove_string_from_factor = NULL){
    name_labels <- make_factor_item_labels(
        scale_key, 
        factor_name_prefix = factor_name_prefix, 
        remove_string_from_factor = remove_string_from_factor)
    
    scale_item_data <- dplyr::select_at(
        item_data, 
        dplyr::vars(name_labels$names))
    
    p <- ggplot2::ggplot(
        dplyr::mutate(
            tidyr::gather(scale_item_data, item, value),
            item = factor(item, levels = name_labels$names, labels = name_labels$labels)),
        ggplot2::aes(x = value)) + 
        ggplot2::geom_histogram(ggplot2::aes(y=..density..), binwidth = 1, color = '#666666', fill = NA) + 
        ggplot2::geom_density(ggplot2::aes(y=..density..), adjust = 2) + 
        ggplot2::facet_wrap(~item) + 
        ggplot2::theme_minimal()
    return(p)
}

plot_lav_factor_pred <- function(lavfit, factor_name, orig_data, dv_name, ...){
    ngrps <- lavaan::inspect(lavfit, 'ngroups')
    if(ngrps > 1){
        grp_labs <- lavaan::inspect(lavfit, 'group.label')
        nobs <- lavaan::inspect(lavfit, 'nobs')
        gidx <- unlist(lapply(seq_along(grp_labs), function(i){
            rep(grp_labs[i], nobs[i])}))
    }
    dv_dat_ <- orig_data[,dv_name][[1]]
    dv_dat <- dv_dat_[unlist(lavaan::inspect(lavfit, what = 'case.idx'))]
    if(ngrps > 1){
        fact_pred <- unlist(lapply(lavaan::lavPredict(lavfit, type = 'lv'), function(d){
            d[,factor_name]
        }))   
    } else {
        fact_pred <- lavaan::lavPredict(lavfit, type = 'lv')[,factor_name]
    }
    if(ngrps > 1){
        return(ggplot2::qplot(fact_pred, dv_dat, color = gidx, ...))
    }
    return(ggplot2::qplot(fact_pred, dv_dat, ...))
}

create_bifactor <- function(scale_key, scales_to_use, factor_name){
    #returns factor and sets correlations to 0
    method_fac <- paste0('\n',
                         milav::make_factor_string(
                             milav::get_items_from_keys(
                                 scale_key[scales_to_use]),
                             factor_name = factor_name),
                         '\n', factor_name, ' ~~ ', 
                         paste(
                             paste0(
                                 '0*', 
                                 scales_to_use),
                             collapse = ' + '))
    return(method_fac)
}

save_out_list <- c()
save_out_dir <- '~/code_new/social-motives-rl-writeup/rda/'
if(!dir.exists(save_out_dir)){
    dir.create(save_out_dir)
}
```

```{r packages}
library(probly)
library(scorequaltrics)
library(milav)
library(dplyr)
library(tidyr)
library(lavaan)
library(semPlot)
library(psych)
```

```{r getdata}
data("splt_fsmi")
data("splt_dev_and_demog")
splt_fsmi <- splt_fsmi[splt_fsmi$SID != 360,]
splt_fsmi$partnered <- as.numeric(splt_fsmi$fsmi_relstatus == relationship_status['long_term'])

splt_dev_and_demog <- splt_dev_and_demog[splt_dev_and_demog$SID != 360,]

splt_fsmi_devdemog <- dplyr::left_join(splt_fsmi, splt_dev_and_demog, by = 'SID')
splt_fsmi_devdemog <- dplyr::mutate_at(splt_fsmi_devdemog,
                                       vars(contains('SES')), funs(ifelse(. == -99, NA, .)))

laste_30_repsponse_labels <- list(
    levels = c(0,1,2,3,4,5,6),
    labels = c('0', '1-2', '3-5', '6-9', '10-19', '20-29', 'All 30'))

#This may not be accurate for some people who report, earlier in the questionnaires, that they have had sex in
# the last six months. That question is more clear that sex can mean a lot of things. This says "sexual intercourse"
splt_fsmi_devdemog$sex_ever <- factor(splt_fsmi_devdemog$YRBS_31, levels = c(0,1), labels = c('No', 'Yes'))

splt_fsmi_devdemog$alcohol_ever <- factor(splt_fsmi_devdemog$YRBS_12, levels = c(0,1), labels = c('No', 'Yes'))
splt_fsmi_devdemog$alcohol_days_of_lst30 <- ordered(
    splt_fsmi_devdemog$YRBS_14,
    levels = laste_30_repsponse_labels$levels,
    labels = laste_30_repsponse_labels$labels)
splt_fsmi_devdemog$alcohol_5drnks_lst30 <- ordered(
    splt_fsmi_devdemog$YRBS_15,
    levels = laste_30_repsponse_labels$levels,
    labels = laste_30_repsponse_labels$labels)
splt_fsmi_devdemog$substance_pre_sex <- factor(splt_fsmi_devdemog$YRBS_35, 
                                               levels = c(0,1), labels = c('No', 'Yes'))

splt_fsmi_devdemog$sex_six_months <- splt_fsmi_devdemog$SES_11 == 5

splt_fsmi_devdemog$ordered_use_protection <- ordered(ifelse( #if
    !splt_fsmi_devdemog$sex_six_months & #haven't had sex in the last six months
        splt_fsmi_devdemog$SES_13 < 1, #report fewer than 1 sexual partner
    NA, #assign NA to use protection (we want to know whether they _do_, not _would_
    splt_fsmi_devdemog$SES_15), #otherwise, keep their original answer
    levels = 1:7,
    labels = c('Never', 'Rarely', 'Occasionally', 'About half the time', 
               'Usually', 'Most of the time', 'Every single time'))
    
splt_fsmi_devdemog$ordered_sex_freq <- ordered(
    ifelse(splt_fsmi_devdemog$SES_12 == 0 |
               (is.na(splt_fsmi_devdemog$SES_12) & !splt_fsmi_devdemog$sex_six_months), 
           0, 
           ifelse(splt_fsmi_devdemog$SES_12 <40, 
                  splt_fsmi_devdemog$SES_12 %/% 10 + 1, 
                  5)),
    labels = c('0', '1-9', '10-19', '20-29', '30-39', '40 or more'))

splt_fsmi_devdemog$ordered_num_partner <- ordered(
    ifelse(splt_fsmi_devdemog$SES_13 == 0 | 
               (is.na(splt_fsmi_devdemog$SES_13) & !splt_fsmi_devdemog$sex_six_months), 
           0,
           ifelse(splt_fsmi_devdemog$SES_13 < 4, 
                  splt_fsmi_devdemog$SES_13, 
                  4)),
    levels = 0:4,
    labels = c(0:3, '4 or more'))

splt_fsmi_devdemog$gender_c <- splt_fsmi_devdemog$gender - .5
splt_fsmi_devdemog$age_c <- splt_fsmi_devdemog$age - 18


fsmi_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'fsmi_scoring_rubric.csv')),
    type = 'scoring')
dnp_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'DominanceAndPrestige_scoring_rubric.csv')),
    type = 'scoring')
ksqr_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'K-SRQ_scoring_rubric.csv')),
    type = 'scoring')
saq_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'SAQ_scoring_rubric.csv')),
    type = 'scoring')
upps_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(adolescent_rubric_dir, 'UPPSP_scoring_rubric.csv')),
    type = 'scoring')

```


# Checking Items

```{r datacheck}
fsmi_key <- scorequaltrics::create_key_from_rubric(fsmi_rubric)
fsmi_key <- fsmi_key[names(fsmi_key) != 'fsmi_kin']
dnp_key <- scorequaltrics::create_key_from_rubric(dnp_rubric)
ksqr_key <- scorequaltrics::create_key_from_rubric(ksqr_rubric)
saq_key <- scorequaltrics::create_key_from_rubric(saq_rubric)
upps_key <- scorequaltrics::create_key_from_rubric(upps_rubric)

fsmi_cfa_model <- milav::create_cfa_from_keylist(fsmi_key)
dnp_cfa_model <- milav::create_cfa_from_keylist(dnp_key)
ksqr_cfa_model <- milav::create_cfa_from_keylist(ksqr_key)
saq_cfa_model <- milav::create_cfa_from_keylist(saq_key)
upps_cfa_model <- milav::create_cfa_from_keylist(upps_key)
```

## FSMI

```{r fig.width=8, fig.height=10}
plot_item_histograms(splt_fsmi, fsmi_key, remove_string_from_factor = 'fsmi_')
```

The CFA will not include kin care (missing data), family care (highly skewed), and mate retention general (highly skewed).

## Dominance and Prestige

```{r fig.width=6, fig.height=5}
plot_item_histograms(splt_fsmi, dnp_key, remove_string_from_factor = '_score')
```

## Kids social reward questionnaire

```{r fig.width=10, fig.height=7}
plot_item_histograms(splt_fsmi, ksqr_key, remove_string_from_factor = 'k_srq_')
```

The CFA will not include negative social potency (highly skewed), or prosocial iteractions (highly skewed). Target scales to use for status and mate seeking motives are the admiration scale, passivity scale, sexual relationshups scale, and sociability scale.

## Social achievement goals

```{r fig.width=7, fig.height=5}
plot_item_histograms(splt_fsmi, saq_key, remove_string_from_factor = 'saq_')
```

## Urgency, Premeditation, Perseverance, and Sensation Seeking

```{r fig.width=8, fig.height=12}
plot_item_histograms(splt_fsmi, upps_key) + 
    ggplot2::theme(strip.text = ggplot2::element_text(size = 6))
```

# Confirmatory factor analyses and exploration

## FSMI

```{r fsmifullcfa}
scales_to_use <- names(fsmi_key)[!names(fsmi_key) %in% c('fsmi_kin', 'fsmi_fam', 'fsmi_retgen')]
fsmi_cfa_model <- milav::create_cfa_from_keylist(
    fsmi_key[scales_to_use])

fsmi_cfa_model_method <- paste0(
    fsmi_cfa_model,
    create_bifactor(fsmi_key, scales_to_use, factor_name = 'fsmi_bifac'))

fsmi_cfa <- lavaan::lavaan(model = fsmi_cfa_model, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)

fsmi_cfa_method <- lavaan::lavaan(model = fsmi_cfa_model_method, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)

knitr::kable(
    cbind(
        lavaan::anova(fsmi_cfa, fsmi_cfa_method),
        do.call(
            rbind,
            lapply(c(fsmi_cfa_method, fsmi_cfa), 
                   lavaan::fitmeasures,
                   fit.measures = c('cfi', 'rmsea', 'mfi')))),
    digits = 3)

summary(fsmi_cfa, stand = T)
summary(fsmi_cfa_method, standardize = T)

fsmi_cfa_lrt <- lavTestLRT(fsmi_cfa, fsmi_cfa_method)
fsmi_cfa_fits <- list(
    lapply(list('baseline'=fsmi_cfa, 'bifac'=fsmi_cfa_method),
           lavaan::fitmeasures,
           fit.measures = c('RMSEA', 'mfi')),
    lapply(list('baseline'=fsmi_cfa, 'bifac'=fsmi_cfa_method),
           semTools::moreFitIndices,
           fit.measures = c('gammaHat', 'adjGammaHat')))
```

A model for the FSMI scale without a method bifactor fits substantially worse than that with the method factor.

```{r}
options(knitr.kable.NA = '')
knitr::kable(fsmi_cfa_lrt)
knitr::kable(do.call(cbind, lapply(fsmi_cfa_fits, function(x) t(as.data.frame(x)))))
```

```{r eval = F}
psych::fa.parallel(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], plot = F)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], 
                nfactors = 8, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25, short = T)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], 
                nfactors = 9, n.iter = 1, rotate = 'bifactor',
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = F, cut = .25)
```

Exploratory factor analysis (not shown, but code for which is above) results in 8 factors, with high loadings grouped as expected and minimal cross loadings > .25. The bifactor rotation (with 9 factors) also shows this pattern.

(ref:fsmicfaplot1) FSMI CFA with method bifactor. Path weight reflects standardized loading strength, with minimum cuttoff for showing path set at .20, and maximum weight at .90 (apparent for several mate-seeking items). Residual and means not shown.

```{r fsmicfaplot1, fig.width=8, fig.height=5, fig.cap = '(ref:fsmicfaplot1)'}
semPlot::semPaths(fsmi_cfa_method, 
                  bifactor = 'fsmi_bifac', 
                  layout = 'tree3', 
                  rotation = 3, 
                  intercepts = F, residuals = F, 
                  what = 'std', whatLabels = 'none', 
                  nCharNodes = 12, sizeMan = 1.5,
                  minimum = .20, maximum = .9, curvature = 3.5)
```

(ref:fsmicfaplot2) FSMI CFA. Path weight reflects standardized loading strength, with minimum cuttoff for showing path set at .20, and maximum weight at .90 (apparent for several mate-seeking items). Residual and means not shown.

```{r fsmicfaplot2, fig.width=8, fig.height=2.5, fig.cap = '(ref:fsmicfaplot2)'}
semPlot::semPaths(fsmi_cfa, 
                  bifactor = '', 
                  layout = 'tree3', 
                  rotation = 3, 
                  intercepts = F, residuals = F, 
                  what = 'std', whatLabels = 'none', 
                  nCharNodes = 12, sizeMan = 1.5, sizeLat = 9,
                  minimum = .20, maximum = .9, curvature = 1)
```

The two factor structures are shown above.

### FSMI Discussion

The factor model, fit to all but three of the original scale's factors (child-care, care for family, general mate retention; N = 225) shows somewhat reasonable, but not great, fit (RMSEA = `r round(fsmi_cfa_fits[[1]]$baseline[['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_cfa_fits[[2]]$baseline[['gammaHat']],3)`). 
This deviates from the results reported by Neel and colleagues [-@neel2015], where each factor, or set of related factors, was tested independently.
A parallel scree plot analysis (psych package version `r packageVersion('psych')`) suggested 8 factors, with all item loadings dominant on expected factors. 
There is some evidence that including a factor that accounts for an overall method factor improve model fit.
Adding such a method bifactor improved the fit somewhat (RMSEA = `r round(fsmi_cfa_fits[[1]]$bifac[['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_cfa_fits[[2]]$bifac[['gammaHat']],3)`).
Model comparison substantially favors the less parsimonious model that includes the method bifactor (`r paste(paste(c('$\\Delta$AIC = ','$\\Delta$BIC = ', '$\\Delta$Df = '), round(apply((fsmi_cfa_lrt[,c('AIC','BIC', 'Df')]),2,diff),0)), collapse = ', ')`).
Although this bifactor does improve fit across all factors, it does not load strongly on either status or mate-seeking, so I do not account for in in analyses below.

```{r mateseekingstatus}
scales_to_use_mate_stat <- c('fsmi_mate', 'fsmi_stat')
fsmi_cfa_matestat_model <- milav::create_cfa_from_keylist(
    fsmi_key[scales_to_use_mate_stat])

fsmi_cfa_matestat <- lavaan::lavaan(model = fsmi_cfa_matestat_model, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)

fsmi_matestat_cfa_fit <- list(
    lavaan::fitmeasures(fsmi_cfa_matestat,
                        fit.measures = c('rmsea', 'mfi')),
    semTools::moreFitIndices(fsmi_cfa_matestat,
           fit.measures = c('gammaHat', 'adjGammaHat')))

fsmi_mate_stat_par <- parameterestimates(fsmi_cfa_matestat, stan = T)
fsmi_mate_stat_cor <- fsmi_mate_stat_par[fsmi_mate_stat_par$lhs == 'fsmi_mate' &  fsmi_mate_stat_par$rhs == 'fsmi_stat',]
```

(ref:fsmicfamatestatplot) FSMI mate-seeking & status CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r fsmicfamatestatplot, fig.width=8, fig.height=2.5, fig.cap = '(ref:fsmicfamatestatplot)'}
semPlot::semPaths(fsmi_cfa_matestat, 
                  layout = 'tree2', 
                  rotation = 1, 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 5, sizeLat = 9,
                  minimum = .0, maximum = .9, curvature = 3.5)

save_out_list <- c(save_out_list, 'fsmi_cfa_matestat', 'fsmi_matestat_cfa_fit', 'fsmi_mate_stat_par', 'fsmi_mate_stat_cor')
```

A CFA for mate-seeking and status factors fit well (RMSEA = `r round(fsmi_matestat_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_matestat_cfa_fit[[2]][['gammaHat']],3)`), with the two factors showing a small, positive, non-significant correlation ($r = `r round(fsmi_mate_stat_cor[['std.all']],2)`, Z = `r round(fsmi_mate_stat_cor[['z']],2)`$).

Note that item 54, "I do not worry very much about losing status" has a particularly low loading on the status factor.

## K-SRQ

```{r ksrq}
scales_to_use_ksrq <- c('k_srq_admiration', 'k_srq_passivity', 
                        'k_srq_sexual_relationships',
                        'k_srq_sociability')
ksrq_model <- milav::create_cfa_from_keylist(
    ksqr_key[scales_to_use_ksrq])

ksrq_cfa <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)

ksrq_cfa_fit <- list(
    lavaan::fitmeasures(ksrq_cfa,
                        fit.measures = c('rmsea', 'mfi')),
    semTools::moreFitIndices(ksrq_cfa,
           fit.measures = c('gammaHat', 'adjGammaHat')))
```

```{r eval = F}
psych::fa.parallel(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))])
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))], 
                nfactors = 4, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))], 
                nfactors = 3, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25)
```

```{r}
ksrq_3factor_keys <- list(
    ML1 = c('K_SRQ_11', 
            'K_SRQ_18', 
            'K_SRQ_1',  
            'K_SRQ_7',  
            'K_SRQ_10'),
    ML2 = c('K_SRQ_4',  
            'K_SRQ_20', 
            'K_SRQ_13', 
            'K_SRQ_9',  
            'K_SRQ_15'),
    ML3 = c('K_SRQ_12', 
            'K_SRQ_21', 
            'K_SRQ_23'))
ksrq_3factor_model <- milav::create_cfa_from_keylist(ksrq_3factor_keys)

ksrq_3factor_cfa <- lavaan::lavaan(model = ksrq_3factor_model, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)
ksrq_3fac_cfa_fit <- list(
    lavaan::fitmeasures(ksrq_3factor_cfa,
                        fit.measures = c('rmsea', 'mfi')),
    semTools::moreFitIndices(ksrq_3factor_cfa,
           fit.measures = c('gammaHat', 'adjGammaHat')))

summary(ksrq_cfa, standardize = T)
summary(ksrq_3factor_cfa, stand = T)
```


(ref:ksrqcfaplot) K-SRQ CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r ksrqcfaplot, fig.width=8, fig.height=3.5, fig.cap = '(ref:ksrqcfaplot)'}
semPlot::semPaths(ksrq_cfa, 
                  layout = 'tree2', 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 6, sizeLat = 10,
                  minimum = .0, maximum = 1, curvature = 1.25)
```

(ref:ksrq3faccfaplot) K-SRQ CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r ksrq3faccfaplot, fig.width=8, fig.height=3.5, fig.cap = '(ref:ksrq3faccfaplot)'}
semPlot::semPaths(ksrq_3factor_cfa, 
                  layout = 'tree2', 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 6, sizeLat = 10,
                  minimum = .0, maximum = 1, curvature = 1.25)
```

```{r ksrq3facfsmimate}
ksrq_matestat_model <- paste(fsmi_cfa_matestat_model, ksrq_model, sep = '\n')
ksrq_matestat_cfa_nogrp <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)
ksrq_matestat_cfa <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered')
ksrq_matestat_grp_const_cfa <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings'))
ksrq_matestat_grp_const_cfa_cov_sexrel_test <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings', 'lv.covariances'),
    group.partial = c(
        paste0('fsmi_mate~~', 
               c('fsmi_stat','k_srq_admiration',
                 'k_srq_passivity', 'k_srq_sociability')),
        paste0('fsmi_stat~~', c('k_srq_admiration', 'k_srq_passivity',
                                'k_srq_sexual_relationships', 'k_srq_sociability')),
        paste0('k_srq_admiration~~', c('k_srq_passivity',
                                       'k_srq_sexual_relationships',
                                       'k_srq_sociability')),
        paste0('k_srq_passivity~~', c('k_srq_sexual_relationships',
                                      'k_srq_sociability')),
        paste0('k_srq_sexual_relationships~~', c('k_srq_sociability'))
    ))
ksrq_matestat_grp_const_cfa_cov_admir_test <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings', 'lv.covariances'),
    group.partial = c(
        paste0('fsmi_mate~~', 
               c('fsmi_stat','k_srq_admiration',
                 'k_srq_passivity', 'k_srq_sexual_relationships',
                 'k_srq_sociability')),
        paste0('fsmi_stat~~', c('k_srq_passivity',
                                'k_srq_sexual_relationships', 'k_srq_sociability')),
        paste0('k_srq_admiration~~', c('k_srq_passivity',
                                       'k_srq_sexual_relationships',
                                       'k_srq_sociability')),
        paste0('k_srq_passivity~~', c('k_srq_sexual_relationships',
                                      'k_srq_sociability')),
        paste0('k_srq_sexual_relationships~~', c('k_srq_sociability'))
    ))


ksrq_matestat_cfa_fit <- list(
    uncon = c(lavaan::fitmeasures(ksrq_matestat_cfa,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_cfa,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmet = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmetcovsexrel = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa_cov_sexrel_test,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa_cov_sexrel_test,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmetcovadmir = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa_cov_admir_test,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa_cov_admir_test,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))))

#probably metric invariant, but close to a worse fit.
# round(ksrq_matestat_cfa_fit$grpmet - ksrq_matestat_cfa_fit$uncon,5)
# round(ksrq_matestat_cfa_fit$grpmetcovsexrel - ksrq_matestat_cfa_fit$grpmet,5)
# round(ksrq_matestat_cfa_fit$grpmetcovadmir - ksrq_matestat_cfa_fit$grpmet,5)

ksrq_matestat_grp_const_cfa_par <- parameterestimates(ksrq_matestat_grp_const_cfa, stan = T)
ksrq_matestat_mate_sr_cor <- ksrq_matestat_grp_const_cfa_par[
    ksrq_matestat_grp_const_cfa_par$lhs == 'fsmi_mate' & 
        ksrq_matestat_grp_const_cfa_par$rhs == 'k_srq_sexual_relationships',]
ksrq_matestat_stat_sr_cor <- ksrq_matestat_grp_const_cfa_par[
    ksrq_matestat_grp_const_cfa_par$lhs == 'fsmi_stat' & 
        ksrq_matestat_grp_const_cfa_par$rhs == 'k_srq_sexual_relationships',]
ksrq_matestat_metric_invar_stats <- do.call(sprintf, 
        c(list(fmt = '$\\delta$RMSEA = %0.5f, $\\delta$MFI = %0.3f, $\\delta\\hat{\\gamma}$ = %0.3f'),
          (ksrq_matestat_cfa_fit$grpmet - ksrq_matestat_cfa_fit$uncon)[1:3]))

ksqr_matestat_cordf_l <- dplyr::select(
    dplyr::filter(
        ksrq_matestat_grp_const_cfa_par,
        lhs %in% c('fsmi_mate', 'fsmi_stat',
                   'k_srq_passivity',
                   'k_srq_admiration',
                   'k_srq_sexual_relationships'),
        op == '~~',
        rhs %in% c('fsmi_stat', 'k_srq_passivity',
                   'k_srq_sexual_relationships', 
                   'k_srq_admiration', 
                   'k_srq_sociability'),
        lhs != rhs),
    lhs, op, rhs, group, est, ci.upper, ci.lower, std.all, z)
ksqr_matestat_cordf <- dplyr::mutate(
    tidyr::spread(
        tidyr::unite(
            tidyr::gather(
                ksqr_matestat_cordf_l,
                par, value, est, ci.upper, ci.lower, std.all, z), 
            grouppar, par, group),
        grouppar, value),
    est_rep_1 = sprintf('% 0.2f [% 0.2f,% 0.2f]', est_1, ci.lower_1, ci.upper_1),
    est_rep_2 = sprintf('% 0.2f [% 0.2f,% 0.2f]', est_2, ci.lower_2, ci.upper_2))

save_out_list <- c(save_out_list, 'ksrq_matestat_grp_const_cfa_par', 'ksrq_matestat_cfa_fit',
                   'ksrq_matestat_mate_sr_cor', 'ksrq_matestat_stat_sr_cor',
                   'ksrq_matestat_metric_invar_stats','ksqr_matestat_cordf',
                   'ksqr_matestat_cordf_l')
```


(ref:ksqrmatestatcor) Correlations between FSMI and K-SRQ scales of interest.

```{r}
knitr::kable(
    dplyr::select(ksqr_matestat_cordf,
                  lhs, op, rhs, est_rep_1, est_rep_2, std.all_1, std.all_2),
    digits = 2,
    caption = '(ref:ksqrmatestatcor)')
```

```{r fig.width=4.75, fig.height=5, fig.cap='(ref:ksqrmatestatcor)'}
scale_labels <- c('fsmi_mate' = expression(paste('Mate-seeking')[F]),
                  'fsmi_stat' = expression(paste('Status')[F]),
                  'k_srq_admiration' = expression(paste('Admiration')[K]),
                  'k_srq_passivity' = expression(paste('Passivity')[K]),
                  'k_srq_sexual_relationships' = expression(paste('Sexual Rel.')[K]),
                  'k_srq_sociability' = expression(paste('Sociality')[K]))

ggplot2::theme_set(ggplot2::theme_minimal())
fsmi_ksrq_plot <- ggplot2::ggplot(
    dplyr::mutate_at(ksqr_matestat_cordf_l,
                     dplyr::vars(lhs,rhs),
                     funs(factor(., levels = names(scale_labels), labels = scale_labels))),
    ggplot2::aes(x = factor(group, levels = 1:2, labels = c('- LTR', '+ LTR')), 
                 y = est)) + 
    ggplot2::geom_hline(yintercept = 0, color = '#666666') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0) + 
    ggplot2::geom_point() + 
    ggplot2::facet_grid(lhs ~ rhs, switch = 'y', labeller = ggplot2::label_parsed) + 
    ggplot2::coord_cartesian(ylim = c(-1,1)) + 
    ggplot2::scale_y_continuous(position = 'right', breaks = c(-.5, .5)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 360-45, hjust = 0)) + 
    ggplot2::labs(x = '', y = 'Estimate and 95% confidence interval')
fsmi_ksrq_plot
save_out_list <- c(save_out_list, 'fsmi_ksrq_plot')
```

### K-SRQ and age

```{r}
splt_fsmi_devdemog$age_c2 <- splt_fsmi_devdemog$age_c^2

ksrq_age_model <- paste(
    ksrq_model,
    paste0(paste(scales_to_use_ksrq, collapse = ' + '), ' ~ age_c + age_c2 + gender_c + age_c:gender_c + age_c2:gender_c'),
    sep = '\n')

ksrq_protection_age_sem <- lavaan::lavaan(
    model = ksrq_age_model, 
    data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_protection_age_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ and age; N obs. = ',
                     lavaan::nobs(ksrq_protection_age_sem)))


ksrq_age_ints <- inspect(ksrq_protection_age_sem, 'mean.lv')
ksrq_age_betas <- inspect(ksrq_protection_age_sem, 'coef')$beta[1:4, c(5,7,6,8,9)]

age_gender_pred_df <- as.data.frame(expand.grid(age = 11:25, gender_c = c(-.5, .5)))
age_gender_pred_df$age_c <- age_gender_pred_df$age - 18
age_gender_pred_df$age_c2 <- age_gender_pred_df$age_c^2
age_gender_pred_mat <- model.matrix(~age_c*gender_c+age_c2*gender_c, data = age_gender_pred_df)

ksrq_pred_factor_scores <- do.call(cbind, lapply(seq_along(ksrq_age_ints), function(i){
    y <- age_gender_pred_mat %*% as.vector(c(ksrq_age_ints[[i]], ksrq_age_betas[i,]))
    dimnames(y)[2] <- names(ksrq_age_ints)[[i]]
    y
}))

participant_measurements <- lavaan::lavPredict(ksrq_protection_age_sem)
ksrq_age_model_data <- as.data.frame(lavaan::inspect(ksrq_protection_age_sem, 'data'))
names(ksrq_age_model_data) <- lavaan::lavNames(ksrq_protection_age_sem)
ksrq_age_model_data <- cbind(ksrq_age_model_data, participant_measurements)
ksrq_age_model_data_l <- tidyr::gather(
    dplyr::select(ksrq_age_model_data, age_c:gender_c, k_srq_admiration:k_srq_sociability),
    factor,
    value,
    -gender_c, -age_c, -age_c2)
ksrq_age_model_data_l$age <- ksrq_age_model_data_l$age_c + 18
ksrq_age_model_data_l <- dplyr::filter(
    ksrq_age_model_data_l,
    !is.na(gender_c),
    !is.na(age))

age_gender_pred_df <- tidyr::gather(
    cbind(age_gender_pred_df, ksrq_pred_factor_scores),
    factor,
    value,
    -age, -gender_c, -age_c, -age_c2)

ggplot2::ggplot(
    age_gender_pred_df,
    ggplot2::aes(x = age, y = value, group = gender_c, color = factor(gender_c))) + 
    ggplot2::geom_point(data = ksrq_age_model_data_l,
                        alpha = .5) +
    ggplot2::geom_line(data = ksrq_age_model_data_l, 
                       stat = 'smooth') +
    ggplot2::geom_line() + 
    ggplot2::facet_wrap(~factor) + 
    ggplot2::coord_cartesian(xlim = c(min(ksrq_age_model_data_l$age, na.rm = T), 
                                      max(ksrq_age_model_data_l$age, na.rm = T)),
                             ylim = c(-4.5, 3))

```


### K-SRQ Discussion

A CFA for four of the K-SRQ factors (admiration, passivity, sexual relationships, and sociability) fit fairly well (RMSEA = `r round(ksrq_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(ksrq_cfa_fit[[2]][['gammaHat']],3)`). 
All factors except passivity were strongly inter-correlated, raising doubts about the discriminant validity of the separate factors.
A parallel scree plot analysis suggests a 3 factor structure, with one item from the original sociability factor loading on a factor with the admiration items (weakly), and the other two loading with the sexual relationships items.
A CFA using this factor structure (with no cross-loadings) demonstrates similar fit to the _a priori_ model (RMSEA = `r round(ksrq_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(ksrq_cfa_fit[[2]][['gammaHat']],3)`), and with similarly substantial correlations between the former admiration and sexual relationships factors.
A 4 factor EFA retains this general structure, while letting the sociability item, which previously loaded with admiration items, dominate its own factor.
The new 3-factor structure improves somewhat on the _a priori_ model, but the sexual relationships factor has not become any more interpretable as representing a mate-seeking motivation, per se.
Moreover, the sexual relationship factor, as well as its cousin in the 3-factor model both show nominally higher correlations with FSMI status than FSMI mate-seeking.
I use the _a priori_ scale throughout.

The items on the FSMI mate-seeking scale ask almost exlusively aboout seaching for a _new_ romantic or sexula partner, while the K-SRQ sexual relationship scale asks about enjoyment of socio-sexual interaction (e.g., kissing, flirting).
One would expect that the FSMI mate-seeking and K-SRQ sexual relationship correlation would be different between those who are in long term relationships and those who are not.
There is, in fact, a notable difference in the sign of this correlation between people who report being in a long-term relationship than people how report dating, or being single and not dating. 
In a model where factor loadings have been constrained across group [with minimal difference in fit statistics which is necessary for comparison of factor covariances; `r ksrq_matestat_metric_invar_stats`; @gregorich2006], people who are in a long term relationship show a negative correlation between FSMI mate-seeking K-SRQ sexual relationships (Table \@ref(fig:ksqrmatestatcor). 
For people who are not in long-term relationships, there is a positive, significant, correlation between FSMI mate-seeking and the K-SRQ sexual relationships factor.
The relation between FSMI status and this same factor is, however, nominally higher regardless of long-term relationship status.

The K-SRQ admiration-derived factor showed reasonably high correlation with FSMI status, although this was not dissimiler in magnitude from the correlation it shows with the K-SRQ sexual relationship factor.

Generally, the three K-SRQ subscales of interest (but not the passivity subscale) all correlate rather highly among themselves. All four K-SRQ subscales (inlcuding passivity) tend to medium to small correlations with FSMI mate-seeking among people not in long-term relationships, and small or negative correlations among those not in long-term relationships. Across both groups, FSMI status shows medium to large correlations to the K-SRQ subscales except for passivity.

Given how differently the K-SRQ sexual relationships factor covaries with other relevant contructs and across groups, it is clear that it is measuring something distinctly from what the FSMI mate seeking factor is measuring.
The distinction between the seeking new romantic or sexual partners, and enjoyment of engaging in socio-sexual behavior may be important when examining how these motivational factors relate to risk-taking.
Past work has shown that sexual activity (age at first sex, specifically), if it is in the context of a romantic relationshuip, is protective with respect to dellinquency [@harden2007;@harden2011a].

# Predicting sexual behavior

The number of partners and frequency of sex is expected to be different between those who are in or not in long-term relationships.

```{r}
ggplot2::theme_set(ggplot2::theme_minimal())


table(splt_fsmi_devdemog$ordered_sex_freq, splt_fsmi_devdemog$sample, useNA = 'ifany')
table(splt_fsmi_devdemog$ordered_num_partner, splt_fsmi_devdemog$sample, useNA = 'ifany')
```

```{r sesfsmiplot, fig.width=8, fig.height=4}
sex_freq_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_sex_freq) & 
                                  !is.na(splt_fsmi_devdemog$partnered) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_sex_freq,
                 fill = as.factor(partnered))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), alpha = 1) +
    ggplot2::theme(legend.position = 'none') + 
    ggplot2::labs(title = 'College students', y = 'Count', x = '') +
    ggplot2::coord_cartesian(ylim = c(0,60))

num_partnr_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_num_partner) & 
                                  !is.na(splt_fsmi_devdemog$partnered) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_num_partner,
                 fill = factor(partnered, levels = c(0,1), labels = c('No', 'Yes')))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), alpha = 1) + 
    ggplot2::labs(title = '', y = '', x = '') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank()) +
    ggplot2::coord_cartesian(ylim = c(0,60))

sex_freq_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_sex_freq) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_sex_freq)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) +
    ggplot2::labs(title = 'Adolescents', y = 'Count', x = 'Number of sexual encounters, last 6 months') +
    ggplot2::coord_cartesian(ylim = c(0,60), xlim = c(1,6))

num_partnr_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_num_partner) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_num_partner)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) + 
    ggplot2::labs(title = '', y = '', x = 'Number of partners, last 6 months') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank(), 
                   plot.margin = ggplot2::margin(0,2.25,0,0, unit = 'cm'),
                   legend.position = 'right') +
    ggplot2::coord_cartesian(ylim = c(0,60), xlim = c(1,5))

gridExtra::grid.arrange(sex_freq_plot, num_partnr_plot, sex_freq_plot_tds, num_partnr_plot_tds, nrow = 2)
save_out_list <- c(save_out_list, 'sex_freq_plot', 'num_partnr_plot')
```

## Number of partners

### FSMI mate seeking

```{r fig.width=4, fig.height=4}
fsmi_num_partners_model <- paste(fsmi_cfa_matestat_model, 
                                 'ordered_num_partner ~ fsmi_mate + gender_c', sep = '\n')

fsmi_num_partners_sem <- lavaan::lavaan(
    model = fsmi_num_partners_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

fsmi_num_partners_sem_pred <- lavaan::lavPredict(fsmi_num_partners_sem)
fsmi_num_partners_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_num_partners_sem_partners <- fsmi_num_partners_sem_partners_[fsmi_num_partners_sem@Data@case.idx[[1]]]

fsmi_num_partners_all_sem <- lavaan::lavaan(
    model = fsmi_num_partners_model, 
    data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

fsmi_num_partners_all_sem_pred <- lavaan::lavPredict(fsmi_num_partners_all_sem)
fsmi_num_partners_all_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_num_partners_all_sem_partners <- fsmi_num_partners_all_sem_partners_[fsmi_num_partners_all_sem@Data@case.idx[[1]]]

plot_lav_factor_pred(lavfit = fsmi_num_partners_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_num_partner',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_num_partners_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_num_partners_sem)))

plot_lav_factor_pred(lavfit = fsmi_num_partners_all_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_num_partner',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_num_partners_all_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_num_partners_all_sem)))
```

### K-SRQ sexual relationship

```{r fig.width=4, fig.height=4}
ksrq_num_partners_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + gender_c', sep = '\n')
ksrq_num_partners_all_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + gender_c + age_c', sep = '\n')

ksrq_num_partners_sem <- lavaan::lavaan(
    model = ksrq_num_partners_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, std.ov = F,
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

ksrq_num_partners_all_sem <- lavaan::lavaan(
    model = ksrq_num_partners_all_model, 
    data = splt_fsmi_devdemog,
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, std.ov = F,
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

ksrq_num_partners_sem_pred <- lavaan::lavPredict(ksrq_num_partners_sem)
ksrq_num_partners_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_num_partners_sem_partners <- ksrq_num_partners_sem_partners_[ksrq_num_partners_sem@Data@case.idx[[1]]]

ksrq_num_partners_all_sem_pred <- lavaan::lavPredict(ksrq_num_partners_all_sem)
ksrq_num_partners_all_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner
ksrq_num_partners_all_sem_partners <- ksrq_num_partners_all_sem_partners_[ksrq_num_partners_all_sem@Data@case.idx[[1]]]

ggplot2::qplot(ksrq_num_partners_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_num_partners_sem_partners,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of partners',
               geom = 'jitter')

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_num_partners_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_num_partners_sem)))

ggplot2::qplot(ksrq_num_partners_all_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_num_partners_all_sem_partners,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of partners',
               geom = 'jitter')

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_num_partners_all_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_num_partners_all_sem)))
```

## Number of sexual encounters

### FSMI mate seeking

```{r fig.width=6, fig.height=4}
fsmi_sex_feq_null_model <- paste(fsmi_cfa_matestat_model, 
                            'ordered_sex_freq ~ 0*fsmi_mate + gender_c', sep = '\n')
fsmi_sex_feq_model <- paste(fsmi_cfa_matestat_model, 
                            'ordered_sex_freq ~ fsmi_mate + gender_c', sep = '\n')

fsmi_sex_feq_sem_null <- lavaan::lavaan(model = fsmi_sex_feq_null_model, 
                                   data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
                                   missing = 'listwise', estimator = 'WLSMV',
                                   int.ov.free = TRUE, int.lv.free = FALSE, 
                                   auto.fix.first = T, std.lv = F, 
                                   auto.fix.single = TRUE, auto.var = TRUE, 
                                   auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                   auto.delta = TRUE, auto.cov.y = TRUE,
                                   group = 'partnered')

fsmi_sex_feq_sem <- lavaan::lavaan(model = fsmi_sex_feq_model, 
                                   data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
                                   missing = 'listwise', estimator = 'WLSMV',
                                   int.ov.free = TRUE, int.lv.free = FALSE, 
                                   auto.fix.first = T, std.lv = F, 
                                   auto.fix.single = TRUE, auto.var = TRUE, 
                                   auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                   auto.delta = TRUE, auto.cov.y = TRUE,
                                   group = 'partnered')
lavaan::lavTestLRT(fsmi_sex_feq_sem_null, fsmi_sex_feq_sem)

plot_lav_factor_pred(lavfit = fsmi_sex_feq_sem,
                     factor_name = 'fsmi_mate', 
                     orig_data =  splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_sex_freq',
                     geom = 'jitter') + 
    ggplot2::labs(color = 'Partnered', 
                  x = 'FSMI mate seeking factor',
                  y = 'Number of sexual encounters, past 6 mo.')

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_sex_feq_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI mate-seeking predicting number of sexual encounters among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_sex_feq_sem)))
```

### K-SRQ sexual relationship

```{r fig.width=6, fig.height=4}
ksrq_sex_freq_model <- paste('k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20', 
                             'ordered_sex_freq ~ k_srq_sexual_relationships + gender_c', sep = '\n')
ksrq_sex_freq_null_model <- paste('k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20', 
                             'ordered_sex_freq ~ 0*k_srq_sexual_relationships + gender_c', sep = '\n')

ksrq_sex_freq_sem <- lavaan::lavaan(model = ksrq_sex_freq_model, 
                                    data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
                                    missing = 'listwise', estimator = 'WLSMV',
                                    int.ov.free = TRUE, int.lv.free = FALSE, 
                                    auto.fix.first = T, std.lv = F, std.ov = F,
                                    auto.fix.single = TRUE, auto.var = TRUE, 
                                    auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                    auto.delta = TRUE, auto.cov.y = TRUE,
                                    group = 'partnered')
ksrq_sex_freq_null_sem <- lavaan::lavaan(model = ksrq_sex_freq_null_model, 
                                    data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
                                    missing = 'listwise', estimator = 'WLSMV',
                                    int.ov.free = TRUE, int.lv.free = FALSE, 
                                    auto.fix.first = T, std.lv = F, std.ov = F,
                                    auto.fix.single = TRUE, auto.var = TRUE, 
                                    auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                    auto.delta = TRUE, auto.cov.y = TRUE,
                                    group = 'partnered')
lavaan::lavTestLRT(ksrq_sex_freq_null_sem, ksrq_sex_freq_sem)

plot_lav_factor_pred(lavfit = ksrq_sex_freq_sem,
                     factor_name = 'k_srq_sexual_relationships', 
                     orig_data =  splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_sex_freq',
                     geom = 'jitter') + 
    ggplot2::labs(color = 'Partnered', 
                  x = 'K-SRQ sexual relationships factor',
                  y = 'Number of sexual encounters, past 6 mo.')

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_sex_freq_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ sexual relationships predicting number of sexual encounters among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_sex_feq_sem)))
```

```{r fig.width=6, fig.height=4}
ksrq_sex_freq_all_model <- paste('k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20', 
                             'ordered_sex_freq ~ k_srq_sexual_relationships + gender_c + age_c', sep = '\n')
ksrq_sex_freq_all_null_model <- paste('k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20', 
                             'ordered_sex_freq ~ 0*k_srq_sexual_relationships + gender_c + age_c', sep = '\n')

ksrq_sex_freq_all_sem <- lavaan::lavaan(model = ksrq_sex_freq_all_model, 
                                    data = splt_fsmi_devdemog,
                                    missing = 'listwise', estimator = 'WLSMV',
                                    int.ov.free = TRUE, int.lv.free = FALSE, 
                                    auto.fix.first = T, std.lv = F, std.ov = F,
                                    auto.fix.single = TRUE, auto.var = TRUE, 
                                    auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                    auto.delta = TRUE, auto.cov.y = TRUE)
ksrq_sex_freq_all_null_sem <- lavaan::lavaan(model = ksrq_sex_freq_all_null_model, 
                                    data = splt_fsmi_devdemog,
                                    missing = 'listwise', estimator = 'WLSMV',
                                    int.ov.free = TRUE, int.lv.free = FALSE, 
                                    auto.fix.first = T, std.lv = F, std.ov = F,
                                    auto.fix.single = TRUE, auto.var = TRUE, 
                                    auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                    auto.delta = TRUE, auto.cov.y = TRUE)
lavaan::lavTestLRT(ksrq_sex_freq_all_null_sem, ksrq_sex_freq_all_sem)

plot_lav_factor_pred(lavfit = ksrq_sex_freq_all_sem,
                     factor_name = 'k_srq_sexual_relationships', 
                     orig_data =  splt_fsmi_devdemog, 
                     dv_name = 'ordered_sex_freq',
                     geom = 'jitter') + 
    ggplot2::labs(color = 'Partnered', 
                  x = 'K-SRQ sexual relationships factor',
                  y = 'Number of sexual encounters, past 6 mo.')

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_sex_freq_all_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ sexual relationships predicting number of sexual encounters among all participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_sex_freq_all_sem)))
```

## Using both K-SRQ sexual relationship and FSMI mate-seeking scales

```{r}
fsmi_ksrq_num_partners_model <- paste(
    ksrq_model,
    fsmi_cfa_matestat_model, 
    'ordered_num_partner ~ fsmi_mate + k_srq_sexual_relationships + gender_c',
    sep = '\n')

fsmi_ksrq_num_partners_sem <- lavaan::lavaan(
    model = fsmi_ksrq_num_partners_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_ksrq_num_partners_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ sexual relationships and FSMI mate-seeking predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_ksrq_num_partners_sem)))

fsmi_ksrq_freq_model <- paste(
    ksrq_model, 
    fsmi_cfa_matestat_model,
    'ordered_sex_freq ~ fsmi_mate + k_srq_sexual_relationships + gender_c', sep = '\n')

fsmi_ksrq_sex_freq_sem <- lavaan::lavaan(
    model = fsmi_ksrq_freq_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'listwise', estimator = 'WLSMV',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, std.ov = F,
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'partnered')
knitr::kable(
    dplyr::filter(parameterestimates(fsmi_ksrq_sex_freq_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ sexual relationships and FSMI mate-seeking predicting number of sexual encounters unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_ksrq_num_partners_sem)))
```

## other stuff


### Using protection

#### K-SRQ

Not enough adolescents who have had sex and reported frequency of use of protection to look at this group separately (N = `r sum(!is.na(splt_fsmi_devdemog$continuous_use_protection[grepl('TDS', splt_fsmi_devdemog$sample)]))`). However, we can look at all people who have complted the K-SRQ and who report on their use of protection (N collge students = `r sum(!is.na(splt_fsmi_devdemog$continuous_use_protection[grepl('yads', splt_fsmi_devdemog$sample)]))`). Becuase we don't have information on whether adolescents are in long-term relationships, this collapses across those who do and don't have long-term partners. All participants with data on the K-SRQ are used in the measurement portion of the model.

```{r}
splt_fsmi_devdemog$continuous_use_protection <- as.numeric(splt_fsmi_devdemog$ordered_use_protection)

ksrq_protection_model <- paste(
    'k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20',
    'continuous_use_protection ~ k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

ksrq_protection_null_model <- paste(
     'k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20',
     'continuous_use_protection ~ 0*k_srq_sexual_relationships + gender_c + age_c',
     sep = '\n')

ksrq_protection_adol_sem <- lavaan::lavaan(
    model = ksrq_protection_model, 
    data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

ksrq_protection_adol_null_sem <- lavaan::lavaan(
    model = ksrq_protection_null_model, 
    data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

lavaan::lavTestLRT(ksrq_protection_adol_null_sem,ksrq_protection_adol_sem)

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_protection_adol_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ sexual relationships predicting use of protection among adolescents; N obs. = ',
                     lavaan::nobs(ksrq_protection_adol_sem)))
```

#### FSMI and K-SRQ (college)

```{r}
splt_fsmi_devdemog$continuous_use_protection <- as.numeric(splt_fsmi_devdemog$ordered_use_protection)

fsmi_ksrq_protection_model <- paste(
    'k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20',
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60', 
    'continuous_use_protection ~ fsmi_mate + k_srq_sexual_relationships + gender_c',
    sep = '\n')

fsmi_ksrq_protection_null_model <- paste(
     'k_srq_sexual_relationships =~ K_SRQ_9 + K_SRQ_13 + K_SRQ_20',
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60', 
    'continuous_use_protection ~ 0*fsmi_mate + 0*k_srq_sexual_relationships + gender_c',
    sep = '\n')

fsmi_ksrq_protection_sem <- lavaan::lavaan(
    model = fsmi_ksrq_protection_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

fsmi_ksrq_protection_null_sem <- lavaan::lavaan(
    model = fsmi_ksrq_protection_null_model, 
    data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)

lavaan::lavTestLRT(fsmi_ksrq_protection_null_sem,fsmi_ksrq_protection_sem)

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_ksrq_protection_sem, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ sexual relationships and FSMI mate-seeking predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_ksrq_protection_sem)))
```

FSMI mate-seeking and KSRQ sexual relationships modified factor show interesting relations to sexual behavior. FSMI mate-seeking relates positively to number of sexual partners (for people not in long-term relationships). KSRQ sexual relationships relates to number of sexual experiences for people not in long-term relationships. 

This helps establish some validity for these two scales. First, it seems likely that on the whole, participants are responding truthfully to the questionnaire. People who report being in a long term relationship overwhelmingly also report having one sexual partner, and having sex regularly. People not in a long term relationship report more partners, but less frequent sex (almost certainly due to opportunity).



# References

```{r echo = F, eval = F}
save.image(file = file.path(save_out_dir, 'fsmi-cfa.rda'))
```
