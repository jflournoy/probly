---
title: "Fundamental Social Motives Confirmatory Factor Analysis"
author: "John Flournoy"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: yes
    toc_depth: 3
    number_sections: FALSE
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "/home/jflournoy/Rlibs/probly/bib/dissertation.bib"
csl: "/home/jflournoy/Rlibs/probly/bib/apa-old-doi-prefix.csl"
---

Below, I begin to examine the fit of scales measuring behaviors, beliefs, attitudes, and strategies relevant to mate-seeking and status motives. After examining the item distributions to see if there are any very problematic subsets, I fit a confirmatory factor analysis to remaining scales. I also confirm that an exploratory factor analysis shows expected factor structure.

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = F, error = F,warning = F, echo = F, collapse = T,
  comment = "#>"
)
```

```{r setupoptions}
data_dir <- '/data/jflournoy/split/probly'
sample_labels <- c(
    'TDS1' = 'Foster-care involved adolescents',
    'TDS2' = 'Community adolescents',
    'yads' = 'College students',
    'yads_online' = 'College students - online'
)

sample_labels_short <- c(
    'TDS1' = 'FCA',
    'TDS2' = 'CA',
    'yads' = 'CSYA',
    'yads_online' = 'CSYA-O'
)

print_lrt_test_stats <- function(anlrt, result_row = 2, p_sigdig = 3){
    N <- eval(parse(text = paste0('lavaan::nobs(',dimnames(anlrt)[[1]][1], ')')))
    sprintf(paste0('N = %d, \\Delta\\chi^2[%0.2f] = %0.1f, p = %0.', p_sigdig, 'f'),
            N, anlrt[result_row,'Df diff'], 
            anlrt[result_row,'Chisq diff'], 
            anlrt[result_row,'Pr(>Chisq)'])
}

get_chisq_tests <- function(an_sem, verbose = T, lrt_idxs = c(5,6)){
    if(verbose){
        print(an_sem[[lrt_idxs[1]]])
        print(an_sem[[lrt_idxs[2]]])
    }
    chisq <- an_sem[[lrt_idxs[1]]][2,'Chisq diff']
    df <- an_sem[[lrt_idxs[1]]][2,'Df diff']
    p <- an_sem[[lrt_idxs[1]]][2,'Pr(>Chisq)']
    chisq_all <- an_sem[[lrt_idxs[2]]][2,'Chisq diff']
    df_all <- an_sem[[lrt_idxs[2]]][2,'Df diff']
    p_all <- an_sem[[lrt_idxs[2]]][2,'Pr(>Chisq)']
    return(c(chisq = chisq,
             df = df,
             p = p, 
             chisq_all = chisq_all,
             df_all = df_all,
             p_all = p_all))
}

college_rubric_dir <- system.file('scoring_rubrics', 'college', package = 'probly')
adolescent_rubric_dir <- system.file('scoring_rubrics', 'adolescent', package = 'probly')

relationship_status <- c('long_term' = 1, 'actively_dating' = 2, 'single_nodate' = 3, 'single_neverdate' = 4)

##FORDEVLOPMENT:
college_rubric_dir <- '~/code_new/probly/inst/scoring_rubrics/college/'
adolescent_rubric_dir <- '~/code_new/probly/inst/scoring_rubrics/adolescent/'
###
make_factor_item_labels <- function(scale_key, factor_name_prefix = T, remove_string_from_factor = NULL){
    items <- milav::get_items_from_keys(scale_key)
    itemnames <- unlist(items)
    
    itemlabels <- unlist(
        lapply(seq_along(items), 
               function(i) {
                   if(!is.null(remove_string_from_factor)){
                       factor_name <- gsub(remove_string_from_factor, '', names(scale_key)[i])
                   } else {
                       factor_name <- names(scale_key)[i]
                   }
                   paste0(
                       factor_name, 
                       '_',
                       gsub('.*?(\\d+)', '\\1', items[[i]]))
               }))
    return(list(names = itemnames, labels = itemlabels))
}

plot_item_histograms <- function(item_data, scale_key, factor_name_prefix = T, remove_string_from_factor = NULL){
    name_labels <- make_factor_item_labels(
        scale_key, 
        factor_name_prefix = factor_name_prefix, 
        remove_string_from_factor = remove_string_from_factor)
    
    scale_item_data <- dplyr::select_at(
        item_data, 
        dplyr::vars(name_labels$names))
    
    p <- ggplot2::ggplot(
        dplyr::mutate(
            tidyr::gather(scale_item_data, item, value),
            item = factor(item, levels = name_labels$names, labels = name_labels$labels)),
        ggplot2::aes(x = value)) + 
        ggplot2::geom_histogram(ggplot2::aes(y=..density..), binwidth = 1, color = '#666666', fill = NA) + 
        ggplot2::geom_density(ggplot2::aes(y=..density..), adjust = 2) + 
        ggplot2::facet_wrap(~item) + 
        ggplot2::theme_minimal()
    return(p)
}

plot_lav_factor_pred <- function(lavfit, factor_name, orig_data, dv_name, ...){
    ngrps <- lavaan::inspect(lavfit, 'ngroups')
    if(ngrps > 1){
        grp_labs <- lavaan::inspect(lavfit, 'group.label')
        nobs <- lavaan::inspect(lavfit, 'nobs')
        gidx <- unlist(lapply(seq_along(grp_labs), function(i){
            rep(grp_labs[i], nobs[i])}))
    }
    dv_dat_ <- orig_data[,dv_name][[1]]
    dv_dat <- dv_dat_[unlist(lavaan::inspect(lavfit, what = 'case.idx'))]
    if(ngrps > 1){
        fact_pred <- unlist(lapply(lavaan::lavPredict(lavfit, type = 'lv'), function(d){
            d[,factor_name]
        }))   
    } else {
        fact_pred <- lavaan::lavPredict(lavfit, type = 'lv')[,factor_name]
    }
    if(ngrps > 1){
        return(ggplot2::qplot(fact_pred, dv_dat, color = gidx, ...))
    }
    return(ggplot2::qplot(fact_pred, dv_dat, ...))
}

create_bifactor <- function(scale_key, scales_to_use, factor_name){
    #returns factor and sets correlations to 0
    method_fac <- paste0('\n',
                         milav::make_factor_string(
                             milav::get_items_from_keys(
                                 scale_key[scales_to_use]),
                             factor_name = factor_name),
                         '\n', factor_name, ' ~~ ', 
                         paste(
                             paste0(
                                 '0*', 
                                 scales_to_use),
                             collapse = ' + '))
    return(method_fac)
}

fasterMoreFitIndices <- function(lavobj){
    chisq <- fitMeasures(lavobj, "chisq")
    df <- fitMeasures(lavobj, "df")
    chisq.scaled <- fitMeasures(lavobj, "chisq.scaled")
    df.scaled <- fitMeasures(lavobj, "df.scaled")
    p <- length(lavaan::lavNames(lavobj, type = "ov", group = 1))
    nParam <- fitMeasures(lavobj, "npar")
    n <- lavaan::lavInspect(lavobj, "ntotal")
    ngroup <- lavaan::lavInspect(lavobj, "ngroups")
    f <- -2 * fitMeasures(lavobj, "logl")
    result <- list()
    gammaHatValue <- p/(p + 2 * ((chisq - df)/(n - 1)))
    adjGammaHatValue <- 1 - (((ngroup * p * (p + 1))/2)/df) * 
        (1 - gammaHatValue)
    result["gammaHat"] <- gammaHatValue
    result["adjGammaHat"] <- adjGammaHatValue
    if (lavaan::lavInspect(lavobj, "options")$test %in% 
        c("satorra.bentler", "yuan.bentler")) {
        gammaHatScaledValue <- p/(p + 2 * ((chisq.scaled - 
                                                df.scaled)/(n - 1)))
        adjGammaHatScaledValue <- 1 - (((ngroup * p * (p + 
                                                           1))/2)/df.scaled) * (1 - gammaHatScaledValue)
        result["gammaHat.scaled"] <- gammaHatScaledValue
        result["adjGammaHat.scaled"] <- adjGammaHatScaledValue
    }
    return(result)
}

save_out_list <- c()
save_out_dir <- '~/code_new/social-motives-rl-writeup/rda/'
if(!dir.exists(save_out_dir)){
    dir.create(save_out_dir)
}
```

```{r packages}
library(probly)
library(scorequaltrics)
library(milav)
library(dplyr)
library(tidyr)
library(lavaan)
library(semPlot)
library(psych)
```

```{r getdata}
revcode <- function(nums, min, max){
    return(max - nums + min)
}

data("splt_fsmi")
data("splt_dev_and_demog")
#reverse code UPPSP because "1" is "Agree strongly" and "4" is "Disagree strongly"
splt_fsmi <- splt_fsmi %>%
    mutate_at(vars(matches('UPPSP_\\d+')), 
              funs(revcode, .args = list(min = 1, max = 4)))

splt_fsmi <- splt_fsmi[splt_fsmi$SID != 360,]
splt_fsmi$partnered <- as.numeric(splt_fsmi$fsmi_relstatus == relationship_status['long_term'])

splt_dev_and_demog <- splt_dev_and_demog[splt_dev_and_demog$SID != 360,]
splt_dev_and_demog$ethnicity[splt_dev_and_demog$SID == 203] <- 'Other'

splt_fsmi_devdemog <- dplyr::left_join(splt_fsmi, distinct(splt_dev_and_demog), by = 'SID')

splt_fsmi_devdemog <- dplyr::mutate_at(splt_fsmi_devdemog,
                                       vars(contains('SES')), funs(ifelse(. == -99, NA, .)))

last_30_response_labels <- list(
    levels = c(0,1,2,3,4),
    labels = c('0', '1-2', '3-5', '6-9', '10 or more'))
last_30_5drinks_response_labels <- list(
    levels = c(0,1,2,3),
    labels = c('0', '1-2', '3-5', '6 or more'))

#This may not be accurate for some people who report, earlier in the questionnaires, that they have had sex in
# the last six months. That question is more clear that sex can mean a lot of things. This says "sexual intercourse"
splt_fsmi_devdemog$sex_ever <- factor(splt_fsmi_devdemog$YRBS_31, levels = c(0,1), labels = c('No', 'Yes'))

splt_fsmi_devdemog$alcohol_ever <- factor(splt_fsmi_devdemog$YRBS_12, levels = c(0,1), labels = c('No', 'Yes'))
splt_fsmi_devdemog$alcohol_days_of_lst30 <- ordered(
    ifelse(splt_fsmi_devdemog$YRBS_14 < 4,
           splt_fsmi_devdemog$YRBS_14,
           4),
    levels = last_30_response_labels$levels,
    labels = last_30_response_labels$labels)

table(splt_fsmi_devdemog$alcohol_days_of_lst30)

splt_fsmi_devdemog$alcohol_5drnks_lst30 <- ordered(
    ifelse(splt_fsmi_devdemog$YRBS_15 < 3,
           splt_fsmi_devdemog$YRBS_15,
           3),
    levels = last_30_5drinks_response_labels$levels,
    labels = last_30_5drinks_response_labels$labels)
table(splt_fsmi_devdemog$alcohol_5drnks_lst30)

splt_fsmi_devdemog$substance_pre_sex <- factor(splt_fsmi_devdemog$YRBS_35, 
                                               levels = c(0,1), labels = c('No', 'Yes'))
table(splt_fsmi_devdemog$substance_pre_sex)

splt_fsmi_devdemog$sex_six_months <- splt_fsmi_devdemog$SES_11 == 5

splt_fsmi_devdemog$ordered_use_protection <- ordered(ifelse( #if
    !splt_fsmi_devdemog$sex_six_months & #haven't had sex in the last six months
        splt_fsmi_devdemog$SES_13 < 1, #report fewer than 1 sexual partner
    NA, #assign NA to use protection (we want to know whether they _do_, not _would_
    splt_fsmi_devdemog$SES_15), #otherwise, keep their original answer
    levels = 1:7,
    labels = c('Never 0%', 'Rarely 1-15%', 'Occasionally 15-40%', 'About half the time 40-60%', 
               'Usually 60-85%', 'Most of the time 85-99%', 'Every single time 100%'))
    
splt_fsmi_devdemog$ordered_sex_freq <- ordered(
    ifelse(splt_fsmi_devdemog$SES_12 == 0 |
               (is.na(splt_fsmi_devdemog$SES_12) & !splt_fsmi_devdemog$sex_six_months), 
           0, 
           ifelse(splt_fsmi_devdemog$SES_12 <40,
                  ifelse(splt_fsmi_devdemog$SES_12 <20,
                         splt_fsmi_devdemog$SES_12 %/% 10 + 1,
                         3),
                  4)),
    labels = c('0', '1-9', '10-19', '20-39', '40 or more'))
table((splt_fsmi_devdemog$ordered_sex_freq))

splt_fsmi_devdemog$ordered_num_partner <- ordered(
    ifelse(splt_fsmi_devdemog$SES_13 == 0 | 
               (is.na(splt_fsmi_devdemog$SES_13) & !splt_fsmi_devdemog$sex_six_months), 
           0,
           ifelse(splt_fsmi_devdemog$SES_13 < 3, 
                  splt_fsmi_devdemog$SES_13, 
                  3)),
    levels = 0:3,
    labels = c(0:2, '3 or more'))
table((splt_fsmi_devdemog$ordered_num_partner))

splt_fsmi_devdemog$gender_c <- splt_fsmi_devdemog$gender - .5
splt_fsmi_devdemog$age_c <- splt_fsmi_devdemog$age - 18


fsmi_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'fsmi_scoring_rubric.csv')),
    type = 'scoring')
dnp_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'DominanceAndPrestige_scoring_rubric.csv')),
    type = 'scoring')
ksqr_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'K-SRQ_scoring_rubric.csv')),
    type = 'scoring')
saq_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(college_rubric_dir, 'SAQ_scoring_rubric.csv')),
    type = 'scoring')
upps_rubric <- scorequaltrics::get_rubrics(
    rubric_filenames = data_frame(
        file = file.path(adolescent_rubric_dir, 'UPPSP_scoring_rubric.csv')),
    type = 'scoring')

```


# Checking Items

```{r datacheck}
fsmi_key <- scorequaltrics::create_key_from_rubric(fsmi_rubric)
fsmi_key <- fsmi_key[names(fsmi_key) != 'fsmi_kin']
dnp_key <- scorequaltrics::create_key_from_rubric(dnp_rubric)
ksqr_key <- scorequaltrics::create_key_from_rubric(ksqr_rubric)
saq_key <- scorequaltrics::create_key_from_rubric(saq_rubric)
upps_key <- scorequaltrics::create_key_from_rubric(upps_rubric)

fsmi_cfa_model <- milav::create_cfa_from_keylist(fsmi_key)
dnp_cfa_model <- milav::create_cfa_from_keylist(dnp_key)
ksqr_cfa_model <- milav::create_cfa_from_keylist(ksqr_key)
saq_cfa_model <- milav::create_cfa_from_keylist(saq_key)
upps_cfa_model <- milav::create_cfa_from_keylist(upps_key)
```

## FSMI

```{r fig.width=8, fig.height=10}
plot_item_histograms(splt_fsmi, fsmi_key, remove_string_from_factor = 'fsmi_')
```

The CFA will not include kin care (missing data), family care (highly skewed), and mate retention general (highly skewed).

## Dominance and Prestige

```{r fig.width=6, fig.height=5}
plot_item_histograms(splt_fsmi, dnp_key, remove_string_from_factor = '_score')
```

## Kids social reward questionnaire

```{r fig.width=10, fig.height=7}
plot_item_histograms(splt_fsmi, ksqr_key, remove_string_from_factor = 'k_srq_')
```

The CFA will not include negative social potency (highly skewed), or prosocial iteractions (highly skewed). Target scales to use for status and mate seeking motives are the admiration scale, passivity scale, sexual relationshups scale, and sociability scale.

## Urgency, Premeditation, Perseverance, and Sensation Seeking

```{r fig.width=8, fig.height=12}
plot_item_histograms(splt_fsmi, upps_key) + 
    ggplot2::theme(strip.text = ggplot2::element_text(size = 6))
```

# Confirmatory factor analyses and exploration

## FSMI

```{r fsmifullcfa}
scales_to_use <- names(fsmi_key)[!names(fsmi_key) %in% c('fsmi_kin', 'fsmi_fam', 'fsmi_retgen')]
fsmi_cfa_model <- milav::create_cfa_from_keylist(
    fsmi_key[scales_to_use])

fsmi_cfa_model_method <- paste0(
    fsmi_cfa_model,
    create_bifactor(fsmi_key, scales_to_use, factor_name = 'fsmi_bifac'))

fsmi_full_cfa_saveFN <- file.path(data_dir, 'fsmi_full_cfa_save.rda')
if(!file.exists(fsmi_full_cfa_saveFN)){
    fsmi_cfa <- lavaan::lavaan(model = fsmi_cfa_model, data = splt_fsmi,
                               missing = 'fiml', estimator = 'MLR',
                               int.ov.free = TRUE, int.lv.free = FALSE, 
                               auto.fix.first = FALSE, std.lv = TRUE, 
                               auto.fix.single = TRUE, auto.var = TRUE, 
                               auto.cov.lv.x = TRUE, auto.th = TRUE, 
                               auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_cfa_method <- lavaan::lavaan(model = fsmi_cfa_model_method, data = splt_fsmi,
                                      missing = 'fiml', estimator = 'MLR',
                                      int.ov.free = TRUE, int.lv.free = FALSE, 
                                      auto.fix.first = FALSE, std.lv = TRUE, 
                                      auto.fix.single = TRUE, auto.var = TRUE, 
                                      auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                      auto.delta = TRUE, auto.cov.y = TRUE)
    fsmi_cfa_model_comparison1 <- cbind(
        lavaan::anova(fsmi_cfa, fsmi_cfa_method),
        do.call(
            rbind,
            lapply(c(fsmi_cfa_method, fsmi_cfa), 
                   lavaan::fitmeasures,
                   fit.measures = c('cfi', 'rmsea', 'mfi'))))
    
    save(fsmi_cfa,
         fsmi_cfa_method, 
         fsmi_cfa_model_comparison1,
         file = fsmi_full_cfa_saveFN)
} else {
    load(fsmi_full_cfa_saveFN)
}

knitr::kable(
    fsmi_cfa_model_comparison1,
    digits = 3)

summary(fsmi_cfa, stan = T)
summary(fsmi_cfa_method, stan = T)

fsmi_cfa_lrt <- lavTestLRT(fsmi_cfa, fsmi_cfa_method)
fsmi_cfa_fits <- list(
    lapply(list('baseline'=fsmi_cfa, 'bifac'=fsmi_cfa_method),
           lavaan::fitmeasures,
           fit.measures = c('RMSEA', 'mfi')),
    lapply(list('baseline'=fsmi_cfa, 'bifac'=fsmi_cfa_method),
           fasterMoreFitIndices))
```

A model for the FSMI scale without a method bifactor fits substantially worse than that with the method factor.

```{r}
options(knitr.kable.NA = '')
knitr::kable(fsmi_cfa_lrt)
knitr::kable(cbind(t(as.data.frame(fsmi_cfa_fits[[1]])),
          rbind(baseline=as.data.frame(fsmi_cfa_fits[[2]]$baseline),
                bifac=as.data.frame(fsmi_cfa_fits[[2]]$bifac))))
```

```{r eval = F}
psych::fa.parallel(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], plot = F)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], 
                nfactors = 8, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25, short = T)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(fsmi_key[scales_to_use]))], 
                nfactors = 9, n.iter = 1, rotate = 'bifactor',
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = F, cut = .25)
```

Exploratory factor analysis (not shown, but code for which is above) results in 8 factors, with high loadings grouped as expected and minimal cross loadings > .25. The bifactor rotation (with 9 factors) also shows this pattern.

(ref:fsmicfaplot1) FSMI CFA with method bifactor. Path weight reflects standardized loading strength, with minimum cuttoff for showing path set at .20, and maximum weight at .90 (apparent for several mate-seeking items). Residual and means not shown.

```{r fsmicfaplot1, fig.width=8, fig.height=5, fig.cap = '(ref:fsmicfaplot1)'}
semPlot::semPaths(fsmi_cfa_method, 
                  bifactor = 'fsmi_bifac', 
                  layout = 'tree3', 
                  rotation = 3, 
                  intercepts = F, residuals = F, 
                  what = 'std', whatLabels = 'none', 
                  nCharNodes = 12, sizeMan = 1.5,
                  minimum = .20, maximum = .9, curvature = 3.5)
```

(ref:fsmicfaplot2) FSMI CFA. Path weight reflects standardized loading strength, with minimum cuttoff for showing path set at .20, and maximum weight at .90 (apparent for several mate-seeking items). Residual and means not shown.

```{r fsmicfaplot2, fig.width=8, fig.height=2.5, fig.cap = '(ref:fsmicfaplot2)'}
semPlot::semPaths(fsmi_cfa, 
                  bifactor = '', 
                  layout = 'tree3', 
                  rotation = 3, 
                  intercepts = F, residuals = F, 
                  what = 'std', whatLabels = 'none', 
                  nCharNodes = 12, sizeMan = 1.5, sizeLat = 9,
                  minimum = .20, maximum = .9, curvature = 1)
```

The two factor structures are shown above.

### FSMI Discussion

The factor model, fit to all but three of the original scale's factors (child-care, care for family, general mate retention; N = 225) shows somewhat reasonable, but not great, fit (RMSEA = `r round(fsmi_cfa_fits[[1]]$baseline[['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_cfa_fits[[2]]$baseline[['gammaHat']],3)`). 
This deviates from the results reported by Neel and colleagues [-@neel2015], where each factor, or set of related factors, was tested independently.
A parallel scree plot analysis (psych package version `r packageVersion('psych')`) suggested 8 factors, with all item loadings dominant on expected factors. 
There is some evidence that including a factor that accounts for an overall method factor improve model fit.
Adding such a method bifactor improved the fit somewhat (RMSEA = `r round(fsmi_cfa_fits[[1]]$bifac[['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_cfa_fits[[2]]$bifac[['gammaHat']],3)`).
Model comparison substantially favors the less parsimonious model that includes the method bifactor (`r paste(paste(c('$\\Delta$AIC = ','$\\Delta$BIC = ', '$\\Delta$Df = '), round(apply((fsmi_cfa_lrt[,c('AIC','BIC', 'Df')]),2,diff),0)), collapse = ', ')`).
Although this bifactor does improve fit across all factors, it does not load strongly on either status or mate-seeking, so I do not account for in in analyses below.

```{r mateseekingstatus}
scales_to_use_mate_stat <- c('fsmi_mate', 'fsmi_stat')
fsmi_cfa_matestat_model <- milav::create_cfa_from_keylist(
    fsmi_key[scales_to_use_mate_stat])

splt_fsmi_devdemog_yads <- splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),]

fsmi_cfa_matestat_gender <- lavaan::lavaan(model = fsmi_cfa_matestat_model, 
                                           data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender')

fsmi_cfa_matestat_gender_metric <- lavaan::lavaan(model = fsmi_cfa_matestat_model, 
                                                  data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', group.equal = 'loadings')
fsmi_cfa_matestat_gender_metric_cor <- lavaan::lavaan(model = fsmi_cfa_matestat_model, 
                                                  data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', 
                                  group.equal = c('loadings', 'lv.variances', 'lv.covariances'))

fsmi_matestat_cfa_fit <- list(
    fsmi_cfa_matestat_gender = 
        c(unlist(lavaan::fitmeasures(fsmi_cfa_matestat_gender,
                                     fit.measures = c('rmsea', 'mfi'))),
          unlist(fasterMoreFitIndices(fsmi_cfa_matestat_gender)),
          AIC=AIC(fsmi_cfa_matestat_gender)),
    fsmi_cfa_matestat_gender_metric =
        c(unlist(lavaan::fitmeasures(fsmi_cfa_matestat_gender_metric,
                                     fit.measures = c('rmsea', 'mfi'))),
          unlist(fasterMoreFitIndices(fsmi_cfa_matestat_gender_metric)),
          AIC=AIC(fsmi_cfa_matestat_gender_metric)),
    fsmi_cfa_matestat_gender_metric_cor =
        c(unlist(lavaan::fitmeasures(fsmi_cfa_matestat_gender_metric_cor,
                                     fit.measures = c('rmsea', 'mfi'))),
          unlist(fasterMoreFitIndices(fsmi_cfa_matestat_gender_metric_cor)),
          AIC=AIC(fsmi_cfa_matestat_gender_metric_cor)))

fsmi_matestat_cfa_fit$delta1 <- fsmi_matestat_cfa_fit$fsmi_cfa_matestat_gender_metric -
    fsmi_matestat_cfa_fit$fsmi_cfa_matestat_gender
fsmi_matestat_cfa_fit$delta2 <- fsmi_matestat_cfa_fit$fsmi_cfa_matestat_gender_metric_cor - 
    fsmi_matestat_cfa_fit$fsmi_cfa_matestat_gender_metric

lapply(fsmi_matestat_cfa_fit, round, 4)

fsmi_mate_stat_par <- parameterestimates(fsmi_cfa_matestat_gender_metric_cor, stan = T)
fsmi_mate_stat_cor <- fsmi_mate_stat_par[fsmi_mate_stat_par$lhs == 'fsmi_mate' &  fsmi_mate_stat_par$rhs == 'fsmi_stat',]
```

(ref:fsmicfamatestatplot) FSMI mate-seeking & status CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r fsmicfamatestatplot, fig.width=8, fig.height=2.5, fig.cap = '(ref:fsmicfamatestatplot)'}
semPlot::semPaths(fsmi_cfa_matestat_gender_metric_cor, 
                  layout = 'tree2', 
                  rotation = 1, 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 5, sizeLat = 9,
                  minimum = .0, maximum = .9, curvature = 3.5, ask = F)

save_out_list <- c(save_out_list, 'fsmi_cfa_matestat', 'fsmi_matestat_cfa_fit', 'fsmi_mate_stat_par', 'fsmi_mate_stat_cor')
```

A CFA for mate-seeking and status factors fit well (RMSEA = `r round(fsmi_matestat_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(fsmi_matestat_cfa_fit[[2]][['gammaHat']],3)`), with the two factors showing a small, positive, non-significant correlation ($r = `r round(fsmi_mate_stat_cor[['std.all']],2)`, Z = `r round(fsmi_mate_stat_cor[['z']],2)`$).
Note that item 54, "I do not worry very much about losing status" has a particularly low loading on the status factor (standardized loading = `r round(fsmi_mate_stat_par[fsmi_mate_stat_par$op == '=~' & fsmi_mate_stat_par$rhs == 'fsmi_qs_54','std.all'],2)`).

## Dominance and Prestige

### Measurement invariance

```{r dnp}

dnp_cfa_model <- milav::create_cfa_from_keylist(dnp_key)


dnp_cfa_gender <- lavaan::lavaan(model = dnp_cfa_model, data = splt_fsmi_devdemog_yads,
                           missing = 'fiml', estimator = 'ML',
                           int.ov.free = TRUE, int.lv.free = FALSE, 
                           auto.fix.first = TRUE, std.lv = FALSE, 
                           auto.fix.single = TRUE, auto.var = TRUE, 
                           auto.cov.lv.x = TRUE, auto.th = TRUE, 
                           auto.delta = TRUE, auto.cov.y = TRUE,
                           group = 'gender')
dnp_cfa_gender_metric <- lavaan::lavaan(model = dnp_cfa_model, data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', group.equal = 'loadings')
dnp_cfa_gender_partmetric <- lavaan::lavaan(model = dnp_cfa_model, 
                                            data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', group.equal = 'loadings',
                                  group.partial = c(
                                      'dominance_score =~ dominance_prestige_16'))
dnp_cfa_gender_partmetric_cor <- lavaan::lavaan(model = dnp_cfa_model, 
                                            data = splt_fsmi_devdemog_yads,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', 
                                  group.equal = c('loadings', 'lv.variances', 'lv.covariances'),
                                  group.partial = c(
                                      'dominance_score =~ dominance_prestige_16'))

dnp_cfa_fit <- list(
    dnp_cfa_gender = c(unlist(lavaan::fitmeasures(dnp_cfa_gender,
                                            fit.measures = c('rmsea', 'mfi'))),
                 unlist(fasterMoreFitIndices(dnp_cfa_gender)),
                 AIC=AIC(dnp_cfa_gender)),
    dnp_cfa_gender_metric = c(unlist(lavaan::fitmeasures(dnp_cfa_gender_metric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(dnp_cfa_gender_metric)),
                 AIC=AIC(dnp_cfa_gender_metric)),
    dnp_cfa_gender_partmetric = c(unlist(lavaan::fitmeasures(dnp_cfa_gender_partmetric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(dnp_cfa_gender_partmetric)),
                 AIC=AIC(dnp_cfa_gender_partmetric)),
    dnp_cfa_gender_partmetric_cor = c(unlist(lavaan::fitmeasures(dnp_cfa_gender_partmetric_cor,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(dnp_cfa_gender_partmetric_cor)),
                 AIC=AIC(dnp_cfa_gender_partmetric_cor)))

dnp_cfa_fit$delta1 <- dnp_cfa_fit$dnp_cfa_gender_metric - dnp_cfa_fit$dnp_cfa_gender
dnp_cfa_fit$delta2 <- dnp_cfa_fit$dnp_cfa_gender_partmetric - dnp_cfa_fit$dnp_cfa_gender
dnp_cfa_fit$delta3 <- dnp_cfa_fit$dnp_cfa_gender_partmetric_cor - 
    dnp_cfa_fit$dnp_cfa_gender_partmetric
lapply(dnp_cfa_fit, round, 4)
lavTestLRT(dnp_cfa_gender, dnp_cfa_gender_partmetric)
lavaan::inspect(dnp_cfa_gender_partmetric_cor, what = 'ntotal')
round(dnp_cfa_fit[['dnp_cfa_gender_partmetric_cor']][['rmsea']],3)
round(dnp_cfa_fit[['dnp_cfa_gender_partmetric_cor']][['mfi']],2)
round(dnp_cfa_fit[['dnp_cfa_gender_partmetric_cor']][['gammaHat']],3)

dnp_mate_stat_par <- parameterestimates(dnp_cfa_gender_partmetric_cor, stan = T)
dnp_mate_stat_cor <- dnp_mate_stat_par[dnp_mate_stat_par$lhs == 'dominance_score' & 
                                           dnp_mate_stat_par$rhs == 'prestige_score',]

inspect(dnp_cfa_gender_partmetric_cor, 'cor.lv')
```

## K-SRQ

### Measurement invariance

```{r ksrq}
scales_to_use_ksrq <- c('k_srq_admiration', 'k_srq_passivity', 
                        'k_srq_sexual_relationships',
                        'k_srq_sociability')
ksrq_model <- milav::create_cfa_from_keylist(
    ksqr_key[scales_to_use_ksrq])

## Sample
ksrq_cfa <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                           missing = 'fiml', estimator = 'ML',
                           int.ov.free = TRUE, int.lv.free = FALSE, 
                           auto.fix.first = TRUE, std.lv = FALSE, 
                           auto.fix.single = TRUE, auto.var = TRUE, 
                           auto.cov.lv.x = TRUE, auto.th = TRUE, 
                           auto.delta = TRUE, auto.cov.y = TRUE,
                           group = 'sample')

ksrq_cfa_cov <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                           missing = 'fiml', estimator = 'ML',
                           int.ov.free = TRUE, int.lv.free = FALSE, 
                           auto.fix.first = TRUE, std.lv = FALSE, 
                           auto.fix.single = TRUE, auto.var = TRUE, 
                           auto.cov.lv.x = TRUE, auto.th = TRUE, 
                           auto.delta = TRUE, auto.cov.y = TRUE,
                           group = 'sample', group.equal = c('loadings',
                                                             'lv.variances',
                                                             'lv.covariances'))

ksrq_cfa_metric_full <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'sample', group.equal = 'loadings')

ksrq_cfa_metric <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'sample', group.equal = 'loadings',
                                  group.partial = c('k_srq_sociability =~ K_SRQ_10',
                                                    'k_srq_admiration =~  K_SRQ_7',
                                                    'k_srq_sexual_relationships =~ K_SRQ_13',
                                                    'k_srq_sexual_relationships =~ K_SRQ_20'))

## Gender
ksrq_cfa_gender <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                           missing = 'fiml', estimator = 'ML',
                           int.ov.free = TRUE, int.lv.free = FALSE, 
                           auto.fix.first = TRUE, std.lv = FALSE, 
                           auto.fix.single = TRUE, auto.var = TRUE, 
                           auto.cov.lv.x = TRUE, auto.th = TRUE, 
                           auto.delta = TRUE, auto.cov.y = TRUE,
                           group = 'gender')

ksrq_cfa_gender_metric <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'gender', group.equal = 'loadings',
                                  group.partial = c('k_srq_sociability =~ K_SRQ_10',
                                                    'k_srq_admiration =~  K_SRQ_7',
                                                    'k_srq_sexual_relationships =~ K_SRQ_13',
                                                    'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_metric_cov <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
                                  missing = 'fiml', estimator = 'ML',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = TRUE, std.lv = FALSE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE,
                                  group = 'sample', group.equal = c('loadings',
                                                                    'lv.variances',
                                                                    'lv.covariances'),
                                  group.partial = c('k_srq_sociability =~ K_SRQ_10',
                                                    'k_srq_admiration =~  K_SRQ_7',
                                                    'k_srq_sexual_relationships =~ K_SRQ_13',
                                                    'k_srq_sexual_relationships =~ K_SRQ_20'))


ksrq_cfa_fit <- list(
    ksrq_cfa = c(unlist(lavaan::fitmeasures(ksrq_cfa,
                                            fit.measures = c('rmsea', 'mfi'))),
                 unlist(semTools::moreFitIndices(ksrq_cfa,
                                                 fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa)),
    ksrq_cfa_metric = c(unlist(lavaan::fitmeasures(ksrq_cfa_metric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(semTools::moreFitIndices(ksrq_cfa_metric,
                                                        fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa_metric)),
    ksrq_cfa_metric_full = c(unlist(lavaan::fitmeasures(ksrq_cfa_metric_full,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(semTools::moreFitIndices(ksrq_cfa_metric_full,
                                                        fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa_metric_full)),
    ksrq_cfa_metric_cov = c(unlist(lavaan::fitmeasures(ksrq_cfa_metric_cov,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(semTools::moreFitIndices(ksrq_cfa_metric_cov,
                                                        fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa_metric_cov)),
    ksrq_cfa_gender = c(unlist(lavaan::fitmeasures(ksrq_cfa_gender,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(semTools::moreFitIndices(ksrq_cfa_gender,
                                                        fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa_gender)),
    ksrq_cfa_gender_metric = c(unlist(lavaan::fitmeasures(ksrq_cfa_gender_metric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(semTools::moreFitIndices(ksrq_cfa_gender_metric,
                                                        fit.measures = c('gammaHat', 'adjGammaHat'))),
                 AIC=AIC(ksrq_cfa_gender_metric)))

ksrq_cfa_fit$delta1 <- ksrq_cfa_fit$ksrq_cfa_metric - ksrq_cfa_fit$ksrq_cfa
ksrq_cfa_fit$delta1a <- ksrq_cfa_fit$ksrq_cfa_metric_full - ksrq_cfa_fit$ksrq_cfa
ksrq_cfa_fit$delta2 <- ksrq_cfa_fit$ksrq_cfa_metric_cov - ksrq_cfa_fit$ksrq_cfa_metric
ksrq_cfa_fit$delta_gender <- ksrq_cfa_fit$ksrq_cfa_gender_metric - ksrq_cfa_fit$ksrq_cfa_gender
ksrq_cfa_fit
lavTestLRT(ksrq_cfa, ksrq_cfa_metric)
lavTestLRT(ksrq_cfa_metric, ksrq_cfa_metric_cov)
ksrq_cor_diff <- inspect(ksrq_cfa_metric_cov, 'cor.lv')$yads_online - inspect(ksrq_cfa_cov, 'cor.lv')$yads_online
ksrq_cor_diff

ksrq_cfa_metric_invar_stats <- do.call(sprintf, 
        c(list(fmt = '$\\Delta$RMSEA = %0.5f, $\\Delta$MFI = %0.3f, $\\Delta\\hat{\\gamma}$ = %0.3f'),
          (ksrq_cfa_fit$delta1)[1:3]))

ksrq_cfa_cov_fit_stats <- do.call(sprintf, 
        c(list(fmt = '$\\Delta$RMSEA = %0.5f, $\\Delta$MFI = %0.3f, $\\Delta\\hat{\\gamma}$ = %0.3f, $\\Delta$AIC = %0.0f'),
          (ksrq_cfa_fit$delta2)[c(1:3,5)]))
```

A CFA for the four K-SRQ factors was tested for metric invariance across samples by comparing a model with loadings constrained to equality to one with loadings free to vary across the four groups.
This resulted in considerably worse model fit as determined by a change in the MFI > .01.
Loading constraints were removed from four items ("I like it if others looks up to me", "I like being a member of a group/club", "I like kissing", "I like flirting") that load onto Admiration, Sociability, and  Sexual Relationships, respectively.
This resulted in adequately small fit differences between the unconstrained and invariant models (`r ksrq_cfa_metric_invar_stats`).
The final model showed somewhat poor fit ($\text{N}_{\text{total}}$ = `r lavaan::inspect(ksrq_cfa, what = 'ntotal')`, RMSEA = `r round(ksrq_cfa_fit$ksrq_cfa_metric[['rmsea']],2)`, MFI = `r round(ksrq_cfa_fit$ksrq_cfa_metric[['mfi']],2)`, $\hat\gamma$ = `r round(ksrq_cfa_fit$ksrq_cfa_metric[['gammaHat']],3)`). 

Models with and without constraintes between latent variances and covariances were compared using the Akaike information criterion (AIC).
Constraining equivalent latent covariance structures across groups resulted in lower AIC ($\Delta\text{AIC} = `r round(ksrq_cfa_fit$delta2[['AIC']])`$).
Loadings without constraints across groups do not contribute to this comparison, so the magnitude of correlations was compared across the metric invariant and unconstrained models (while mainting the constraint of covariance across groups).
The differences in correlations were in the range _r_ = [`r round(min(ksrq_cor_diff),2)`, `r round(max(ksrq_cor_diff),2)`], indicating very low sensitivity the observed measurement invariance.
To maintain content coverage [@borsboom2006], the unconstrained model is used, though sensitivity to constraints on the four non-invariant loadings is assessed again.
Correlations among the Admiration, Sociability, and  Sexual Relationships subscales were all high (_r_ = [.67,.84]). 
Correlations of Passivity with these three subscales was generally low, but positive (_r_ = [.07, .21]; see Table ??? for all latent variable correlations).

### Misc

```{r eval = F}
psych::fa.parallel(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))])
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))], 
                nfactors = 4, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25)
print(psych::fa(splt_fsmi[,unlist(get_items_from_keys(ksqr_key[scales_to_use_ksrq]))], 
                nfactors = 3, n.iter = 1,
                scores = 'tenBerge', missing = F, fm = 'ml'), 
      sort = T, cut = .25)
```

```{r}
ksrq_3factor_keys <- list(
    ML1 = c('K_SRQ_11', 
            'K_SRQ_18', 
            'K_SRQ_1',  
            'K_SRQ_7',  
            'K_SRQ_10'),
    ML2 = c('K_SRQ_4',  
            'K_SRQ_20', 
            'K_SRQ_13', 
            'K_SRQ_9',  
            'K_SRQ_15'),
    ML3 = c('K_SRQ_12', 
            'K_SRQ_21', 
            'K_SRQ_23'))
ksrq_3factor_model <- milav::create_cfa_from_keylist(ksrq_3factor_keys)

ksrq_3factor_cfa <- lavaan::lavaan(model = ksrq_3factor_model, data = splt_fsmi,
                                  missing = 'fiml', estimator = 'MLR',
                                  int.ov.free = TRUE, int.lv.free = FALSE, 
                                  auto.fix.first = FALSE, std.lv = TRUE, 
                                  auto.fix.single = TRUE, auto.var = TRUE, 
                                  auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                  auto.delta = TRUE, auto.cov.y = TRUE)
ksrq_3fac_cfa_fit <- list(
    lavaan::fitmeasures(ksrq_3factor_cfa,
                        fit.measures = c('rmsea', 'mfi')),
    semTools::moreFitIndices(ksrq_3factor_cfa,
           fit.measures = c('gammaHat', 'adjGammaHat')))

summary(ksrq_cfa, standardize = T)
summary(ksrq_3factor_cfa, stand = T)
```


(ref:ksrqcfaplot) K-SRQ CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r ksrqcfaplot, fig.width=8, fig.height=3.5, fig.cap = '(ref:ksrqcfaplot)'}
semPlot::semPaths(ksrq_cfa, 
                  layout = 'tree2', 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 6, sizeLat = 10,
                  minimum = .0, maximum = 1, curvature = 1.25, 
                  ask = F, title = T, combineGroups = F)
```

(ref:ksrq3faccfaplot) K-SRQ CFA. Path weights and labels reflect standardized loading strength. Residuals, exogenous variances, and means not shown.

```{r ksrq3faccfaplot, fig.width=8, fig.height=3.5, fig.cap = '(ref:ksrq3faccfaplot)'}
semPlot::semPaths(ksrq_3factor_cfa, 
                  layout = 'tree2', 
                  intercepts = F, residuals = F, exoVar = F,
                  what = 'std', whatLabels = 'std', 
                  nCharNodes = 12, sizeMan = 6, sizeLat = 10,
                  minimum = .0, maximum = 1, curvature = 1.25)
```

```{r ksrq3facfsmimate}
ksrq_matestat_model <- paste(fsmi_cfa_matestat_model, ksrq_model, sep = '\n')
ksrq_matestat_cfa_nogrp <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE)
ksrq_matestat_cfa <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered')
ksrq_matestat_grp_const_cfa <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings'))
ksrq_matestat_grp_const_cfa_cov_sexrel_test <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings', 'lv.covariances'),
    group.partial = c(
        paste0('fsmi_mate~~', 
               c('fsmi_stat','k_srq_admiration',
                 'k_srq_passivity', 'k_srq_sociability')),
        paste0('fsmi_stat~~', c('k_srq_admiration', 'k_srq_passivity',
                                'k_srq_sexual_relationships', 'k_srq_sociability')),
        paste0('k_srq_admiration~~', c('k_srq_passivity',
                                       'k_srq_sexual_relationships',
                                       'k_srq_sociability')),
        paste0('k_srq_passivity~~', c('k_srq_sexual_relationships',
                                      'k_srq_sociability')),
        paste0('k_srq_sexual_relationships~~', c('k_srq_sociability'))
    ))
ksrq_matestat_grp_const_cfa_cov_admir_test <- lavaan::lavaan(
    model = ksrq_matestat_model, data = splt_fsmi[!is.na(splt_fsmi$partnered),],
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = T, std.lv = F, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE, 
    group = 'partnered',
    group.equal = c('loadings', 'lv.covariances'),
    group.partial = c(
        paste0('fsmi_mate~~', 
               c('fsmi_stat','k_srq_admiration',
                 'k_srq_passivity', 'k_srq_sexual_relationships',
                 'k_srq_sociability')),
        paste0('fsmi_stat~~', c('k_srq_passivity',
                                'k_srq_sexual_relationships', 'k_srq_sociability')),
        paste0('k_srq_admiration~~', c('k_srq_passivity',
                                       'k_srq_sexual_relationships',
                                       'k_srq_sociability')),
        paste0('k_srq_passivity~~', c('k_srq_sexual_relationships',
                                      'k_srq_sociability')),
        paste0('k_srq_sexual_relationships~~', c('k_srq_sociability'))
    ))


ksrq_matestat_cfa_fit <- list(
    uncon = c(lavaan::fitmeasures(ksrq_matestat_cfa,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_cfa,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmet = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmetcovsexrel = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa_cov_sexrel_test,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa_cov_sexrel_test,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))),
    grpmetcovadmir = c(lavaan::fitmeasures(ksrq_matestat_grp_const_cfa_cov_admir_test,
                                  fit.measures = c('rmsea', 'mfi')),
              semTools::moreFitIndices(ksrq_matestat_grp_const_cfa_cov_admir_test,
                                       fit.measures = c('gammaHat', 'adjGammaHat'))))

# probably metric invariant, but close to a worse fit.
round(ksrq_matestat_cfa_fit$grpmet - ksrq_matestat_cfa_fit$uncon,5)
round(ksrq_matestat_cfa_fit$grpmetcovsexrel - ksrq_matestat_cfa_fit$grpmet,5)
round(ksrq_matestat_cfa_fit$grpmetcovadmir - ksrq_matestat_cfa_fit$grpmet,5)


ksrq_matestat_grp_const_cfa_par <- standardizedSolution(ksrq_matestat_grp_const_cfa, ci = TRUE)
ksrq_matestat_mate_sr_cor <- ksrq_matestat_grp_const_cfa_par[
    ksrq_matestat_grp_const_cfa_par$lhs == 'fsmi_mate' & 
        ksrq_matestat_grp_const_cfa_par$rhs == 'k_srq_sexual_relationships',]
ksrq_matestat_stat_sr_cor <- ksrq_matestat_grp_const_cfa_par[
    ksrq_matestat_grp_const_cfa_par$lhs == 'fsmi_stat' & 
        ksrq_matestat_grp_const_cfa_par$rhs == 'k_srq_sexual_relationships',]
ksrq_matestat_metric_invar_stats <- do.call(sprintf, 
        c(list(fmt = '$\\Delta$RMSEA = %0.5f, $\\Delta$MFI = %0.3f, $\\Delta\\hat{\\gamma}$ = %0.3f'),
          (ksrq_matestat_cfa_fit$grpmet - ksrq_matestat_cfa_fit$uncon)[1:3]))

ksqr_matestat_cordf_l <- dplyr::select(
    dplyr::filter(
        ksrq_matestat_grp_const_cfa_par,
        lhs %in% c('fsmi_mate', 'fsmi_stat',
                   'k_srq_passivity',
                   'k_srq_admiration',
                   'k_srq_sexual_relationships'),
        op == '~~',
        rhs %in% c('fsmi_stat', 'k_srq_passivity',
                   'k_srq_sexual_relationships', 
                   'k_srq_admiration', 
                   'k_srq_sociability'),
        lhs != rhs),
    lhs, op, rhs, group, est.std, ci.upper, ci.lower, z)
ksqr_matestat_cordf <- dplyr::mutate(
    tidyr::spread(
        tidyr::unite(
            tidyr::gather(
                ksqr_matestat_cordf_l,
                par, value, est.std, ci.upper, ci.lower, z), 
            grouppar, par, group),
        grouppar, value),
    est_rep_1 = sprintf('% 0.2f [% 0.2f,% 0.2f]', est.std_1, ci.lower_1, ci.upper_1),
    est_rep_2 = sprintf('% 0.2f [% 0.2f,% 0.2f]', est.std_2, ci.lower_2, ci.upper_2))

save_out_list <- c(save_out_list, 'ksrq_matestat_grp_const_cfa_par', 'ksrq_matestat_cfa_fit',
                   'ksrq_matestat_mate_sr_cor', 'ksrq_matestat_stat_sr_cor',
                   'ksrq_matestat_metric_invar_stats','ksqr_matestat_cordf',
                   'ksqr_matestat_cordf_l')
```


(ref:ksqrmatestatcor) Correlations between FSMI and K-SRQ scales of interest.

```{r}
knitr::kable(
    dplyr::select(ksqr_matestat_cordf,
                  lhs, op, rhs, est_rep_1, est_rep_2),
    digits = 2,
    caption = '(ref:ksqrmatestatcor)')
```

```{r fig.width=5.875, fig.height=4.2, fig.cap='(ref:ksqrmatestatcor)'}
scale_labels <- c('fsmi_mate' = expression(paste('Mate-seeking')[F]),
                  'fsmi_stat' = expression(paste('Status')[F]),
                  'dominance_score' = expression(paste('Dominance')[D]),
                  'prestige_score' = expression(paste('Presitige')[D]),
                  'neg_urgency' = expression(paste('-Urgency')[U]),
                  'premeditation' = expression(paste('Premeditation')[U]),
                  'perseverance' = expression(paste('Perseverance')[U]),
                  'sensation_seeking' = expression(paste('Sensation S.')[U]),
                  'pos_urgency' = expression(paste('+Urgency')[U]),
                  'k_srq_admiration' = expression(paste('Admiration')[K]),
                  'k_srq_passivity' = expression(paste('Passivity')[K]),
                  'k_srq_sexual_relationships' = expression(paste('Sexual Rel.')[K]),
                  'k_srq_sociability' = expression(paste('Sociability')[K]))
bordergray <- '#eeeeee'
ggplot2::theme_set(ggplot2::theme_minimal())
fsmi_ksrq_plot <- ggplot2::ggplot(
    dplyr::mutate_at(ksqr_matestat_cordf_l,
                     dplyr::vars(lhs,rhs),
                     funs(factor(., levels = names(scale_labels), labels = scale_labels))),
    ggplot2::aes(x = factor(group, levels = 1:2, labels = c('- LTR', '+ LTR')), 
                 y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = '#666666') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0, alpha = .5) + 
    ggplot2::geom_point(size = .75) + 
    ggplot2::facet_grid(lhs ~ rhs, labeller = ggplot2::label_parsed) + 
    ggplot2::coord_cartesian(ylim = c(-1.1,1.1)) + 
    ggplot2::scale_y_continuous(position = 'left', breaks = c(-.5, .5)) + 
    ggplot2::theme(
        axis.text.x = ggplot2::element_text(angle = 360-0, hjust = .5),
        panel.grid.major.x = ggplot2::element_blank(),
        panel.border = ggplot2::element_rect(fill = NA, color = bordergray, size = 1, linetype = 1),
        strip.background = ggplot2::element_rect(fill=bordergray, color = bordergray, size = 1, linetype = 1),
        strip.text.y = ggplot2::element_text(size = 8),
        axis.line.x = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        axis.line.y = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        panel.spacing = ggplot2::unit(0.0, units = 'in'), 
        plot.margin = ggplot2::margin(2,2,0,2),
        axis.title.x = ggplot2::element_text(margin = ggplot2::margin(0,0,0,0))
        ) + 
    ggplot2::labs(x = '', y = 'Standardized estimate and 95% confidence interval')
fsmi_ksrq_plot
save_out_list <- c(save_out_list, 'fsmi_ksrq_plot')
```

### K-SRQ and age

```{r}
splt_fsmi_devdemog$samplegroup <- ifelse(grepl('yads',splt_fsmi_devdemog$sample),
                                         'college',
                                         'adolescent')

splt_fsmi_devdemog$age_c2 <- splt_fsmi_devdemog$age_c^2

ksrq_age_model <- paste(
    ksrq_model,
    paste0(paste(scales_to_use_ksrq, collapse = ' + '), ' ~ age_c + age_c2 + gender_c + age_c:gender_c + age_c2:gender_c'),
    sep = '\n')

ksrq_cfa_metric_agesem_sample <- lavaan::lavaan(
    model = ksrq_age_model, data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 'lv.variances', 'lv.covariances'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_metric_agesem <- lavaan::lavaan(
    model = ksrq_age_model, data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'samplegroup', group.equal = c('loadings', 'lv.variances', 'lv.covariances'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_sampledef_fit <- AIC(ksrq_cfa_metric_agesem_sample,ksrq_cfa_metric_agesem)
rbind(ksrq_cfa_sampledef_fit, difference = sapply(ksrq_cfa_sampledef_fit, diff))

ksrq_cfa_metric_agesem_reginvar_sample <- lavaan::lavaan(
    model = ksrq_age_model, data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_metric_agesem_reginvar <- lavaan::lavaan(
    model = ksrq_age_model, data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'samplegroup', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_reginvar_sampledef_fit <- AIC(ksrq_cfa_metric_agesem_reginvar, 
                                       ksrq_cfa_metric_agesem_reginvar_sample)
rbind(ksrq_cfa_reginvar_sampledef_fit, difference = sapply(ksrq_cfa_reginvar_sampledef_fit, diff))

ksrq_cfa_agesem_reginvar_sample <- lavaan::lavaan(
    model = ksrq_age_model, data = splt_fsmi_devdemog,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'))

ksrq_cfa_metric_agesem_fit <- AIC(ksrq_cfa_metric_agesem_sample, 
                                  ksrq_cfa_metric_agesem_reginvar_sample)
rbind(ksrq_cfa_metric_agesem_fit, difference = sapply(ksrq_cfa_metric_agesem_fit, diff))

#invariant and unconstrained model coefficient differences
round(inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
    inspect(ksrq_cfa_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)],3)

#invariant and unconstrained model standardized coefficient differences
ksrq_agesem_betadiffs <- inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'std')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
    inspect(ksrq_cfa_agesem_reginvar_sample, 'std')$yads_online$beta[1:4, c(5,7,6,8,9)]

#invariant and unconstrained z scores and z score differences
round(inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)
round(inspect(ksrq_cfa_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_agesem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)
round(inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] /
          inspect(ksrq_cfa_metric_agesem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
          inspect(ksrq_cfa_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_agesem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)

ksrq_age_ints <- inspect(ksrq_cfa_agesem_reginvar_sample, 'mean.lv')
ksrq_age_betas <- lapply(inspect(ksrq_cfa_agesem_reginvar_sample, 'coef'), 
                         function(asample) asample$beta[1:4, c(5,7,6,8,9)])

ksrq_std_pars <- standardizedsolution(ksrq_cfa_agesem_reginvar_sample)

age_gender_pred_df <- rbind(
    as.data.frame(expand.grid(age = c(11:17,17.9), gender_c = c(-.5, .5), sample = c('TDS1', 'TDS2'))),
    as.data.frame(expand.grid(age = 18:25, gender_c = c(-.5, .5), sample = c('yads', 'yads_online'))))
age_gender_pred_df$age_c <- age_gender_pred_df$age - 18
age_gender_pred_df$age_c2 <- age_gender_pred_df$age_c^2
age_gender_pred_mat <- model.matrix(~age_c*gender_c+age_c2*gender_c, data = age_gender_pred_df)

ksrq_pred_factor_scores <- lapply(
    c('TDS1', 'TDS2', 'yads', 'yads_online'),
    function(asample) {
        adf <- do.call(cbind, lapply(seq_along(ksrq_age_ints[[asample]]), function(i){
            y <- age_gender_pred_mat %*% as.vector(c(ksrq_age_ints[[asample]][[i]], 
                                                     ksrq_age_betas[[asample]][i,]))
            dimnames(y)[2] <- names(ksrq_age_ints[[asample]])[[i]]
            y
        }))
        cbind(age_gender_pred_df[age_gender_pred_df$sample == asample,],
              adf[age_gender_pred_df$sample == asample,])
    })

participant_measurements <-  dplyr::bind_rows(
    lapply(lavaan::lavPredict(ksrq_cfa_agesem_reginvar_sample), data.frame))
ksrq_age_model_data_list <- lapply(lavaan::inspect(ksrq_cfa_agesem_reginvar_sample, 'data'), as.data.frame)
ksrq_age_model_data <- dplyr::bind_rows(ksrq_age_model_data_list, .id = 'sample')
names(ksrq_age_model_data) <- c('sample', lavaan::lavNames(ksrq_cfa_agesem_reginvar_sample))
ksrq_age_model_data <- cbind(ksrq_age_model_data, participant_measurements)
ksrq_age_model_data_l <- tidyr::gather(
    dplyr::select(ksrq_age_model_data, age_c:gender_c, sample, k_srq_admiration:k_srq_sociability),
    factor,
    value,
    -gender_c, -age_c, -age_c2, -sample)
ksrq_age_model_data_l$age <- ksrq_age_model_data_l$age_c + 18
ksrq_age_model_data_l <- dplyr::filter(
    ksrq_age_model_data_l,
    !is.na(gender_c),
    !is.na(age))

age_gender_pred_df <- tidyr::gather(
    dplyr::bind_rows(ksrq_pred_factor_scores),
    factor,
    value,
    -age, -gender_c, -age_c, -age_c2, -sample)
```

```{r fig.width=5.875, fig.height=3}
gender_colors <- c('#1f78b4', '#33a02c')
ggplot2::theme_set(ggplot2::theme_minimal())
ksrq_age_pred_plot <- ggplot2::ggplot(
    age_gender_pred_df,
    ggplot2::aes(x = age, y = value, 
                 group = interaction(sample, gender_c),
                 linetype = factor(gender_c))) +
    ggplot2::geom_point(data = ksrq_age_model_data_l, size = .75,
                        alpha = .4, position = ggplot2::position_jitter(h=0, w = .15),
                        ggplot2::aes(color = factor(gender_c))) +
    ggplot2::geom_line() + 
    ggplot2::facet_grid(gender_c~factor,
                        labeller = ggplot2::labeller(
                            factor = c('k_srq_admiration' = 'Admiration',
                                       'k_srq_passivity' = 'Passivity',
                                       'k_srq_sexual_relationships' = 'Sexual relationships',
                                       'k_srq_sociability' = 'Sociability'),
                            gender_c = c('-0.5' = 'Male', '0.5' = 'Female'))) + 
    ggplot2::scale_color_manual(breaks = c(-.5, .5), values = gender_colors,
                                  labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::scale_linetype_manual(breaks = c(-.5, .5), values = c(2,4),
                                     labels = c('Male', 'Female'), name = 'Gender') +
    ggplot2::scale_x_continuous(breaks = c(12, 15, 18, 21, 24)) + 
    ggplot2::coord_cartesian(xlim = c(min(ksrq_age_model_data_l$age, na.rm = T),
                                      max(ksrq_age_model_data_l$age, na.rm = T))) +
    ggplot2::labs(x = 'Age (years)', y = 'Latent variable value') + 
    ggplot2::theme(legend.position = 'none') + 
    NULL
ksrq_age_pred_plot
```

```{r}

ksrq_std_par_table <- ksrq_std_pars[ksrq_std_pars$op == '~' & ksrq_std_pars$rhs %in% c('age_c', 'age_c:gender_c', 'age_c2', 'age_c2:gender_c'),
              c('lhs', 'rhs', 'group', 'est.std', 'ci.lower', 'ci.upper')] %>%
    dplyr::mutate(est.std = sprintf('%0.2f [%0.2f, %0.2f]', est.std, ci.lower, ci.upper),
                  group = inspect(ksrq_cfa_agesem_reginvar_sample, 'group.label')[group]) %>%
    dplyr::select(-ci.lower, -ci.upper) %>%
    tidyr::spread(rhs, est.std) %>%
    dplyr::mutate(group = sample_labels_short[group],
                  lhs_ = lhs) %>%
    dplyr::group_by(lhs_) %>%
    dplyr::mutate(lhs = c(stringr::str_to_title(sub('_', ' ', sub('k_srq_', '', lhs[[1]]))), 
                          rep('', n()-1))) %>% 
    dplyr::ungroup() %>%
    dplyr::select(lhs, group, age_c, `age_c:gender_c`, age_c2, `age_c2:gender_c`)

ksrq_age_table <- knitr::kable(
    dplyr::filter(parameterestimates(ksrq_cfa_agesem_reginvar_sample, stan = T), op == '~'),
    digits = 2,
    caption = paste0('K-SRQ and age; N obs. = ',
                     lavaan::nobs(ksrq_cfa_agesem_reginvar_sample)))
ksrq_age_table

knitr::kable(ksrq_std_par_table,
             col.names = c('K-SRQ factor', 'Sample', 
                           '$\\text{Age}$', '$\\text{Age}\\times\\text{Gender}$', 
                           '$\\text{Age}^2$', '$\\text{Age}^2\\times\\text{Gender}$'),
             booktabs = TRUE)
```

### K-SRQ PDS

```{r}
splt_fsmi_devdemog$pds_c <- as.numeric(splt_fsmi_devdemog$PDS_mean_score) - 3.0
splt_fsmi_devdemog$pds_c2 <- splt_fsmi_devdemog$pds_c^2

ksrq_pds_model <- paste(
    ksrq_model,
    paste0(paste(scales_to_use_ksrq, collapse = ' + '), 
           ' ~ pds_c + pds_c2 + gender_c + pds_c:gender_c + pds_c2:gender_c'),
    sep = '\n')

ksrq_pds_model_lin <- paste(
    ksrq_model,
    paste0(paste(scales_to_use_ksrq, collapse = ' + '), 
           ' ~ pds_c + gender_c + pds_c:gender_c'),
    sep = '\n')

#college online with very low scores on PDS are removed
# pds_mod_data <- dplyr::filter(splt_fsmi_devdemog, !(grepl('yads', sample) & PDS_mean_score < 3))
pds_mod_data <- splt_fsmi_devdemog

ksrq_cfa_metric_pdssem_sample <- lavaan::lavaan(
    model = ksrq_pds_model, data = pds_mod_data,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 'lv.variances', 'lv.covariances'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_metric_pdssem_reginvar_sample <- lavaan::lavaan(
    model = ksrq_pds_model, data = pds_mod_data,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_metric_pdssemlin_reginvar_sample <- lavaan::lavaan(
    model = ksrq_pds_model_lin, data = pds_mod_data,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'),
    group.partial = c('k_srq_sociability =~ K_SRQ_10',
                      'k_srq_admiration =~  K_SRQ_7',
                      'k_srq_sexual_relationships =~ K_SRQ_13',
                      'k_srq_sexual_relationships =~ K_SRQ_20'))

ksrq_cfa_pdssem_reginvar_sample <- lavaan::lavaan(
    model = ksrq_pds_model, data = pds_mod_data,
    missing = 'fiml', estimator = 'MLR',
    int.ov.free = TRUE, int.lv.free = FALSE, 
    auto.fix.first = TRUE, std.lv = FALSE, 
    auto.fix.single = TRUE, auto.var = TRUE, 
    auto.cov.lv.x = TRUE, auto.th = TRUE, 
    auto.delta = TRUE, auto.cov.y = TRUE,
    group = 'sample', group.equal = c('loadings', 
                                           'lv.variances', 
                                           'lv.covariances',
                                           'regressions', 'means'))

ksrq_cfa_metric_pdssem_fit <- AIC(ksrq_cfa_metric_pdssem_sample, 
                                  ksrq_cfa_metric_pdssem_reginvar_sample)
rbind(ksrq_cfa_metric_pdssem_fit, difference = sapply(ksrq_cfa_metric_pdssem_fit, diff))
#Constrained regression fit better

ksrq_cfa_metric_pdssemlin_fit <- AIC(ksrq_cfa_metric_pdssemlin_reginvar_sample,
                                  ksrq_cfa_metric_pdssem_reginvar_sample)
rbind(ksrq_cfa_metric_pdssem_fit, difference = sapply(ksrq_cfa_metric_pdssem_fit, diff))
#quad fit better

#invariant and unconstrained model coefficient differences
round(inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
    inspect(ksrq_cfa_agesem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)],3)

#invariant and unconstrained model standardized coefficient differences
ksrq_pdssem_betadiffs <- inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'std')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
    inspect(ksrq_cfa_pdssem_reginvar_sample, 'std')$yads_online$beta[1:4, c(5,7,6,8,9)]
ksrq_pdssem_betadiffs

#invariant and unconstrained z scores and z score differences
round(inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)
round(inspect(ksrq_cfa_pdssem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_pdssem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)
round(inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] /
          inspect(ksrq_cfa_metric_pdssem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)] - 
          inspect(ksrq_cfa_pdssem_reginvar_sample, 'coef')$yads_online$beta[1:4, c(5,7,6,8,9)] / 
          inspect(ksrq_cfa_pdssem_reginvar_sample, 'se')$yads_online$beta[1:4, c(5,7,6,8,9)], 3)

ksrq_pds_ints <- inspect(ksrq_cfa_pdssem_reginvar_sample, 'mean.lv')
ksrq_pds_betas <- lapply(inspect(ksrq_cfa_pdssem_reginvar_sample, 'coef'), 
                         function(asample) asample$beta[1:4, c(5,7,6,8,9)])

ksrq_std_pds_pars <- standardizedsolution(ksrq_cfa_pdssem_reginvar_sample)

pds_gender_pred_df <- as.data.frame(expand.grid(pds = seq(1.4, 4, .2), gender_c = c(-.5, .5), 
                              sample = c('yads', 'yads_online', 'TDS1', 'TDS2')))
pds_gender_pred_df$pds_c <- pds_gender_pred_df$pds - 3
pds_gender_pred_df$pds_c2 <- pds_gender_pred_df$pds_c^2
pds_gender_pred_mat <- model.matrix(~pds_c*gender_c+pds_c2*gender_c, data = pds_gender_pred_df)

ksrq_pred_factor_scores_pds <- lapply(
    c('TDS1', 'TDS2', 'yads', 'yads_online'),
    function(asample) {
        adf <- do.call(cbind, lapply(seq_along(ksrq_pds_ints[[asample]]), function(i){
            y <- pds_gender_pred_mat %*% as.vector(c(ksrq_pds_ints[[asample]][[i]], 
                                                     ksrq_pds_betas[[asample]][i,]))
            dimnames(y)[2] <- names(ksrq_pds_ints[[asample]])[[i]]
            y
        }))
        cbind(pds_gender_pred_df[pds_gender_pred_df$sample == asample,],
              adf[pds_gender_pred_df$sample == asample,])
    })

participant_measurements_pds <-  dplyr::bind_rows(
    lapply(lavaan::lavPredict(ksrq_cfa_pdssem_reginvar_sample), data.frame))
ksrq_pds_model_data_list <- lapply(lavaan::inspect(ksrq_cfa_pdssem_reginvar_sample, 'data'), as.data.frame)
ksrq_pds_model_data <- dplyr::bind_rows(ksrq_pds_model_data_list, .id = 'sample')
names(ksrq_pds_model_data) <- c('sample', lavaan::lavNames(ksrq_cfa_pdssem_reginvar_sample))
ksrq_pds_model_data <- cbind(ksrq_pds_model_data, participant_measurements_pds)
ksrq_pds_model_data_l <- tidyr::gather(
    dplyr::select(ksrq_pds_model_data, pds_c:gender_c, sample, k_srq_admiration:k_srq_sociability),
    factor,
    value,
    -gender_c, -pds_c, -pds_c2, -sample)
ksrq_pds_model_data_l$pds <- ksrq_pds_model_data_l$pds_c + 3
ksrq_pds_model_data_l <- dplyr::filter(
    ksrq_pds_model_data_l,
    !is.na(gender_c),
    !is.na(pds))

pds_gender_pred_df <- tidyr::gather(
    dplyr::bind_rows(ksrq_pred_factor_scores_pds),
    factor,
    value,
    -pds, -gender_c, -pds_c, -pds_c2, -sample)
```

```{r fig.width=5.875, fig.height=3}
gender_colors <- c('#1f78b4', '#33a02c')
ggplot2::theme_set(ggplot2::theme_minimal())
ksrq_pds_pred_plot <- ggplot2::ggplot(
    pds_gender_pred_df,
    ggplot2::aes(x = pds, y = value, 
                 group = interaction(sample, gender_c),
                 linetype = factor(gender_c))) +
    ggplot2::geom_point(data = ksrq_pds_model_data_l, size = .75,
                        alpha = .4, position = ggplot2::position_jitter(h=0, w = .035),
                        ggplot2::aes(color = factor(gender_c))) +
    ggplot2::geom_line() + 
    ggplot2::facet_grid(gender_c~factor,
                        labeller = ggplot2::labeller(
                            factor = c('k_srq_admiration' = 'Admiration',
                                       'k_srq_passivity' = 'Passivity',
                                       'k_srq_sexual_relationships' = 'Sexual relationships',
                                       'k_srq_sociability' = 'Sociability'),
                            gender_c = c('-0.5' = 'Male', '0.5' = 'Female'))) +
    ggplot2::scale_color_manual(breaks = c(-.5, .5), values = gender_colors,
                                  labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::scale_linetype_manual(breaks = c(-.5, .5), values = c(2,4),
                                     labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::coord_cartesian(xlim = c(min(ksrq_pds_model_data_l$pds, na.rm = T),
                                      max(ksrq_pds_model_data_l$pds, na.rm = T))) +
    ggplot2::labs(x = 'PDS mean score', y = 'Latent variable value') + 
    ggplot2::theme(legend.position = 'none') + 
    NULL

ksrq_pds_pred_plot
```

```{r}
ksrq_std_pds_par_table <- ksrq_std_pds_pars[ksrq_std_pds_pars$op == '~' & ksrq_std_pds_pars$rhs %in% c('pds_c', 'pds_c:gender_c', 'pds_c2', 'pds_c2:gender_c'),
              c('lhs', 'rhs', 'group', 'est.std', 'ci.lower', 'ci.upper')] %>%
    dplyr::mutate(est.std = sprintf('%0.2f [%0.2f, %0.2f]', est.std, ci.lower, ci.upper),
                  group = inspect(ksrq_cfa_pdssem_reginvar_sample, 'group.label')[group]) %>%
    dplyr::select(-ci.lower, -ci.upper) %>%
    tidyr::spread(rhs, est.std) %>%
    dplyr::mutate(group = sample_labels_short[group],
                  lhs_ = lhs) %>%
    dplyr::group_by(lhs_) %>%
    dplyr::mutate(lhs = c(stringr::str_to_title(sub('_', ' ', sub('k_srq_', '', lhs[[1]]))), 
                          rep('', n()-1))) %>% 
    dplyr::ungroup() %>%
    dplyr::select(lhs, group, pds_c, `pds_c:gender_c`, pds_c2, `pds_c2:gender_c`)

knitr::kable(ksrq_std_pds_par_table,
             col.names = c('K-SRQ factor', 'Sample', 
                           '$\\text{PDS}$', '$\\text{PDS}\\times\\text{Gender}$', 
                           '$\\text{PDS}^2$', '$\\text{PDS}^2\\times\\text{Gender}$'),
             booktabs = TRUE)
```


### K-SRQ Discussion

A CFA for four of the K-SRQ factors (admiration, passivity, sexual relationships, and sociability) fit fairly well (RMSEA = `r round(ksrq_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(ksrq_cfa_fit[[2]][['gammaHat']],3)`). 
All factors except passivity were strongly inter-correlated, raising doubts about the discriminant validity of the separate factors.
A parallel scree plot analysis suggests a 3 factor structure, with one item from the original sociability factor loading on a factor with the admiration items (weakly), and the other two loading with the sexual relationships items.
A CFA using this factor structure (with no cross-loadings) demonstrates similar fit to the _a priori_ model (RMSEA = `r round(ksrq_cfa_fit[[1]][['rmsea']],3)`, $\hat\gamma$ = `r round(ksrq_cfa_fit[[2]][['gammaHat']],3)`), and with similarly substantial correlations between the former admiration and sexual relationships factors.
A 4 factor EFA retains this general structure, while letting the sociability item, which previously loaded with admiration items, dominate its own factor.
The new 3-factor structure improves somewhat on the _a priori_ model, but the sexual relationships factor has not become any more interpretable as representing a mate-seeking motivation, per se.
Moreover, the sexual relationship factor, as well as its cousin in the 3-factor model both show nominally higher correlations with FSMI status than FSMI mate-seeking.
I use the _a priori_ scale throughout.

The items on the FSMI mate-seeking scale ask almost exlusively aboout seaching for a _new_ romantic or sexula partner, while the K-SRQ sexual relationship scale asks about enjoyment of socio-sexual interaction (e.g., kissing, flirting).
One would expect that the FSMI mate-seeking and K-SRQ sexual relationship correlation would be different between those who are in long term relationships and those who are not.
There is, in fact, a notable difference in the sign of this correlation between people who report being in a long-term relationship than people how report dating, or being single and not dating. 
In a model where factor loadings have been constrained across group [with minimal difference in fit statistics which is necessary for comparison of factor covariances; `r ksrq_matestat_metric_invar_stats`; @gregorich2006], people who are in a long term relationship show a negative correlation between FSMI mate-seeking K-SRQ sexual relationships (Table \@ref(fig:ksqrmatestatcor). 
For people who are not in long-term relationships, there is a positive, significant, correlation between FSMI mate-seeking and the K-SRQ sexual relationships factor.
The relation between FSMI status and this same factor is, however, nominally higher regardless of long-term relationship status.

The K-SRQ admiration-derived factor showed reasonably high correlation with FSMI status, although this was not dissimiler in magnitude from the correlation it shows with the K-SRQ sexual relationship factor.

Generally, the three K-SRQ subscales of interest (but not the passivity subscale) all correlate rather highly among themselves. All four K-SRQ subscales (inlcuding passivity) tend to medium to small correlations with FSMI mate-seeking among people not in long-term relationships, and small or negative correlations among those not in long-term relationships. Across both groups, FSMI status shows medium to large correlations to the K-SRQ subscales except for passivity.

Given how differently the K-SRQ sexual relationships factor covaries with other relevant contructs and across groups, it is clear that it is measuring something distinctly from what the FSMI mate seeking factor is measuring.
The distinction between the seeking new romantic or sexual partners, and enjoyment of engaging in socio-sexual behavior may be important when examining how these motivational factors relate to risk-taking.
Past work has shown that sexual activity (age at first sex, specifically), if it is in the context of a romantic relationshuip, is protective with respect to dellinquency [@harden2007;@harden2011a].

## Urgency, premeditation, perseverence, sensation seeking

### Measurement invariance

```{r uppsp}
uppsp_cfa_model <- milav::create_cfa_from_keylist(
    upps_key)

uppsp_cfa_saveFN <- file.path(data_dir, 'uppsp_cfa_save.rda')
if(!file.exists(uppsp_cfa_saveFN)){
    uppsp_cfa_gender <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
                                       missing = 'fiml', estimator = 'ML',
                                       int.ov.free = TRUE, int.lv.free = FALSE, 
                                       auto.fix.first = TRUE, std.lv = FALSE, 
                                       auto.fix.single = TRUE, auto.var = TRUE, 
                                       auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                       auto.delta = TRUE, auto.cov.y = TRUE,
                                       group = 'gender')
    uppsp_cfa_gender_metric <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
                                              missing = 'fiml', estimator = 'ML',
                                              int.ov.free = TRUE, int.lv.free = FALSE, 
                                              auto.fix.first = TRUE, std.lv = FALSE, 
                                              auto.fix.single = TRUE, auto.var = TRUE, 
                                              auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                              auto.delta = TRUE, auto.cov.y = TRUE,
                                              group = 'gender', group.equal = 'loadings')
    
    uppsp_cfa <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
                                missing = 'fiml', estimator = 'ML',
                                int.ov.free = TRUE, int.lv.free = FALSE, 
                                auto.fix.first = TRUE, std.lv = FALSE, 
                                auto.fix.single = TRUE, auto.var = TRUE, 
                                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                auto.delta = TRUE, auto.cov.y = TRUE,
                                group = 'samplegroup')
    uppsp_cfa_metric <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
                                       missing = 'fiml', estimator = 'ML',
                                       int.ov.free = TRUE, int.lv.free = FALSE, 
                                       auto.fix.first = TRUE, std.lv = FALSE, 
                                       auto.fix.single = TRUE, auto.var = TRUE, 
                                       auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                       auto.delta = TRUE, auto.cov.y = TRUE,
                                       group = 'samplegroup', group.equal = 'loadings')
    
    uppsp_cfa_metric_cov <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
                                           missing = 'fiml', estimator = 'ML',
                                           int.ov.free = TRUE, int.lv.free = FALSE, 
                                           auto.fix.first = TRUE, std.lv = FALSE, 
                                           auto.fix.single = TRUE, auto.var = TRUE, 
                                           auto.cov.lv.x = TRUE, auto.th = TRUE, 
                                           auto.delta = TRUE, auto.cov.y = TRUE,
                                           group = 'samplegroup', 
                                           group.equal = c('loadings',
                                                           'lv.variances',
                                                           'lv.covariances'))
    save(uppsp_cfa_gender,
         uppsp_cfa_gender_metric,
         uppsp_cfa,
         uppsp_cfa_metric,
         uppsp_cfa_metric_cov,
         file = uppsp_cfa_saveFN)
} else {
    load(uppsp_cfa_saveFN)
}

uppsp_cfa_fit <- list(
    uppsp_cfa = c(unlist(lavaan::fitmeasures(uppsp_cfa,
                                            fit.measures = c('rmsea', 'mfi'))),
                 unlist(fasterMoreFitIndices(uppsp_cfa)),
                 AIC=AIC(uppsp_cfa)),
    uppsp_cfa_metric = c(unlist(lavaan::fitmeasures(uppsp_cfa_metric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(uppsp_cfa_metric)),
                 AIC=AIC(uppsp_cfa_metric)),
    uppsp_cfa_metric_cov = c(unlist(lavaan::fitmeasures(uppsp_cfa_metric_cov,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(uppsp_cfa_metric_cov)),
                 AIC=AIC(uppsp_cfa_metric_cov)),
    uppsp_cfa_gender = c(unlist(lavaan::fitmeasures(uppsp_cfa_gender,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(uppsp_cfa_gender)),
                 AIC=AIC(uppsp_cfa_gender)),
    uppsp_cfa_gender_metric = c(unlist(lavaan::fitmeasures(uppsp_cfa_gender_metric,
                                                   fit.measures = c('rmsea', 'mfi'))),
                        unlist(fasterMoreFitIndices(uppsp_cfa_gender_metric)),
                 AIC=AIC(uppsp_cfa_gender_metric)))

uppsp_cfa_fit$delta1 <- uppsp_cfa_fit$uppsp_cfa_metric - uppsp_cfa_fit$uppsp_cfa
uppsp_cfa_fit$delta2 <- uppsp_cfa_fit$uppsp_cfa_metric_cov - uppsp_cfa_fit$uppsp_cfa_metric
uppsp_cfa_fit$delta_gender <- uppsp_cfa_fit$uppsp_cfa_gender_metric -
    uppsp_cfa_fit$uppsp_cfa_gender
lapply(uppsp_cfa_fit, round, 4)
lavTestLRT(uppsp_cfa, uppsp_cfa_metric)
lavTestLRT(uppsp_cfa_metric, uppsp_cfa_metric_cov)

uppsp_cfa_metric_invar_stats <- do.call(sprintf, 
        c(list(fmt = '$\\Delta$RMSEA = %0.5f, $\\Delta$MFI = %0.3f, $\\Delta\\hat{\\gamma}$ = %0.3f'),
          (uppsp_cfa_fit$delta1)[1:3]))

uppsp_cfa_cov_fit_stats <- do.call(sprintf, 
        c(list(fmt = '$\\Delta$RMSEA = %0.5f, $\\Delta$MFI = %0.3f, $\\Delta\\hat{\\gamma}$ = %0.3f, $\\Delta$AIC = %0.0f'),
          (uppsp_cfa_fit$delta2)[c(1:3,5)]))

uppsp_factor_cor <- lavaan::inspect(uppsp_cfa_metric_cov, 'cor.lv')$adolescent
diag(uppsp_factor_cor) <- 0
pos_neg_urg <- uppsp_factor_cor['pos_urgency','neg_urgency']
uppsp_factor_cor['pos_urgency','neg_urgency'] <- 0
uppsp_factor_cor['neg_urgency', 'pos_urgency'] <- 0
sprintf('[%0.2f, %0.2f]', min(uppsp_factor_cor), max(uppsp_factor_cor))
sprintf('[%0.2f, %0.2f]', min(abs(uppsp_factor_cor)[abs(uppsp_factor_cor)>0]), max(abs(uppsp_factor_cor)))
```

### UPPS-P and Age

```{r}
uppsp_age_model <- paste(
    uppsp_cfa_model,
    paste0(paste(names(upps_key), collapse = ' + '), ' ~ age_c + age_c2 + gender_c + age_c:gender_c + age_c2:gender_c'),
    sep = '\n')

splt_fsmi_devdemog$age_c3 <- splt_fsmi_devdemog$age_c^3

uppsp_age_cub_model <- paste(
    uppsp_cfa_model,
    paste0(paste(names(upps_key), collapse = ' + '), ' ~ age_c + age_c2 + age_c3 + gender_c + age_c:gender_c + age_c2:gender_c + age_c3:gender_c'),
    sep = '\n')

uppsp_cfa_age_models_saveFN <- file.path(data_dir, 'uppsp_cfa_age_models_save.rda')
if(!file.exists(uppsp_cfa_age_models_saveFN)){
    uppsp_cfa_metric_agesem <- lavaan::lavaan(
        model = uppsp_age_model, data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'samplegroup', group.equal = c('loadings', 'lv.variances',
                                               'lv.covariances'))
    
    uppsp_cfa_metric_agesem_reginvar <- lavaan::lavaan(
        model = uppsp_age_model, data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'MLR',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'samplegroup', group.equal = c('loadings', 
                                               'lv.variances', 
                                               'lv.covariances',
                                               'regressions'))
    # uppsp_cfa_metric_agecubsem <- lavaan::lavaan(
    #     model = uppsp_age_cub_model, data = splt_fsmi_devdemog,
    #     missing = 'fiml', estimator = 'ML',
    #     int.ov.free = TRUE, int.lv.free = FALSE, 
    #     auto.fix.first = TRUE, std.lv = FALSE, 
    #     auto.fix.single = TRUE, auto.var = TRUE, 
    #     auto.cov.lv.x = TRUE, auto.th = TRUE, 
    #     auto.delta = TRUE, auto.cov.y = TRUE,
    #     group = 'samplegroup', group.equal = c('loadings', 'lv.variances',
    #                                            'lv.covariances'))
    # 
    # uppsp_cfa_metric_agecubsem_reginvar <- lavaan::lavaan(
    #     model = uppsp_age_cub_model, data = splt_fsmi_devdemog,
    #     missing = 'fiml', estimator = 'MLR',
    #     int.ov.free = TRUE, int.lv.free = FALSE, 
    #     auto.fix.first = TRUE, std.lv = FALSE, 
    #     auto.fix.single = TRUE, auto.var = TRUE, 
    #     auto.cov.lv.x = TRUE, auto.th = TRUE, 
    #     auto.delta = TRUE, auto.cov.y = TRUE,
    #     group = 'samplegroup', group.equal = c('loadings', 
    #                                            'lv.variances', 
    #                                            'lv.covariances',
    #                                            'regressions'))
    save(uppsp_cfa_metric_agesem,
         uppsp_cfa_metric_agesem_reginvar,
         file = uppsp_cfa_age_models_saveFN)
} else {
    load(uppsp_cfa_age_models_saveFN)
}

# 
# AIC(uppsp_cfa_metric_agesem, 
#     uppsp_cfa_metric_agesem_reginvar,
#     uppsp_cfa_metric_agecubsem, 
#     uppsp_cfa_metric_agecubsem_reginvar)

uppsp_cfa_metric_agesem_fit <- AIC(uppsp_cfa_metric_agesem, 
                                  uppsp_cfa_metric_agesem_reginvar)
rbind(uppsp_cfa_metric_agesem_fit, difference = sapply(uppsp_cfa_metric_agesem_fit, diff))

uppsp_age_ints <- inspect(uppsp_cfa_metric_agesem_reginvar, 'mean.lv')
uppsp_age_betas <- lapply(inspect(uppsp_cfa_metric_agesem_reginvar, 'coef'), 
                         function(asample) asample$beta[1:5, c(6,8,7,9,10)])

uppsp_std_pars <- standardizedsolution(uppsp_cfa_metric_agesem_reginvar)

uppsp_age_gender_pred_df <- rbind(
    as.data.frame(expand.grid(age = c(11:17,17.9), gender_c = c(-.5, .5), 
                              samplegroup = c('adolescent'))),
    as.data.frame(expand.grid(age = 18:25, gender_c = c(-.5, .5), 
                              samplegroup = c('college'))))
uppsp_age_gender_pred_df$age_c <- uppsp_age_gender_pred_df$age - 18
uppsp_age_gender_pred_df$age_c2 <- uppsp_age_gender_pred_df$age_c^2
uppsp_age_gender_pred_mat <- model.matrix(~age_c*gender_c+age_c2*gender_c, 
                                          data = uppsp_age_gender_pred_df)

uppsp_pred_factor_scores <- lapply(
    c('adolescent', 'college'),
    function(asample) {
        adf <- do.call(cbind, lapply(seq_along(uppsp_age_ints[[asample]]), function(i){
            y <- uppsp_age_gender_pred_mat %*% as.vector(c(uppsp_age_ints[[asample]][[i]], 
                                                           uppsp_age_betas[[asample]][i,]))
            dimnames(y)[2] <- names(uppsp_age_ints[[asample]])[[i]]
            y
        }))
        cbind(uppsp_age_gender_pred_df[uppsp_age_gender_pred_df$samplegroup == asample,],
              adf[uppsp_age_gender_pred_df$samplegroup == asample,])
    })

uppsp_participant_measurements <-  dplyr::bind_rows(
    lapply(lavaan::lavPredict(uppsp_cfa_metric_agesem_reginvar), data.frame))
uppsp_age_model_data_list <- lapply(lavaan::inspect(uppsp_cfa_metric_agesem_reginvar, 'data'), as.data.frame)
uppsp_age_model_data <- dplyr::bind_rows(uppsp_age_model_data_list, .id = 'samplegroup')
names(uppsp_age_model_data) <- c('samplegroup', lavaan::lavNames(uppsp_cfa_metric_agesem_reginvar))
uppsp_age_model_data <- cbind(uppsp_age_model_data, uppsp_participant_measurements)
uppsp_age_model_data_l <- tidyr::gather(
    dplyr::select(uppsp_age_model_data, age_c:gender_c, samplegroup,
                  neg_urgency:pos_urgency),
    factor,
    value,
    -gender_c, -age_c, -age_c2, -samplegroup)
uppsp_age_model_data_l$age <- uppsp_age_model_data_l$age_c + 18
uppsp_age_model_data_l <- dplyr::filter(
    uppsp_age_model_data_l,
    !is.na(gender_c),
    !is.na(age))

uppsp_age_gender_pred_df <- tidyr::gather(
    dplyr::bind_rows(uppsp_pred_factor_scores),
    factor,
    value,
    -age, -gender_c, -age_c, -age_c2, -samplegroup)
```

```{r fig.width=5.875, fig.height=3}
gender_colors <- c('#1f78b4', '#33a02c')
ggplot2::theme_set(ggplot2::theme_minimal())
uppsp_age_pred_plot <- ggplot2::ggplot(
    uppsp_age_gender_pred_df,
    ggplot2::aes(x = age, y = value, 
                 group = interaction(samplegroup, gender_c),
                 linetype = factor(gender_c))) +
    ggplot2::geom_point(data = uppsp_age_model_data_l, size = .75,
                        alpha = .4, position = ggplot2::position_jitter(h=0, w = .05),
                        ggplot2::aes(color = factor(gender_c))) +
    ggplot2::geom_line() + 
    ggplot2::facet_grid(gender_c~factor,
                        labeller = ggplot2::labeller(
                            factor = c('neg_urgency' = 'Negative\nUrgency',
                                       'premeditation' = 'Premeditation',
                                       'perseverance' = 'Perseverance',
                                       'sensation_seeking' = 'Sensation\nSeeking',
                                       'pos_urgency' = 'Positive\nUrgency'),
                            gender_c = c('-0.5' = 'Male', '0.5' = 'Female'))) + 
    ggplot2::scale_color_manual(breaks = c(-.5, .5), values = gender_colors,
                                  labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::scale_linetype_manual(breaks = c(-.5, .5), values = c(2,4),
                                     labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::scale_x_continuous(breaks = c(12, 15, 18, 21, 24)) + 
    ggplot2::coord_cartesian(xlim = c(min(uppsp_age_model_data_l$age, na.rm = T),
                                      max(uppsp_age_model_data_l$age, na.rm = T))) +
    ggplot2::labs(x = 'Age (years)', y = 'Latent variable value') + 
    ggplot2::theme(legend.position = 'none') + 
    NULL
uppsp_age_pred_plot
```

```{r}

uppsp_std_par_table <- uppsp_std_pars[uppsp_std_pars$op == '~' & uppsp_std_pars$rhs %in% c('age_c', 'age_c:gender_c', 'age_c2', 'age_c2:gender_c'),
              c('lhs', 'rhs', 'group', 'est.std', 'ci.lower', 'ci.upper')] %>%
    dplyr::mutate(est.std = sprintf('%0.2f [%0.2f, %0.2f]', est.std, ci.lower, ci.upper),
                  group = inspect(uppsp_cfa_metric_agesem_reginvar, 'group.label')[group]) %>%
    dplyr::select(-ci.lower, -ci.upper) %>%
    tidyr::spread(rhs, est.std) %>%
    dplyr::mutate(group = stringr::str_to_title(group),
                  lhs_ = lhs) %>%
    dplyr::group_by(lhs_) %>%
    dplyr::mutate(lhs = c(stringr::str_to_title(sub('_', ' ', lhs[[1]])), 
                          rep('', n()-1))) %>% 
    dplyr::ungroup() %>%
    dplyr::select(lhs, group, age_c, `age_c:gender_c`, age_c2, `age_c2:gender_c`)

knitr::kable(uppsp_std_par_table,
             col.names = c('UPPS-P factor', 'Sample', 
                           '$\\text{Age}$', '$\\text{Age}\\times\\text{Gender}$', 
                           '$\\text{Age}^2$', '$\\text{Age}^2\\times\\text{Gender}$'),
             booktabs = TRUE)
```

### UPPS-P PDS

```{r}

uppsp_pds_model <- paste(
    uppsp_cfa_model,
    paste0(paste(names(upps_key), collapse = ' + '), 
           ' ~ pds_c + pds_c2 + gender_c + pds_c:gender_c + pds_c2:gender_c'),
    sep = '\n')

uppsp_pds_model_lin <- paste(
    uppsp_cfa_model,
    paste0(paste(names(upps_key), collapse = ' + '), 
           ' ~ pds_c + gender_c + pds_c:gender_c'),
    sep = '\n')

uppsp_cfa_puberty_models_saveFN <- file.path(data_dir, 'uppsp_cfa_puberty_models_save.rda')
if(!file.exists(uppsp_cfa_puberty_models_saveFN)){
    uppsp_cfa_metric_pdssem_sample <- lavaan::lavaan(
        model = uppsp_pds_model, data = pds_mod_data,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'samplegroup', group.equal = c('loadings', 'lv.variances', 'lv.covariances'))
    
    uppsp_cfa_metric_pdssem_reginvar_sample <- lavaan::lavaan(
        model = uppsp_pds_model, data = pds_mod_data,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'samplegroup', group.equal = c('loadings', 
                                               'lv.variances', 
                                               'lv.covariances',
                                               'regressions'))
    
    uppsp_cfa_metric_pdssemlin_reginvar_sample <- lavaan::lavaan(
        model = uppsp_pds_model_lin, data = pds_mod_data,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'samplegroup', group.equal = c('loadings', 
                                               'lv.variances', 
                                               'lv.covariances',
                                               'regressions'))
    
    save(uppsp_cfa_metric_pdssem_sample,
         uppsp_cfa_metric_pdssem_reginvar_sample,
         uppsp_cfa_metric_pdssemlin_reginvar_sample,
         file = uppsp_cfa_puberty_models_saveFN)
} else {
    load(uppsp_cfa_puberty_models_saveFN)
}

uppsp_cfa_metric_pdssem_fit <- AIC(uppsp_cfa_metric_pdssem_sample, 
                                   uppsp_cfa_metric_pdssem_reginvar_sample)
rbind(uppsp_cfa_metric_pdssem_fit, difference = sapply(uppsp_cfa_metric_pdssem_fit, diff))
#Constrained regression fit better

uppsp_cfa_metric_pdssemlin_fit <- AIC(uppsp_cfa_metric_pdssemlin_reginvar_sample,
                                      uppsp_cfa_metric_pdssem_reginvar_sample)
rbind(uppsp_cfa_metric_pdssemlin_fit, difference = sapply(uppsp_cfa_metric_pdssemlin_fit, diff))
#quad fit better

uppsp_pds_ints <- inspect(uppsp_cfa_metric_pdssem_reginvar_sample, 'mean.lv')
uppsp_pds_betas <- lapply(inspect(uppsp_cfa_metric_pdssem_reginvar_sample, 'coef'), 
                         function(asample) asample$beta[1:5, c(6,8,7,9,10)])

uppsp_std_pds_pars <- standardizedsolution(uppsp_cfa_metric_pdssem_reginvar_sample)

uppsp_pds_gender_pred_df <- as.data.frame(expand.grid(pds = seq(1.4, 4, .2), gender_c = c(-.5, .5), 
                                                      samplegroup = c('college', 'adolescent')))
uppsp_pds_gender_pred_df$pds_c <- uppsp_pds_gender_pred_df$pds - 3
uppsp_pds_gender_pred_df$pds_c2 <- uppsp_pds_gender_pred_df$pds_c^2
uppsp_pds_gender_pred_mat <- model.matrix(~pds_c*gender_c+pds_c2*gender_c, data = uppsp_pds_gender_pred_df)

uppsp_pred_factor_scores_pds <- lapply(
    c('college', 'adolescent'),
    function(asample) {
        adf <- do.call(cbind, lapply(seq_along(uppsp_pds_ints[[asample]]), function(i){
            y <- uppsp_pds_gender_pred_mat %*% as.vector(c(uppsp_pds_ints[[asample]][[i]], 
                                                     uppsp_pds_betas[[asample]][i,]))
            dimnames(y)[2] <- names(uppsp_pds_ints[[asample]])[[i]]
            y
        }))
        cbind(uppsp_pds_gender_pred_df[uppsp_pds_gender_pred_df$samplegroup == asample,],
              adf[uppsp_pds_gender_pred_df$samplegroup == asample,])
    })

uppsp_participant_measurements_pds <-  dplyr::bind_rows(
    lapply(lavaan::lavPredict(uppsp_cfa_metric_pdssem_reginvar_sample), data.frame))
uppsp_pds_model_data_list <- lapply(lavaan::inspect(uppsp_cfa_metric_pdssem_reginvar_sample, 'data'),
                                    as.data.frame)
uppsp_pds_model_data <- dplyr::bind_rows(uppsp_pds_model_data_list, .id = 'samplegroup')
names(uppsp_pds_model_data) <- c('samplegroup', lavaan::lavNames(uppsp_cfa_metric_pdssem_reginvar_sample))
uppsp_pds_model_data <- cbind(uppsp_pds_model_data, uppsp_participant_measurements_pds)
uppsp_pds_model_data_l <- tidyr::gather(
    dplyr::select(uppsp_pds_model_data, pds_c:gender_c, samplegroup, neg_urgency:pos_urgency),
    factor,
    value,
    -gender_c, -pds_c, -pds_c2, -samplegroup)
uppsp_pds_model_data_l$pds <- uppsp_pds_model_data_l$pds_c + 3
uppsp_pds_model_data_l <- dplyr::filter(
    uppsp_pds_model_data_l,
    !is.na(gender_c),
    !is.na(pds))

uppsp_pds_gender_pred_df <- tidyr::gather(
    dplyr::bind_rows(uppsp_pred_factor_scores_pds),
    factor,
    value,
    -pds, -gender_c, -pds_c, -pds_c2, -samplegroup)
```

```{r fig.width=5.875, fig.height=3}
gender_colors <- c('#1f78b4', '#33a02c')
ggplot2::theme_set(ggplot2::theme_minimal())
uppsp_pds_pred_plot <- ggplot2::ggplot(
    uppsp_pds_gender_pred_df,
    ggplot2::aes(x = pds, y = value, 
                 group = interaction(samplegroup, gender_c),
                 linetype = factor(gender_c))) +
    ggplot2::geom_point(data = uppsp_pds_model_data_l, size = .75,
                        alpha = .4, position = ggplot2::position_jitter(h=0, w = .035),
                        ggplot2::aes(color = factor(gender_c))) +
    ggplot2::geom_line() + 
    ggplot2::facet_grid(gender_c~factor,
                        labeller = ggplot2::labeller(
                            factor = c('neg_urgency' = 'Negative\nUrgency',
                                       'premeditation' = 'Premeditation',
                                       'perseverance' = 'Perseverance',
                                       'sensation_seeking' = 'Sensation\nSeeking',
                                       'pos_urgency' = 'Positive\nUrgency'),
                            gender_c = c('-0.5' = 'Male', '0.5' = 'Female'))) + 
    ggplot2::scale_color_manual(breaks = c(-.5, .5), values = gender_colors,
                                  labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::scale_linetype_manual(breaks = c(-.5, .5), values = c(2,4),
                                     labels = c('Male', 'Female'), name = 'Gender') + 
    ggplot2::coord_cartesian(xlim = c(min(uppsp_pds_model_data_l$pds, na.rm = T),
                                      max(uppsp_pds_model_data_l$pds, na.rm = T))) +
    ggplot2::labs(x = 'PDS mean score', y = 'Latent variable value') + 
    ggplot2::theme(legend.position = 'none') + 
    NULL
uppsp_pds_pred_plot
# Just making sure this shows similar results to computed scales
# computed_scores <- psych::scoreItems(upps_key, splt_fsmi_devdemog, missing = TRUE, impute = 'none')
# computed_scores_df <- bind_cols(as.data.frame(computed_scores$scores), splt_fsmi_devdemog)
# summary(glm(sensation_seeking ~ 1 + pds_c*gender_c + pds_c2*gender_c, data = computed_scores_df))
# summary(glm(pos_urgency ~ 1 + pds_c*gender_c + pds_c2*gender_c, data = computed_scores_df))
```

```{r}
uppsp_std_pds_par_table <- uppsp_std_pds_pars[uppsp_std_pds_pars$op == '~' & uppsp_std_pds_pars$rhs %in% c('pds_c', 'pds_c:gender_c', 'pds_c2', 'pds_c2:gender_c'),
              c('lhs', 'rhs', 'group', 'est.std', 'ci.lower', 'ci.upper')] %>%
    dplyr::mutate(est.std = sprintf('%0.2f [%0.2f, %0.2f]', est.std, ci.lower, ci.upper),
                  group = inspect(uppsp_cfa_metric_pdssem_reginvar_sample, 'group.label')[group]) %>%
    dplyr::select(-ci.lower, -ci.upper) %>%
    tidyr::spread(rhs, est.std) %>%
    dplyr::mutate(group = stringr::str_to_title(group),
                  lhs_ = lhs) %>%
    dplyr::group_by(lhs_) %>%
    dplyr::mutate(lhs = c(stringr::str_to_title(sub('_', ' ', lhs[[1]])), 
                          rep('', n()-1))) %>% 
    dplyr::ungroup() %>%
    dplyr::select(lhs, group, pds_c, `pds_c:gender_c`, pds_c2, `pds_c2:gender_c`)

knitr::kable(uppsp_std_pds_par_table,
             col.names = c('UPPS-P factor', 'Sample', 
                           '$\\text{PDS}$', '$\\text{PDS}\\times\\text{Gender}$', 
                           '$\\text{PDS}^2$', '$\\text{PDS}^2\\times\\text{Gender}$'),
             booktabs = TRUE)
```

# All latent var correlations

## College sample

```{r}
# fsmi_cfa_matestat_gender_metric <- lavaan::lavaan(model = fsmi_cfa_matestat_model, 
#                                                   data = splt_fsmi_devdemog_yads,
#                                                   missing = 'fiml', estimator = 'ML',
#                                                   int.ov.free = TRUE, int.lv.free = FALSE, 
#                                                   auto.fix.first = TRUE, std.lv = FALSE, 
#                                                   auto.fix.single = TRUE, auto.var = TRUE, 
#                                                   auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                                   auto.delta = TRUE, auto.cov.y = TRUE,
#                                                   group = 'gender', 
#                                                   group.equal = 'loadings', 'lv.variances', 'lv.covariances')
# dnp_cfa_gender_partmetric_cor <- lavaan::lavaan(model = dnp_cfa_model, 
#                                                 data = splt_fsmi_devdemog_yads,
#                                                 missing = 'fiml', estimator = 'ML',
#                                                 int.ov.free = TRUE, int.lv.free = FALSE, 
#                                                 auto.fix.first = TRUE, std.lv = FALSE, 
#                                                 auto.fix.single = TRUE, auto.var = TRUE, 
#                                                 auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                                 auto.delta = TRUE, auto.cov.y = TRUE,
#                                                 group = 'gender', 
#                                                 group.equal = c('loadings', 'lv.variances', 'lv.covariances'),
#                                                 group.partial = c(
#                                                     'dominance_score =~ dominance_prestige_16'))
# ksrq_cfa_metric_cov <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
#                                       missing = 'fiml', estimator = 'ML',
#                                       int.ov.free = TRUE, int.lv.free = FALSE, 
#                                       auto.fix.first = TRUE, std.lv = FALSE, 
#                                       auto.fix.single = TRUE, auto.var = TRUE, 
#                                       auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                       auto.delta = TRUE, auto.cov.y = TRUE,
#                                       group = 'sample', group.equal = c('loadings',
#                                                                         'lv.variances',
#                                                                         'lv.covariances'),
#                                       group.partial = c('k_srq_sociability =~ K_SRQ_10',
#                                                         'k_srq_admiration =~  K_SRQ_7',
#                                                         'k_srq_sexual_relationships =~ K_SRQ_13',
#                                                         'k_srq_sexual_relationships =~ K_SRQ_20'))
# uppsp_cfa_metric_cov <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
#                                        missing = 'fiml', estimator = 'ML',
#                                        int.ov.free = TRUE, int.lv.free = FALSE, 
#                                        auto.fix.first = TRUE, std.lv = FALSE, 
#                                        auto.fix.single = TRUE, auto.var = TRUE, 
#                                        auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                        auto.delta = TRUE, auto.cov.y = TRUE,
#                                        group = 'samplegroup', group.equal = c('loadings',
#                                                                               'lv.variances',
#                                                                               'lv.covariances'))

all_scale_latent_varnames <- unlist(c(scales_to_use_mate_stat,
                                      names(dnp_key),
                                      names(upps_key),
                                      scales_to_use_ksrq))
latent_var_cor_collegeFN <-
    file.path(data_dir, 'latent_var_cor-college.rda')
if(!file.exists(latent_var_cor_collegeFN)){
    all_scales_college <- lavaan::lavaan(
        model = paste(fsmi_cfa_matestat_model, dnp_cfa_model,
                      uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog_yads,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'gender', 
        group.equal = c('loadings'),
        group.partial = c('dominance_score =~ dominance_prestige_16',
                          'k_srq_sociability =~ K_SRQ_10',
                          'k_srq_admiration =~  K_SRQ_7',
                          'k_srq_sexual_relationships =~ K_SRQ_13',
                          'k_srq_sexual_relationships =~ K_SRQ_20'))
    all_scales_college_cor <- lavaan::update(all_scales_college, 
                                             group.equal = c('loadings',
                                                             'lv.variances',
                                                             'lv.covariances'))
    all_scales_college_cor_load <- lavaan::lavaan(
        model = paste(fsmi_cfa_matestat_model, dnp_cfa_model,
                      uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog_yads,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'gender',
        group.equal = c('loadings',
                        'lv.variances',
                        'lv.covariances'))
    all_scales_college_partnered <- lavaan::lavaan(
        model = paste(fsmi_cfa_matestat_model, dnp_cfa_model,
                      uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog_yads,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'partnered', 
        group.equal = c('loadings'),
        group.partial = c('dominance_score =~ dominance_prestige_16',
                          'k_srq_sociability =~ K_SRQ_10',
                          'k_srq_admiration =~  K_SRQ_7',
                          'k_srq_sexual_relationships =~ K_SRQ_13',
                          'k_srq_sexual_relationships =~ K_SRQ_20'))
    all_scales_college_partnered_cor <- lavaan::update(all_scales_college_partnered, 
                                                       group.equal = c('loadings',
                                                                       'lv.variances',
                                                                       'lv.covariances'))
    all_scales_college_partnered_cor_load <- lavaan::lavaan(
        model = paste(fsmi_cfa_matestat_model, dnp_cfa_model,
                      uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog_yads,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'partnered',
        group.equal = c('loadings',
                        'lv.variances',
                        'lv.covariances'))
    save(all_scales_college,
         all_scales_college_cor,
         all_scales_college_cor_load,
         all_scales_college_partnered,
         all_scales_college_partnered_cor,
         all_scales_college_partnered_cor_load,
         file = latent_var_cor_collegeFN)
} else {
    load(latent_var_cor_collegeFN)
}

AIC(all_scales_college, all_scales_college_cor, all_scales_college_cor_load)

college_cor_sensitivity_gender_abs_max <- max(abs(inspect(all_scales_college_cor_load, 'cor.lv')[['0']] - 
    inspect(all_scales_college_cor, 'cor.lv')[['0']]))

AIC(all_scales_college_partnered, all_scales_college_partnered_cor, all_scales_college_partnered_cor_load)

college_cor_sensitivity_partnered_abs_max <- max(abs(inspect(all_scales_college_partnered_cor_load, 'cor.lv')[['0']] - 
    inspect(all_scales_college_partnered_cor, 'cor.lv')[['0']]))
```

```{r}
all_scales_college_par <- standardizedSolution(all_scales_college, ci = TRUE)
all_scales_college_cor_par <- standardizedSolution(all_scales_college_cor_load, ci = TRUE)

all_scales_college_cor_fit <- fitmeasures(all_scales_college_cor_load, c('rmsea', 'mfi'))



all_scales_college_cor_pardf_l <- dplyr::mutate(
    dplyr::select(
        dplyr::filter(
            all_scales_college_cor_par,
            group == 1,
            lhs %in% all_scale_latent_varnames,
            op == '~~',
            rhs %in% all_scale_latent_varnames,
            lhs != rhs | (lhs == 'fsmi_mate' & rhs == 'fsmi_mate')),
        lhs, op, rhs, group, est.std, ci.upper, ci.lower, z),
    group = 3)

all_scales_college_pardf_l <- dplyr::bind_rows(
    dplyr::select(
        dplyr::filter(
            all_scales_college_par,
            lhs %in% all_scale_latent_varnames,
            op == '~~',
            rhs %in% all_scale_latent_varnames,
            lhs != rhs),
        lhs, op, rhs, group, est.std, ci.upper, ci.lower, z),
    all_scales_college_cor_pardf_l)

all_scales_college_pardf <- dplyr::mutate(
    tidyr::spread(
        tidyr::unite(
            tidyr::gather(
                dplyr::mutate_at(
                    dplyr::filter(all_scales_college_pardf_l, group == 3),
                    dplyr::vars(lhs,rhs),
                    dplyr::funs(factor(., levels = all_scale_latent_varnames, 
                                       labels = all_scale_latent_varnames))),
                par, value, est.std, ci.upper, ci.lower, z), 
            grouppar, par, group),
        grouppar, value),
    est = sub('(-)*0\\.', '\\1.', sprintf('%.2f', est.std_3)),
    cw = gsub('(-)*0\\.', '\\1.', sprintf('[% .2f,% .2f]', ci.lower_3, ci.upper_3)))

(latent_var_cor_table <- dplyr::bind_rows(
    dplyr::select(all_scales_college_pardf, lhs, rhs, est),
    dplyr::select(
        dplyr::mutate(
            dplyr::filter(all_scales_college_pardf, lhs != rhs),
            lhs_ = lhs, lhs = rhs, rhs = lhs_, est = cw), 
        lhs, rhs, est)) %>%
        dplyr::mutate(est = ifelse(lhs == 'fsmi_mate' & rhs == 'fsmi_mate',
                                   '', est),
                      rhs = factor(sprintf('%02d. %s', as.numeric(rhs), rhs),
                                   levels = unique(sprintf('%02d. %s', as.numeric(rhs), rhs)),
                                   labels = unique(sprintf('%2d. %s', as.numeric(rhs), rhs))),
                      lhs = factor(sprintf('%02d.', as.numeric(lhs)),
                                   levels = unique(sprintf('%02d.', as.numeric(lhs))),
                                   labels = unique(sprintf('%02d.', as.numeric(lhs))))) %>%
        tidyr::spread(lhs, est)) %>%
    knitr::kable(align = c('l', rep('r', 13)))
```

```{r fig.width=10, fig.height=10}
bordergray <- '#eeeeee'
ggplot2::theme_set(ggplot2::theme_minimal())

all_scales_college_plot <- ggplot2::ggplot(
    dplyr::mutate_at(all_scales_college_pardf_l,
                     dplyr::vars(lhs,rhs),
                     funs(factor(., levels = all_scale_latent_varnames, 
                                 labels = all_scale_latent_varnames))),
    ggplot2::aes(x = factor(group, levels = 1:3, labels = c('F', 'M', '-')), 
                 y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = '#666666') + 
    ggplot2::geom_hline(yintercept = c(-1,1), color = '#999999') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0, alpha = .5) + 
    ggplot2::geom_point(size = 1.5) + 
    ggplot2::facet_grid(lhs ~ rhs, labeller = ggplot2::label_parsed) + 
    ggplot2::coord_cartesian(ylim = c(-1.1,1.1)) + 
    ggplot2::scale_y_continuous(position = 'left', breaks = c(-.5, 0, .5)) + 
    ggplot2::theme(
        # axis.text.x = ggplot2::element_blank(),
        axis.text.x = ggplot2::element_text(angle = 360-0, hjust = .5),
        panel.grid.major.x = ggplot2::element_blank(),
        panel.border = ggplot2::element_rect(fill = NA, color = bordergray, size = 1, linetype = 1),
        strip.background = ggplot2::element_rect(fill=bordergray, color = bordergray, size = 1, linetype = 1),
        strip.text.y = ggplot2::element_text(size = 8),
        axis.line.x = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        axis.line.y = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        panel.spacing = ggplot2::unit(0.0, units = 'in'), 
        plot.margin = ggplot2::margin(2,2,0,2),
        axis.title.x = ggplot2::element_text(margin = ggplot2::margin(0,0,0,0))
        ) + 
    ggplot2::labs(x = '', y = 'Standardized estimate and 95% confidence interval',
                  shape = 'Gender')
all_scales_college_plot
```

### Correlations with SPLT outcomes

```{r}
data("splt_rl_betas")
data("splt_lowfi_outcomes")
splt_rl_betas <- dplyr::mutate(
    splt_rl_betas,
    mean = dplyr::case_when(
        parameter %in% c('ep_prm', 'xi_prm') & !contrasted ~ qnorm(mean),
        parameter %in% c('rho_prm') & !contrasted ~ log(mean),
        TRUE ~ mean))

splt_lowfi_outcomes <- dplyr::mutate(
    splt_lowfi_outcomes,
    value = dplyr::case_when(
        !grepl(' - Hungry/Thirsty', condition) & grepl('bin', outcome) ~ qnorm(value-.001),
        TRUE ~ value))

splt_rl_betas_w <- tidyr::spread(
    tidyr::unite(
        dplyr::mutate(
            dplyr::filter(
                dplyr::select(splt_rl_betas, mean, parameter, condition, id),
                condition != 'Hungry/Thirsty - Hungry/Thirsty'),
            condition = gsub('[- /]', '', abbreviate(condition, minlength = 12))),
        parcond, parameter, condition),
    parcond, mean)

splt_lowfi_outcomes_w <- tidyr::spread(
    tidyr::unite(
        dplyr::mutate(
            dplyr::filter(
                dplyr::select(
                    dplyr::ungroup(splt_lowfi_outcomes), 
                    value, outcome, condition, id),
                condition != 'Hungry/Thirsty - Hungry/Thirsty',
                outcome %in% c('bin_start_to_4', 'bin_5_to_end')),
            condition = gsub('[- /]', '', abbreviate(condition, minlength = 12))),
        parcond, outcome, condition),
    parcond, value)


splt_fsmi_devdemog_yads_betas <- dplyr::left_join(
    dplyr::left_join(splt_fsmi_devdemog_yads,
                     splt_rl_betas_w, 
                     by = c('SID' = 'id')),
    splt_lowfi_outcomes_w,
    by = c('SID' = 'id'))

rl_var_names <- lapply(c('^ep_prm_', '^rho_prm_', '^xi_prm_', '^b_', 
                         '^bin_start_to_4_', 'bin_5_to_end_'),
                       function(betapattern){
                           varnames <- grep(betapattern, 
                                            names(splt_fsmi_devdemog_yads_betas),
                                            value = T)
                           return(varnames)
                       })

rl_var_names_facts <- lapply(rl_var_names, 
                             function(varnames){
                                 paste(paste0(paste0(varnames, '_fac'),
                                              '=~', varnames),
                                       collapse = '\n')
                                 })
latent_var_splt_cor_collegeFN <-
    file.path(data_dir, 'latent_var_splt_cor-college.RDS')
library(future)
library(listenv)
future::plan(multiprocess)
all_scales_college_cor_load_splt_le <- listenv()
if(!file.exists(latent_var_splt_cor_collegeFN)){
    for(i in seq_along(rl_var_names_facts)){
        all_scales_college_cor_load_splt_le[[i]] <- 
            future(lavaan::lavaan(
                model = paste(fsmi_cfa_matestat_model, dnp_cfa_model,
                              uppsp_cfa_model, ksrq_model, 
                              rl_var_names_facts[[i]], 
                              sep = '\n'),
                data = splt_fsmi_devdemog_yads_betas,
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = TRUE, std.lv = FALSE, 
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE,
                group = 'gender',
                group.equal = c('loadings',
                                'lv.variances',
                                'lv.covariances'),
                verbose = F))
    }
    all_scales_college_cor_load_splt <- as.list(
        lapply(all_scales_college_cor_load_splt_le, future::value)
    )
    saveRDS(all_scales_college_cor_load_splt, latent_var_splt_cor_collegeFN)
} else {
    all_scales_college_cor_load_splt <- readRDS(latent_var_splt_cor_collegeFN)
}

#NOTE: the parameter 'b' models did not converge
```

```{r fig.width=3.25, fig.height=2}
ggplot2::theme_set(ggplot2::theme_minimal())

scale_splt_cor_df_collegeFN <- file.path(data_dir, 'scale_splt_cor_df_college.RDS')
if(!file.exists(scale_splt_cor_df_collegeFN)){
    scale_splt_cor_df_college_f <- lapply(
        all_scales_college_cor_load_splt, 
        function(amod){ 
            return(future({
                thing <- standardizedSolution(amod, ci = TRUE)
                thing_l <- dplyr::mutate(
                    dplyr::select(
                        dplyr::filter(
                            thing,
                            group == 1,
                            lhs %in% all_scale_latent_varnames,
                            op == '~~',
                            rhs %in% paste0(unlist(rl_var_names), '_fac')),
                        lhs, op, rhs, group, est.std, ci.upper, ci.lower, z),
                    group = 3)
                thing_l
            }))
        })
    scale_splt_cor_df_college <- do.call(rbind,
                                         lapply(scale_splt_cor_df_college_f,
                                                future::value))
    saveRDS(scale_splt_cor_df_college, scale_splt_cor_df_collegeFN)
} else {
    scale_splt_cor_df_college <- readRDS(scale_splt_cor_df_collegeFN)
}
```

```{r fig.width=5.875, fig.height=4}
splt_param_labels <- c(
    ep_prm_DtngLHngT_fac = expression(epsilon[dating]),
    rho_prm_DtngLHngT_fac = expression(rho[dating]),
    xi_prm_DtngLHngT_fac = expression(xi[dating]),
    b_DtngLHngT_fac = expression(b[dating]),
    bin_start_to_4_DtngLHngT_fac = expression(paste('First ',1/2)[dating]),
    bin_5_to_end_DtngLHngT_fac = expression(paste('Last ',1/2)[dating]),
    ep_prm_PplrUHngT_fac = expression(epsilon[popular]),
    rho_prm_PplrUHngT_fac = expression(rho[popular]),
    xi_prm_PplrUHngT_fac = expression(xi[popular]),
    b_PplrUHngT_fac = expression(b[popular]),
    bin_start_to_4_PplrUHngT_fac = expression(paste('First ',1/2)[popular]),
    bin_5_to_end_PplrUHngT_fac = expression(paste('Last ',1/2)[popular]),
    ep_prm_HngryThrsty_fac = expression(epsilon[baseline]),
    rho_prm_HngryThrsty_fac = expression(rho[baseline]),
    xi_prm_HngryThrsty_fac = expression(xi[baseline]),
    b_HngryThrsty_fac = expression(b[baseline]),
    bin_start_to_4_HngryThrsty_fac = expression(paste('First ',1/2)[baseline]),
    bin_5_to_end_HngryThrsty_fac = expression(paste('Last ',1/2)[baseline])
)
scale_labels_ordered <- rev(scale_labels[c(1,12,13,2,10,3,4,8,5,9,6,7,11)])
scale_splt_cor_df_college_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_college,
            grepl('HngT_fac$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered), 
                     labels = names(scale_labels_ordered)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0) + 
    ggplot2::geom_point(size = 1) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, -.2, .2, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 2, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank()) + 
    ggplot2::labs(y = 'Correlation with latent variable') + 
    ggplot2::coord_flip(ylim = c(-.55, .55))
print(scale_splt_cor_df_college_plot)
```

```{r fig.width=5.875, fig.height=2}
scale_splt_cor_df_baseline_college_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_college,
            grepl('HngryThrsty_fac$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered), 
                     labels = names(scale_labels_ordered)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0) + 
    ggplot2::geom_point(size = 1) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, -.2, .2, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 1, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank()) + 
    ggplot2::labs(y = 'Correlation with latent variable') + 
    ggplot2::coord_flip(ylim = c(-.55, .55))
print(scale_splt_cor_df_baseline_college_plot)
```

## College and adolescent samples

```{r}
# ksrq_cfa_metric_cov <- lavaan::lavaan(model = ksrq_model, data = splt_fsmi_devdemog,
#                                       missing = 'fiml', estimator = 'ML',
#                                       int.ov.free = TRUE, int.lv.free = FALSE, 
#                                       auto.fix.first = TRUE, std.lv = FALSE, 
#                                       auto.fix.single = TRUE, auto.var = TRUE, 
#                                       auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                       auto.delta = TRUE, auto.cov.y = TRUE,
#                                       group = 'sample', group.equal = c('loadings',
#                                                                         'lv.variances',
#                                                                         'lv.covariances'),
#                                       group.partial = c('k_srq_sociability =~ K_SRQ_10',
#                                                         'k_srq_admiration =~  K_SRQ_7',
#                                                         'k_srq_sexual_relationships =~ K_SRQ_13',
#                                                         'k_srq_sexual_relationships =~ K_SRQ_20'))
# uppsp_cfa_metric_cov <- lavaan::lavaan(model = uppsp_cfa_model, data = splt_fsmi_devdemog,
#                                        missing = 'fiml', estimator = 'ML',
#                                        int.ov.free = TRUE, int.lv.free = FALSE, 
#                                        auto.fix.first = TRUE, std.lv = FALSE, 
#                                        auto.fix.single = TRUE, auto.var = TRUE, 
#                                        auto.cov.lv.x = TRUE, auto.th = TRUE, 
#                                        auto.delta = TRUE, auto.cov.y = TRUE,
#                                        group = 'samplegroup', group.equal = c('loadings',
#                                                                               'lv.variances',
#                                                                               'lv.covariances'))

latent_var_cor_adolFN <-
    file.path(data_dir, 'latent_var_cor-adol.rda')
if(!file.exists(latent_var_cor_adolFN)){
    all_scales_adol <- lavaan::lavaan(
        model = paste(uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'sample', 
        group.equal = c('loadings'),
        group.partial = c('k_srq_sociability =~ K_SRQ_10',
                          'k_srq_admiration =~  K_SRQ_7',
                          'k_srq_sexual_relationships =~ K_SRQ_13',
                          'k_srq_sexual_relationships =~ K_SRQ_20'))
    all_scales_adol_cor <- lavaan::update(all_scales_adol, 
                                          group.equal = c('loadings',
                                                          'lv.variances',
                                                          'lv.covariances'))
    all_scales_adol_cor_load <- lavaan::lavaan(
        model = paste(uppsp_cfa_model, ksrq_model, sep = '\n'),
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = TRUE, std.lv = FALSE, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'sample',
        group.equal = c('loadings',
                        'lv.variances',
                        'lv.covariances'))
    save(all_scales_adol,
         all_scales_adol_cor,
         all_scales_adol_cor_load, file = latent_var_cor_adolFN)
} else {
    load(latent_var_cor_adolFN)
}

AIC(all_scales_adol, all_scales_adol_cor, all_scales_adol_cor_load)
anova(all_scales_adol, all_scales_adol_cor, all_scales_adol_cor_load)

adol_cor_sensitivity_abs_max <- max(abs(inspect(all_scales_adol_cor_load, 'cor.lv')[[1]] - 
    inspect(all_scales_adol_cor, 'cor.lv')[[1]]))
```

```{r}
all_scales_adol_par <- standardizedSolution(all_scales_adol, ci = TRUE)
all_scales_adol_cor_par <- standardizedSolution(all_scales_adol_cor_load, ci = TRUE)
```

```{r}
all_scale_latent_varnames <- unlist(c(names(upps_key),
                                      scales_to_use_ksrq))

all_scales_adol_cor_pardf_l <- dplyr::mutate(
    dplyr::select(
        dplyr::filter(
            all_scales_adol_cor_par,
            group == 1,
            lhs %in% all_scale_latent_varnames,
            op == '~~',
            rhs %in% all_scale_latent_varnames,
            lhs != rhs | (lhs == all_scale_latent_varnames[1] & rhs == all_scale_latent_varnames[1])),
        lhs, op, rhs, group, est.std, ci.upper, ci.lower, z),
    group = 5)

all_scales_adol_pardf_l <- dplyr::bind_rows(
    dplyr::select(
        dplyr::filter(
            all_scales_adol_par,
            lhs %in% all_scale_latent_varnames,
            op == '~~',
            rhs %in% all_scale_latent_varnames,
            lhs != rhs),
        lhs, op, rhs, group, est.std, ci.upper, ci.lower, z),
    all_scales_adol_cor_pardf_l)

all_scales_adol_pardf <- dplyr::mutate(
    tidyr::spread(
        tidyr::unite(
            tidyr::gather(
                dplyr::mutate_at(
                    dplyr::filter(all_scales_adol_pardf_l, group == 5),
                    dplyr::vars(lhs,rhs),
                    dplyr::funs(factor(., levels = all_scale_latent_varnames, 
                                       labels = all_scale_latent_varnames))),
                par, value, est.std, ci.upper, ci.lower, z), 
            grouppar, par, group),
        grouppar, value),
    est = sub('(-)*0\\.', '\\1.', sprintf('%.2f', est.std_5)),
    cw = gsub('(-)*0\\.', '\\1.', sprintf('[% .2f,% .2f]', ci.lower_5, ci.upper_5)))

(latent_var_cor_table_adol <- dplyr::bind_rows(
    dplyr::select(all_scales_adol_pardf, lhs, rhs, est),
    dplyr::select(
        dplyr::mutate(
            dplyr::filter(all_scales_adol_pardf, lhs != rhs),
            lhs_ = lhs, lhs = rhs, rhs = lhs_, est = cw), 
        lhs, rhs, est)) %>%
        dplyr::mutate(est = ifelse(lhs == all_scale_latent_varnames[1] & rhs == all_scale_latent_varnames[1],
                                   '', est),
                      rhs = factor(sprintf('%02d. %s', as.numeric(rhs), rhs),
                                   levels = unique(sprintf('%02d. %s', as.numeric(rhs), rhs)),
                                   labels = unique(sprintf('%2d. %s', as.numeric(rhs), rhs))),
                      lhs = factor(sprintf('%02d.', as.numeric(lhs)),
                                   levels = unique(sprintf('%02d.', as.numeric(lhs))),
                                   labels = unique(sprintf('%02d.', as.numeric(lhs))))) %>%
        tidyr::spread(lhs, est)) %>%
    knitr::kable(align = c('l', rep('r', 13)))
```

```{r fig.width=5.875, fig.height=7.75}
bordergray <- '#eeeeee'
ggplot2::theme_set(ggplot2::theme_minimal())

group_labels <- c(
    'yads_online' = 'CSYA-O',
    'yads' = 'CSYA',
    'TDS2' = 'CA',
    'TDS1' = 'FCA'
)[inspect(all_scales_adol_cor_load, 'group.label')]

scale_labels_char <- as.character(scale_labels)[5:13]
names(scale_labels_char) <- names(scale_labels)[5:13]

scale_labels_char_lhs <- paste0('paste("', 1:length(scale_labels_char), '. ',
                                sub('paste\\("', '', scale_labels_char))
names(scale_labels_char_lhs) <- names(scale_labels)[5:13]

scale_labels_char_rhs <- c(
    paste0(1:(length(scale_labels_char)-1), '.'),
    scale_labels_char[length(scale_labels_char)])
names(scale_labels_char_rhs) <- names(scale_labels)[5:13]

all_scales_adol_plot <- ggplot2::ggplot(
    dplyr::mutate_at(
        dplyr::filter(all_scales_adol_pardf_l,
                      rhs != 'neg_urgency'),
        dplyr::vars(lhs,rhs),
        funs(factor(., levels = all_scale_latent_varnames, 
                    labels = all_scale_latent_varnames))),
    ggplot2::aes(x = factor(group, levels = c(5, 1:4), labels = c('All', group_labels)), 
                 y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = '#666666') + 
    ggplot2::geom_hline(yintercept = c(-1,1), color = '#999999') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0, alpha = .5) + 
    ggplot2::geom_point(size = 1.5) + 
    ggplot2::facet_grid(lhs ~ rhs, 
                        labeller = ggplot2::labeller(
                            lhs = ggplot2::as_labeller(scale_labels_char_lhs,
                                                       default = ggplot2::label_parsed),
                            rhs = ggplot2::as_labeller(scale_labels_char_rhs,
                                                       default = ggplot2::label_parsed))) + 
    ggplot2::coord_cartesian(ylim = c(-1.1,1.1)) + 
    ggplot2::scale_y_continuous(position = 'left', breaks = c(-.5, 0, .5)) + 
    ggplot2::theme(
        # axis.text.x = ggplot2::element_blank(),
        axis.text.x = ggplot2::element_text(angle = 360-65, hjust = 0),
        panel.grid.major.x = ggplot2::element_blank(),
        panel.border = ggplot2::element_rect(fill = NA, color = bordergray, size = 1, linetype = 1),
        strip.background = ggplot2::element_rect(fill=bordergray, color = bordergray, size = 1, linetype = 1),
        strip.text.y = ggplot2::element_text(size = 8),
        axis.line.x = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        axis.line.y = ggplot2::element_line(color = NA, size = .5, linetype = 1),
        panel.spacing = ggplot2::unit(0.0, units = 'in'), 
        plot.margin = ggplot2::margin(2,2,0,2),
        axis.title.x = ggplot2::element_text(margin = ggplot2::margin(0,0,0,0))
        ) + 
    ggplot2::labs(x = '', y = 'Standardized estimate and 95% confidence interval',
                  shape = 'Gender')
all_scales_adol_plot
```

### Correlations with SPLT outcomes

```{r}

#Get correlations with samples combined

splt_fsmi_devdemog_betas <- dplyr::left_join(
    dplyr::left_join(splt_fsmi_devdemog,
                     splt_rl_betas_w, 
                     by = c('SID' = 'id')),
    splt_lowfi_outcomes_w,
    by = c('SID' = 'id'))

latent_var_splt_cor_combinedFN <-
    file.path(data_dir, 'latent_var_splt_cor-combined.RDS')
library(future)
library(listenv)
future::plan(multiprocess)
all_scales_combined_cor_load_splt_le <- listenv()
if(!file.exists(latent_var_splt_cor_combinedFN)){
    for(i in seq_along(rl_var_names_facts)){
        all_scales_combined_cor_load_splt_le[[i]] <- 
            future(lavaan::lavaan(
                model = paste(uppsp_cfa_model, ksrq_model, 
                              rl_var_names_facts[[i]], 
                              sep = '\n'),
                data = splt_fsmi_devdemog_betas,
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = TRUE, std.lv = FALSE, 
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE,
                group = 'sample',
                group.equal = c('loadings',
                                'lv.variances',
                                'lv.covariances'),
                verbose = F))
    }
    all_scales_combined_cor_load_splt <- as.list(
        lapply(all_scales_combined_cor_load_splt_le, future::value)
    )
    saveRDS(all_scales_combined_cor_load_splt, latent_var_splt_cor_combinedFN)
} else {
    all_scales_combined_cor_load_splt <- readRDS(latent_var_splt_cor_combinedFN)
}
```

```{r}
#Get correlations for each sample

latent_var_splt_cor_combined_persampFN <-
    file.path(data_dir, 'latent_var_splt_cor-combined_persamp.RDS')
library(future)
library(listenv)
future::plan(multiprocess)
all_scales_combined_persamp_cor_load_splt_le <- listenv()
if(!file.exists(latent_var_splt_cor_combined_persampFN)){
    for(i in seq_along(rl_var_names_facts)){
        all_scales_combined_persamp_cor_load_splt_le[[i]] <- 
            future(lavaan::lavaan(
                model = paste(uppsp_cfa_model, ksrq_model, 
                              rl_var_names_facts[[i]], 
                              sep = '\n'),
                data = splt_fsmi_devdemog_betas,
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = TRUE, std.lv = FALSE, 
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE,
                group = 'sample',
                group.equal = c('loadings'),
                verbose = F))
    }
    all_scales_combined_persamp_cor_load_splt <- as.list(
        lapply(all_scales_combined_persamp_cor_load_splt_le, future::value)
    )
    saveRDS(all_scales_combined_persamp_cor_load_splt, latent_var_splt_cor_combined_persampFN)
} else {
    all_scales_combined_persamp_cor_load_splt <- readRDS(latent_var_splt_cor_combined_persampFN)
}
```

```{r}
#get the standardized estiamtes for the combined sample
scale_splt_cor_df_combinedFN <- file.path(data_dir,
                                                  'scale_splt_cor_df_combined.RDS')
if(!file.exists(scale_splt_cor_df_combinedFN)){
    scale_splt_cor_df_combined_f <- lapply(
        all_scales_combined_cor_load_splt, 
        function(amod){ 
            return(future({
                thing <- standardizedSolution(amod, ci = TRUE)
                thing_l <- dplyr::select(
                    dplyr::filter(
                        thing,
                        lhs %in% all_scale_latent_varnames,
                        op == '~~',
                        rhs %in% paste0(unlist(rl_var_names), '_fac')),
                    lhs, op, rhs, group, est.std, ci.upper, ci.lower, z)
                thing_l
            }))
        })
    scale_splt_cor_df_combined <- do.call(rbind,
                                         lapply(scale_splt_cor_df_combined_f,
                                                future::value))
    saveRDS(scale_splt_cor_df_combined, scale_splt_cor_df_combinedFN)
} else {
    scale_splt_cor_df_combined <- readRDS(scale_splt_cor_df_combinedFN)
}
```

```{r}
#get the standardized estiamtes for each sample
scale_splt_cor_df_combined_persampFN <- file.path(data_dir,
                                                  'scale_splt_cor_df_combined_persamp.RDS')
if(!file.exists(scale_splt_cor_df_combined_persampFN)){
    scale_splt_cor_df_combined_persamp_f <- lapply(
        all_scales_combined_persamp_cor_load_splt, 
        function(amod){ 
            return(future({
                thing <- standardizedSolution(amod, ci = TRUE)
                thing_l <- dplyr::select(
                    dplyr::filter(
                        thing,
                        lhs %in% all_scale_latent_varnames,
                        op == '~~',
                        rhs %in% paste0(unlist(rl_var_names), '_fac')),
                    lhs, op, rhs, group, est.std, ci.upper, ci.lower, z)
                thing_l
            }))
        })
    scale_splt_cor_df_combined_persamp <- do.call(rbind,
                                         lapply(scale_splt_cor_df_combined_persamp_f,
                                                future::value))
    saveRDS(scale_splt_cor_df_combined_persamp, scale_splt_cor_df_combined_persampFN)
} else {
    scale_splt_cor_df_combined_persamp <- readRDS(scale_splt_cor_df_combined_persampFN)
}
```

```{r fig.width=5.875, fig.height=3.5}
ggplot2::theme_set(ggplot2::theme_minimal())
scale_labels_ordered_combined <- rev(scale_labels[c(12,13,10,8,5,9,6,7,11)])
scale_splt_cor_df_combined_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_combined,
            grepl('HngT_fac$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered_combined), 
                     labels = names(scale_labels_ordered_combined)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0) + 
    ggplot2::geom_point(size = 1) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, -.2, .2, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 2, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank()) + 
    ggplot2::labs(y = 'Correlation with latent variable') + 
    ggplot2::coord_flip(ylim = c(-.55, .55))
print(scale_splt_cor_df_combined_plot)
```

```{r fig.width=5.875, fig.height=2}
scale_splt_cor_df_baseline_combined_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_combined,
            grepl('HngryThrsty_fac$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered_combined), 
                     labels = names(scale_labels_ordered_combined)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std)) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0) + 
    ggplot2::geom_point(size = 1) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, -.2, .2, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 1, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank()) + 
    ggplot2::labs(y = 'Correlation with latent variable') + 
    ggplot2::coord_flip(ylim = c(-.55, .55))
print(scale_splt_cor_df_baseline_combined_plot)
```

```{r fig.width=5.875, fig.height=6}
scale_splt_cor_position <- ggplot2::position_dodge(width = .75)
scale_splt_cor_df_combined_persamp_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_combined_persamp,
            grepl('HngT_fac$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered_combined), 
                     labels = names(scale_labels_ordered_combined)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std, 
                 shape = factor(group, levels = 1:4, labels = group_labels))) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        position = scale_splt_cor_position, 
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0, alpha = .5) + 
    ggplot2::geom_point(position = scale_splt_cor_position, size = 1.25) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, 0, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 2, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank(),
                   legend.position = 'bottom') + 
    ggplot2::labs(y = 'Correlation with 95% confidence interval', 
                  shape = 'Sample') + 
    ggplot2::coord_flip(ylim = c(-.75, .75))
print(scale_splt_cor_df_combined_persamp_plot)
```

```{r fig.width=5.875, fig.height=4}
scale_splt_cor_position <- ggplot2::position_dodge(width = .75)
scale_splt_cor_df_baseline_combined_persamp_plot <- ggplot2::ggplot(
    dplyr::mutate(
        dplyr::filter(
            scale_splt_cor_df_combined_persamp,
            grepl('HngryThrsty_fac$$', rhs),
            !grepl('^b_', rhs)),
        lhs = factor(lhs, levels = names(scale_labels_ordered_combined), 
                     labels = names(scale_labels_ordered_combined)),
        rhs = factor(rhs, levels = names(splt_param_labels), 
                     labels = splt_param_labels)),
    ggplot2::aes(x = lhs, y = est.std, 
                 shape = factor(group, levels = 1:4, labels = group_labels))) + 
    ggplot2::geom_hline(yintercept = 0, color = 'gray') + 
    ggplot2::geom_errorbar(
        position = scale_splt_cor_position, 
        ggplot2::aes(ymin = ci.lower, ymax = ci.upper),
        width = 0, alpha = .5) + 
    ggplot2::geom_point(position = scale_splt_cor_position, size = 1.25) + 
    ggplot2::scale_x_discrete(labels = scale_labels, breaks = names(scale_labels)) + 
    ggplot2::scale_y_continuous(breaks = c(-.5, 0, .5)) + 
    ggplot2::facet_wrap(~rhs, nrow = 1, labeller = ggplot2::label_parsed) + 
    ggplot2::theme(axis.title.y = ggplot2::element_blank(), 
                   panel.grid.minor = ggplot2::element_blank(),
                   legend.position = 'bottom') + 
    ggplot2::labs(y = 'Correlation with 95% confidence interval', 
                  shape = 'Sample') + 
    ggplot2::coord_flip(ylim = c(-.75, .75))
print(scale_splt_cor_df_baseline_combined_persamp_plot)
```

# Associations with motive-relevant behavior

The number of partners and frequency of sex is expected to be different between those who are in or not in long-term relationships.

```{r}
ggplot2::theme_set(ggplot2::theme_minimal())


table(splt_fsmi_devdemog$ordered_sex_freq, splt_fsmi_devdemog$sample, useNA = 'ifany')
table(splt_fsmi_devdemog$ordered_num_partner, splt_fsmi_devdemog$sample, useNA = 'ifany')
```

```{r sesfsmiplot, fig.width=5.875, fig.height=3}
sesdescplot_hjust <- 0
sex_freq_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_sex_freq) & 
                                  !is.na(splt_fsmi_devdemog$partnered) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_sex_freq,
                 fill = as.factor(partnered))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), alpha = 1) +
    ggplot2::theme(legend.position = 'none') + 
    ggplot2::labs(title = 'College students', y = 'Count', x = '') +
    ggplot2::coord_cartesian(ylim = c(0,60)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))

num_partnr_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_num_partner) & 
                                  !is.na(splt_fsmi_devdemog$partnered) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_num_partner,
                 fill = factor(partnered, levels = c(0,1), labels = c('No', 'Yes')))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), alpha = 1) + 
    ggplot2::labs(title = '', y = '', x = '') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                   axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust)) +
    ggplot2::coord_cartesian(ylim = c(0,60))

sex_freq_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_sex_freq) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_sex_freq)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) +
    # ggplot2::scale_x_discrete(breaks = c('0', '1-9', '10-19', '20-39', '40 or more')) + 
    ggplot2::labs(title = 'Adolescents', y = 'Count', x = 'Number of sexual encounters') +
    ggplot2::coord_cartesian(ylim = c(0,60), xlim = c(1,5)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))

num_partnr_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_num_partner) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_num_partner)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) + 
    ggplot2::labs(title = '', y = '', x = 'Number of partners') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                   axis.text.x = ggplot2::element_text(hjust = 0),
                   plot.margin = ggplot2::margin(.2,2.25,.1,.2, unit = 'cm'),
                   legend.position = 'right') +
    ggplot2::coord_cartesian(ylim = c(0,60), xlim = c(1,4)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))
# c('0', '1-9', '10-19', '20-39', '40 or more')
# c(0:2, '3 or more')
gridExtra::grid.arrange(sex_freq_plot, num_partnr_plot, sex_freq_plot_tds, 
                        num_partnr_plot_tds, nrow = 2, widths = c(4,3))
```

```{r drinky, fig.width=5.875, fig.height=3}
sesdescplot_hjust <- 0
alc_freq_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$alcohol_days_of_lst30) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = alcohol_days_of_lst30)) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            fill = ggsci::pal_rickandmorty()(8)[2], alpha = 1) +
    ggplot2::theme(legend.position = 'none') + 
    ggplot2::labs(title = 'College students', y = 'Count', x = '') +
    ggplot2::coord_cartesian(ylim = c(0,100)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))

alc5_partnr_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$alcohol_5drnks_lst30) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = alcohol_5drnks_lst30)) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            fill = ggsci::pal_rickandmorty()(8)[2], alpha = 1) + 
    ggplot2::labs(title = '', y = '', x = '') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                   axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust),
                   plot.margin = ggplot2::margin(.2,1,.2,.2, unit = 'cm')) +
    ggplot2::coord_cartesian(ylim = c(0,100))
alc_freq_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$alcohol_days_of_lst30) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = alcohol_days_of_lst30)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) +
    ggplot2::scale_x_discrete(drop=FALSE) + 
    ggplot2::labs(title = 'Adolescents', y = 'Count', x = 'Number of days with at least one drink') +
    ggplot2::coord_cartesian(ylim = c(0,100), xlim = c(1,5)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))

alc5_partnr_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$alcohol_5drnks_lst30) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = alcohol_5drnks_lst30)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) + 
    ggplot2::labs(title = '', y = '', x = 'Number of days with 5+ drinks') + 
    ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                   axis.text.x = ggplot2::element_text(hjust = 0),
                   plot.margin = ggplot2::margin(.2,1,.2,.2, unit = 'cm'),
                   legend.position = 'right') +
    ggplot2::scale_x_discrete(drop=FALSE) + 
    ggplot2::coord_cartesian(ylim = c(0,100), xlim = c(1,4)) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = sesdescplot_hjust))
# c('0', '1-9', '10-19', '20-39', '40 or more')
# c(0:2, '3 or more')
gridExtra::grid.arrange(alc_freq_plot, alc5_partnr_plot, alc_freq_plot_tds, 
                        alc5_partnr_plot_tds, nrow = 2, widths = c(4,3))
save_out_list <- c(save_out_list, 'sex_freq_plot', 'num_partnr_plot')
```

```{r useprot, fig.width=5.875, fig.height=2.5}
useprot_hjust <- .5
useprot_freq_plot <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_use_protection) & 
                                  !is.na(splt_fsmi_devdemog$partnered) & 
                                  grepl('yads', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_use_protection,
                 fill = factor(partnered, levels = c(0,1), labels = c('No', 'Yes')))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), alpha = 1) +
    ggplot2::theme(legend.position = 'right') + 
    ggplot2::labs(title = 'College students', y = 'Count', x = 'Frequency of safe sex practice') +
    ggplot2::coord_flip(ylim = c(0,35)) +
    ggplot2::scale_x_discrete(drop = FALSE) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = useprot_hjust))

useprot_plot_tds <- ggplot2::ggplot(
    data = splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$ordered_use_protection) & 
                                  grepl('TDS', splt_fsmi_devdemog$sample),],
    ggplot2::aes(x = ordered_use_protection)) + 
    ggplot2::geom_histogram(stat = 'count',
                            position = ggplot2::position_dodge(), 
                            alpha = 1,
                            fill = ggsci::pal_rickandmorty()(8)[2], 
                            width = .5) +
    # ggplot2::scale_x_discrete(breaks = c('0', '1-9', '10-19', '20-39', '40 or more')) + 
    ggplot2::labs(title = 'Adolescents', y = 'Count', x = '') +
    ggplot2::coord_flip(ylim = c(0,35), xlim = c(1,7)) + 
    ggplot2::scale_x_discrete(drop = FALSE) + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = useprot_hjust),
                   # plot.margin = ggplot2::margin(.2,.2,1.65,.2, unit = 'cm'),
                   axis.text.y = ggplot2::element_blank())

gridExtra::grid.arrange(useprot_freq_plot, useprot_plot_tds, nrow = 1, widths = c(2.4,1))
```

```{r fig.width=3.25, fig.height=2}
ltr_fsmi_data <- splt_fsmi_devdemog[!is.na(splt_fsmi_devdemog$partnered) & 
                                        grepl('yads', splt_fsmi_devdemog$sample),] %>%
    dplyr::select(partnered, SID,
                  unlist(milav::get_items_from_keys(fsmi_key$fsmi_mate)))
ltr_fsmi_data_scored <- dplyr::bind_cols(
    fsmi_mate = psych::scoreItems(fsmi_key['fsmi_mate'], items = ltr_fsmi_data, 
                      missing = T, impute = 'none')$scores,
    ltr_fsmi_data)

ltr_fsmi <- ggplot2::ggplot(
    data = ltr_fsmi_data_scored,
    ggplot2::aes(x = fsmi_mate,
                 fill = factor(partnered, levels = c(0,1), labels = c('No', 'Yes')))) + 
    ggplot2::scale_fill_manual(values = ggsci::pal_rickandmorty()(8)[c(7,8)], name = 'LTR?') + 
    ggplot2::geom_histogram(binwidth = 1, alpha = .7, 
                            color = 'black', position = ggplot2::position_identity()) +
    ggplot2::theme(legend.position = 'right') + 
    ggplot2::scale_x_continuous(breaks = c(1,4,7)) + 
    ggplot2::labs(y = 'Count', x = 'FSMI Mate-seeking item mean') +
    ggplot2::theme(axis.text.x = ggplot2::element_text(hjust = useprot_hjust))
print(ltr_fsmi)
```

## Number of partners

### FSMI mate seeking

```{r fig.width=4, fig.height=4}
fsmi_num_partners_model <- paste(fsmi_cfa_matestat_model, 
                                 'ordered_num_partner ~ fsmi_mate + gender_c', sep = '\n')

fsmi_num_partners_null_model <- paste(fsmi_cfa_matestat_model, 
                                      'ordered_num_partner ~ 0*fsmi_mate + gender_c', sep = '\n')

sensseek_urgency_cfa <- milav::create_cfa_from_keylist(
    upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])

uppsp_fsmi_partners_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_partners_noupps_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'ordered_num_partner ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
     sep = '\n')

uppsp_fsmi_partners_nofsmi_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + 0*fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_partners_nopurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_num_partner ~ neg_urgency + sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_partners_nonurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_num_partner ~ 0*neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_partners_noss_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_num_partner ~ neg_urgency + 0*sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_partners_null_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'ordered_num_partner ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + 0*fsmi_mate + gender_c',
     sep = '\n')

fsmi_num_partners_modelsFN <- file.path(data_dir, 'fsmi_num_partners_models.rda')
if(!file.exists(fsmi_num_partners_modelsFN)){
    
    fsmi_num_partners_sem <- lavaan::lavaan(
        model = fsmi_num_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_num_partners_null_sem <- lavaan::lavaan(
        model = fsmi_num_partners_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_num_partners_all_sem <- lavaan::lavaan(
        model = fsmi_num_partners_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_num_partners_null_all_sem <- lavaan::lavaan(
        model = fsmi_num_partners_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_all_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_noupps_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_nofsmi_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_nopurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_nopurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_nonurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_nonurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_noss_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_noss_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_partners_null_sem <- lavaan::lavaan(
        model = uppsp_fsmi_partners_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_num_partners_lrt <- lavaan::lavTestLRT(fsmi_num_partners_sem,
                                                fsmi_num_partners_null_sem)
    fsmi_num_partners_all_lrt <- lavaan::lavTestLRT(fsmi_num_partners_all_sem,
                                                    fsmi_num_partners_null_all_sem)
    
    uppsp_fsmi_partners_lrt <- lavaan::lavTestLRT(uppsp_fsmi_partners_sem,
                                                  uppsp_fsmi_partners_noupps_sem,
                                                  uppsp_fsmi_partners_null_sem)
    
    uppsp_fsmi_partners_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_partners_sem,
                                                   uppsp_fsmi_partners_nofsmi_sem,
                                                   uppsp_fsmi_partners_null_sem)
    
    uppsp_fsmi_partners_lrtpurg <- lavaan::lavTestLRT(uppsp_fsmi_partners_sem,
                                                   uppsp_fsmi_partners_nopurg_sem,
                                                   uppsp_fsmi_partners_null_sem)
    
    uppsp_fsmi_partners_lrtnurg <- lavaan::lavTestLRT(uppsp_fsmi_partners_sem,
                                                   uppsp_fsmi_partners_nonurg_sem,
                                                   uppsp_fsmi_partners_null_sem)
    
    uppsp_fsmi_partners_lrtss <- lavaan::lavTestLRT(uppsp_fsmi_partners_sem,
                                                   uppsp_fsmi_partners_noss_sem,
                                                   uppsp_fsmi_partners_null_sem)
    
    save(fsmi_num_partners_sem,
         fsmi_num_partners_all_sem,
         fsmi_num_partners_lrt,
         fsmi_num_partners_sem,
         fsmi_num_partners_null_sem,
         fsmi_num_partners_all_lrt,
         fsmi_num_partners_all_sem,
         fsmi_num_partners_null_all_sem,
         uppsp_fsmi_partners_sem,
         uppsp_fsmi_partners_all_sem,
         uppsp_fsmi_partners_noupps_sem,
         uppsp_fsmi_partners_nofsmi_sem,
         uppsp_fsmi_partners_nopurg_sem,
         uppsp_fsmi_partners_nonurg_sem,
         uppsp_fsmi_partners_noss_sem,
         uppsp_fsmi_partners_null_sem,
         uppsp_fsmi_partners_lrt,
         uppsp_fsmi_partners_lrt2,
         uppsp_fsmi_partners_lrtpurg,
         uppsp_fsmi_partners_lrtnurg,
         uppsp_fsmi_partners_lrtss,
         file = fsmi_num_partners_modelsFN)
} else {
    load(fsmi_num_partners_modelsFN)
}


fsmi_num_partners_sem_pred <- lavaan::lavPredict(fsmi_num_partners_sem)
fsmi_num_partners_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_num_partners_sem_partners <- fsmi_num_partners_sem_partners_[fsmi_num_partners_sem@Data@case.idx[[1]]]

fsmi_num_partners_all_sem_pred <- lavaan::lavPredict(fsmi_num_partners_all_sem)
fsmi_num_partners_all_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_num_partners_all_sem_partners <- fsmi_num_partners_all_sem_partners_[fsmi_num_partners_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
fsmi_num_partners_lrt
fsmi_num_partners_all_lrt
uppsp_fsmi_partners_lrt
uppsp_fsmi_partners_lrt2
uppsp_fsmi_partners_lrtpurg
uppsp_fsmi_partners_lrtnurg
uppsp_fsmi_partners_lrtss

dplyr::filter(parameterestimates(fsmi_num_partners_sem), lhs == 'ordered_num_partner', rhs == 'fsmi_mate')[c('est', 'pvalue')]
dplyr::filter(parameterestimates(fsmi_num_partners_all_sem), lhs == 'ordered_num_partner', rhs == 'fsmi_mate')[c('est', 'pvalue')]

plot_lav_factor_pred(lavfit = fsmi_num_partners_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_num_partner',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_num_partners_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_num_partners_sem)))

plot_lav_factor_pred(lavfit = fsmi_num_partners_all_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_num_partner',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_num_partners_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_num_partners_all_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_partners_nofsmi_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among all college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_fsmi_partners_nofsmi_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_partners_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_partners_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_partners_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_partners_all_sem)))
```

The basic takeaway from the above is that a lot of these are associated but remove any one of them and model fit doesn't drop much. 
Remove a couple (both urgency scales, or all upps-p scales) and there's a big model fit drop. Include only one, and then remove it, and there's a big model fit drop.
For now, I'm going to stick with just describing the relations with the motive scales.
When looking at the size of standardized coefficients, positive urgency is the largest, and is not greatly diminished by the addition of the FSMI Mate-seeking scale.

### K-SRQ sexual relationship

```{r fig.width=4, fig.height=4}
ksrq_num_partners_null_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ 0*k_srq_sexual_relationships + gender_c', sep = '\n')
ksrq_num_partners_null_all_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ 0*k_srq_sexual_relationships + gender_c + age_c', sep = '\n')

ksrq_num_partners_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + k_srq_admiration + gender_c', sep = '\n')
ksrq_num_partners_all_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + k_srq_admiration + gender_c + age_c', sep = '\n')

ksrq_noadmrtn_num_partners_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c', sep = '\n')
ksrq_noadmrtn_num_partners_all_model <- paste(ksrq_model, 
                                 'ordered_num_partner ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c + age_c', sep = '\n')

uppsp_ksrq_num_partners_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_nosr_num_partners_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_num_partners_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

uppsp_ksrq_nosr_num_partners_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_num_partner ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

ksrq_num_partners_modelsFN <- file.path(data_dir, 'ksrq_num_partners_models.rda')
if(!file.exists(fsmi_num_partners_modelsFN)){
    ksrq_num_partners_sem <- lavaan::lavaan(
        model = ksrq_num_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_num_partners_all_sem <- lavaan::lavaan(
        model = ksrq_num_partners_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_num_partners_null_sem <- lavaan::lavaan(
        model = ksrq_num_partners_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_num_partners_null_all_sem <- lavaan::lavaan(
        model = ksrq_num_partners_null_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_num_partners_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_num_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_num_partners_all_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_num_partners_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_num_partners_sem <- lavaan::lavaan(
        model = uppsp_ksrq_num_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_num_partners_sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_num_partners_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_num_partners_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_num_partners_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_num_partners_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_num_partners_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_num_partners_null_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_num_partners_sem,
                                                       ksrq_num_partners_null_sem)
    ksrq_num_partners_null_all_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_num_partners_all_sem,
                                                       ksrq_num_partners_null_all_sem)
    ksrq_num_partners_admrtn_lrt <- lavaan::lavTestLRT(ksrq_num_partners_sem,
                                                       ksrq_noadmrtn_num_partners_sem)
    ksrq_num_partners_admrtn_all_lrt <- lavaan::lavTestLRT(ksrq_num_partners_all_sem,
                                                       ksrq_noadmrtn_num_partners_all_sem)
    uppsp_ksrq_num_partners_lrt <- lavaan::lavTestLRT(uppsp_ksrq_num_partners_sem,
                                                      uppsp_ksrq_nosr_num_partners_sem)
    uppsp_ksrq_num_partners_all_lrt <- lavaan::lavTestLRT(uppsp_ksrq_num_partners_all__sem,
                                                          uppsp_ksrq_nosr_num_partners_all__sem)
    
    save(ksrq_num_partners_sem,
         ksrq_num_partners_all_sem,
         ksrq_num_partners_null_sem,
         ksrq_num_partners_null_all_sem,
         ksrq_noadmrtn_num_partners_sem,
         ksrq_noadmrtn_num_partners_all_sem,
         uppsp_ksrq_num_partners_sem,
         uppsp_ksrq_nosr_num_partners_sem,
         uppsp_ksrq_num_partners_all__sem,
         uppsp_ksrq_nosr_num_partners_all__sem,
         ksrq_num_partners_null_lrt,
         ksrq_num_partners_null_all_lrt,
         ksrq_num_partners_admrtn_lrt,
         ksrq_num_partners_admrtn_all_lrt,
         uppsp_ksrq_num_partners_lrt,
         uppsp_ksrq_num_partners_all_lrt,
         file = ksrq_num_partners_modelsFN)
} else {
    load(ksrq_num_partners_modelsFN)
}

ksrq_num_partners_sem_pred <- lavaan::lavPredict(ksrq_num_partners_sem)
ksrq_num_partners_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_num_partners_sem_partners <- ksrq_num_partners_sem_partners_[ksrq_num_partners_sem@Data@case.idx[[1]]]

ksrq_num_partners_all_sem_pred <- lavaan::lavPredict(ksrq_num_partners_all_sem)
ksrq_num_partners_all_sem_partners_ <- splt_fsmi_devdemog$ordered_num_partner
ksrq_num_partners_all_sem_partners <- ksrq_num_partners_all_sem_partners_[ksrq_num_partners_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
ggplot2::qplot(ksrq_num_partners_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_num_partners_sem_partners,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of partners',
               geom = 'jitter')

ggplot2::qplot(ksrq_num_partners_all_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_num_partners_all_sem_partners,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of partners',
               geom = 'jitter')
```

```{r}
ksrq_num_partners_null_lrt
ksrq_num_partners_null_all_lrt
ksrq_num_partners_admrtn_lrt
uppsp_ksrq_num_partners_lrt
uppsp_ksrq_num_partners_all_lrt

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_num_partners_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_num_partners_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_noadmrtn_num_partners_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_num_partners_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_num_partners_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_num_partners_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_noadmrtn_num_partners_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_num_partners_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_num_partners_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_num_partners_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_num_partners_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_num_partners_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_num_partners_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_num_partners_all__sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_num_partners_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_num_partners_all__sem)))
```

K-SRQ Sexual Relationships is associated with number of sexual partners in both the unpartnered college sample, and the combined adolescent and college sample.
There are too few participants in the adolescent sample with one or more sexual partners so while some of the analyses do use data from all participants with responses on the SES, this primarily serves to integrate both partnered and upartnered college students.
Notably, the standardized coefficient for the association between number of sexual partners and K-SRQ Sexual Relationships does not change much between either the full, or unpartnered college students subgroups.
Sociability and Sexual Relationships are too highly correlated to be disentangled.
Controlling for the other highly correlated K-SRQ scale, Admiration, yields a standardized effect of Sexual Relationships that has the same sign, but that has bigger magnitude.
The coefficient for the Admiration scale is large and negative, which evokes extremely speculative narratives having to do with reputational concerns and promiscuity.
The magnitude of the Sexual Relationships association (the standard deviation is close to one, so the standardized and unstandardized coefficients are very similar) is about the same size as the effect of reported gender. 
In other words, the expected difference in number of sexual partners a one point increase on K-SRQ Sexual Relationshi

### SPLT parameters

```{r fig.width=4, fig.height=4}
splt_param_labels_plaintext <- c(
    'ep_prm' = '$\\epsilon$', 
    'rho_prm' = '$\\rho$', 
    'xi_prm' = '$\\xi$', 
    'b' = '$b$', 
    'bin_start_to_4' = 'First-half optimal responses', 
    'bin_5_to_end' = 'Last-half optimal responses')
    
names(rl_var_names_facts) <- c('ep_prm', 'rho_prm', 'xi_prm', 'b', 'bin_start_to_4', 'bin_5_to_end')
splt_partners_models <- lapply(
    seq_along(rl_var_names_facts),
    function(i){
        splt_num_partners_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_num_partner ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_num_partners_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_num_partner ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_num_partners_all_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_num_partner ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        splt_num_partners_all_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_num_partner ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        return(list(splt_num_partners_model = splt_num_partners_model,
                    splt_num_partners_null_model = splt_num_partners_null_model,
                    splt_num_partners_all_model = splt_num_partners_all_model,
                    splt_num_partners_all_null_model = splt_num_partners_all_null_model))
    })
names(splt_partners_models) <- names(rl_var_names_facts)

splt_num_partners_semsFN <-
    file.path(data_dir, 'splt_num_partners_semsFN.RDS')
library(future)
library(listenv)
future::plan(sequential)
splt_num_partners_sems_le <- listenv()
if(!file.exists(splt_num_partners_semsFN)){
    for(i in seq_along(splt_partners_models)){
        splt_num_partners_sems_le[[i]] <- future({
            splt_num_partners_sem <- lavaan::lavaan(
                model = splt_partners_models[[i]]$splt_num_partners_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_num_partners_null_sem <- lavaan::lavaan(
                model = splt_partners_models[[i]]$splt_num_partners_null_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_num_partners_all_sem <- lavaan::lavaan(
                model = splt_partners_models[[i]]$splt_num_partners_all_model, 
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_num_partners_all_null_sem <- lavaan::lavaan(
                model = splt_partners_models[[i]]$splt_num_partners_all_null_model,
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_num_partners_lrt <- lavaan::lavTestLRT(splt_num_partners_sem,
                                                        splt_num_partners_null_sem)
            splt_num_partners_all_lrt <- lavaan::lavTestLRT(splt_num_partners_all_sem,
                                                            splt_num_partners_all_null_sem)
            
            list(splt_num_partners_sem = splt_num_partners_sem,
                 splt_num_partners_null_sem = splt_num_partners_null_sem,
                 splt_num_partners_all_sem = splt_num_partners_all_sem,
                 splt_num_partners_all_null_sem = splt_num_partners_all_null_sem,
                 splt_num_partners_lrt = splt_num_partners_lrt,
                 splt_num_partners_all_lrt = splt_num_partners_all_lrt)
        })
    }
    splt_num_partners_sems <- as.list(
        lapply(splt_num_partners_sems_le, future::value)
    )
    names(splt_num_partners_sems) <- names(splt_partners_models)
    saveRDS(splt_num_partners_sems, splt_num_partners_semsFN)
} else {
    splt_num_partners_sems <- readRDS(splt_num_partners_semsFN)
}

splt_num_partners_chisqp <- lapply(splt_num_partners_sems,
       function(splt_num_partners_sem){
           print(splt_num_partners_sem$splt_num_partners_lrt)
           print(splt_num_partners_sem$splt_num_partners_all_lrt)
           p <- splt_num_partners_sem$splt_num_partners_lrt[2,'Pr(>Chisq)']
           p_all <- splt_num_partners_sem$splt_num_partners_all_lrt[2,'Pr(>Chisq)']
           return(c(p = p , p_all = p_all))
       })

nada <- lapply(seq_along(splt_num_partners_sems),
       function(i){
           param_label <- splt_param_labels_plaintext[names(splt_num_partners_sems)[[i]]]
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_num_partners_sems[[i]]$splt_num_partners_sem, 
                                                stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of partners among unpartnered college students; N obs. = ',
                   lavaan::nobs(splt_num_partners_sems[[i]]$splt_num_partners_sem))))
           
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_num_partners_sems[[i]]$splt_num_partners_all_sem, stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
                   lavaan::nobs(splt_num_partners_sems[[i]]$splt_num_partners_all_sem))))
       })
```
No $\chi^2$ tests satisfy the $\alpha = .005$ cutoff. The biggest association is with the $\epsilon$ contrast variable, but it has the wrong sign, with higher learning rates being associated with fewer numbers of sexual partners.

## Number of sexual encounters

### FSMI mate seeking

```{r fig.width=4, fig.height=4}
fsmi_sex_freq_model <- paste(fsmi_cfa_matestat_model, 
                             'ordered_sex_freq ~ fsmi_mate + gender_c', sep = '\n')

fsmi_sex_freq_null_model <- paste(fsmi_cfa_matestat_model, 
                                  'ordered_sex_freq ~ 0*fsmi_mate + gender_c', sep = '\n')

sensseek_urgency_cfa <- milav::create_cfa_from_keylist(
    upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])

test_data <- splt_fsmi_devdemog[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample),
    c('ordered_sex_freq',
      unlist(milav::get_items_from_keys(
          upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])),
      unlist(milav::get_items_from_keys(fsmi_key$fsmi_mate)),
      'gender_c')]
test_data$ordered_sex_freq <- as.numeric(test_data$ordered_sex_freq)
readr::write_tsv(test_data, path = '/data/jflournoy/split/probly/test.tsv', 
                 col_names = F, na = '-9999')
readr::write_lines(names(test_data), path = '/data/jflournoy/split/probly/test_names.txt')

uppsp_fsmi_sfreq_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_sfreq_noupps_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'ordered_sex_freq ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
     sep = '\n')

uppsp_fsmi_sfreq_nofsmi_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + 0*fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_sfreq_nopurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_sfreq_nonurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_sex_freq ~ 0*neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_sfreq_noss_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'ordered_sex_freq ~ neg_urgency + 0*sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_sfreq_null_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'ordered_sex_freq ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + 0*fsmi_mate + gender_c',
     sep = '\n')

fsmi_sex_freq_modelsFN <- file.path(data_dir, 'fsmi_sex_freq_models.rda')
if(!file.exists(fsmi_sex_freq_modelsFN)){
    fsmi_sex_freq_sem <- lavaan::lavaan(
        model = fsmi_sex_freq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    fsmi_sex_freq_all_sem <- lavaan::lavaan(
        model = fsmi_sex_freq_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'partnered', group.equal = 'loadings')
    
    fsmi_sex_freq_null_sem <- lavaan::lavaan(
        model = fsmi_sex_freq_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    fsmi_sex_freq_null_all_sem <- lavaan::lavaan(
        model = fsmi_sex_freq_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'partnered', group.equal = 'loadings')
    
    uppsp_fsmi_sfreq_all_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_noupps_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_all_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_noupps_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_nofsmi_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_nopurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_nopurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_nonurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_nonurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_noss_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_noss_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_sfreq_null_sem <- lavaan::lavaan(
        model = uppsp_fsmi_sfreq_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_sfreq_lrt <- lavaan::lavTestLRT(fsmi_sex_freq_sem,
                                         fsmi_sex_freq_null_sem)
    # fsmi_sfreq_all_lrt <- lavaan::lavTestLRT(fsmi_sex_freq_all_sem,
    #                                      fsmi_sex_freq_null_all_sem)
    # 
    uppsp_fsmi_sfreq_all_lrt <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_all_sem,
                                                   uppsp_fsmi_sfreq_all_noupps_sem)
    
    uppsp_fsmi_sfreq_lrt <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_sem,
                                               uppsp_fsmi_sfreq_noupps_sem,
                                               uppsp_fsmi_sfreq_null_sem)
    
    uppsp_fsmi_sfreq_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_sem,
                                                uppsp_fsmi_sfreq_nofsmi_sem,
                                                uppsp_fsmi_sfreq_null_sem)
    
    uppsp_fsmi_sfreq_lrtpurg <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_sem,
                                                   uppsp_fsmi_sfreq_nopurg_sem,
                                                   uppsp_fsmi_sfreq_null_sem)
    
    uppsp_fsmi_sfreq_lrtnurg <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_sem,
                                                   uppsp_fsmi_sfreq_nonurg_sem,
                                                   uppsp_fsmi_sfreq_null_sem)
    
    uppsp_fsmi_sfreq_lrtss <- lavaan::lavTestLRT(uppsp_fsmi_sfreq_sem,
                                                 uppsp_fsmi_sfreq_noss_sem,
                                                 uppsp_fsmi_sfreq_null_sem)
    
    save(fsmi_sex_freq_sem,
         fsmi_sex_freq_all_sem,
         fsmi_sex_freq_null_sem,
         fsmi_sex_freq_null_all_sem,
         fsmi_sfreq_lrt,
         uppsp_fsmi_sfreq_sem,
         uppsp_fsmi_sfreq_all_sem,
         uppsp_fsmi_sfreq_noupps_sem,
         uppsp_fsmi_sfreq_nofsmi_sem,
         uppsp_fsmi_sfreq_nopurg_sem,
         uppsp_fsmi_sfreq_nonurg_sem,
         uppsp_fsmi_sfreq_noss_sem,
         uppsp_fsmi_sfreq_null_sem,
         uppsp_fsmi_sfreq_all_sem,
         uppsp_fsmi_sfreq_all_noupps_sem,
         uppsp_fsmi_sfreq_all_lrt,
         uppsp_fsmi_sfreq_lrt,
         uppsp_fsmi_sfreq_lrt2,
         uppsp_fsmi_sfreq_lrtpurg,
         uppsp_fsmi_sfreq_lrtnurg,
         uppsp_fsmi_sfreq_lrtss,
         file = fsmi_sex_freq_modelsFN)
} else {
    load(fsmi_sex_freq_modelsFN)
}

fsmi_sex_freq_sem_pred <- lavaan::lavPredict(fsmi_sex_freq_sem)
fsmi_sex_freq_sem_sfreq_ <- splt_fsmi_devdemog$ordered_sex_freq[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_sex_freq_sem_sfreq <- fsmi_sex_freq_sem_sfreq_[fsmi_sex_freq_sem@Data@case.idx[[1]]]

fsmi_sex_freq_all_sem_pred <- lavaan::lavPredict(fsmi_sex_freq_all_sem)
fsmi_sex_freq_all_sem_sfreq_ <- splt_fsmi_devdemog$ordered_sex_freq[grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_sex_freq_all_sem_sfreq <- fsmi_sex_freq_all_sem_sfreq_[fsmi_sex_freq_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
fsmi_sfreq_lrt
uppsp_fsmi_sfreq_lrt
uppsp_fsmi_sfreq_lrt2
uppsp_fsmi_sfreq_lrtpurg
uppsp_fsmi_sfreq_lrtnurg
uppsp_fsmi_sfreq_lrtss

plot_lav_factor_pred(lavfit = fsmi_sex_freq_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_sex_freq',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_sex_freq_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_sex_freq_sem)))

plot_lav_factor_pred(lavfit = fsmi_sex_freq_all_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'ordered_sex_freq',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_sex_freq_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of sexual encounters among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_sex_freq_all_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_sfreq_nofsmi_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of sexual encounters among all college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_fsmi_sfreq_nofsmi_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_sfreq_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_sfreq_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_sfreq_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_sfreq_all_sem)))
```

There is not a strong association between FSMI Mate-seeking and number of sexual encounters in the past six months for unpartnered college students.
The association was not examined in partnered college students because the Mate-seeking scale asks about looking for new romantic or sexual partners, and so (in normatively monogamous relationships) should not be theoretically related to frequency of sex.

### K-SRQ sexual relationships

```{r fig.width=4, fig.height=4}
ksrq_sex_freq_null_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ 0*k_srq_sexual_relationships + gender_c', sep = '\n')
ksrq_sex_freq_null_all_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ 0*k_srq_sexual_relationships + gender_c + age_c', sep = '\n')

ksrq_sex_freq_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ k_srq_sexual_relationships + k_srq_admiration + gender_c', sep = '\n')
ksrq_sex_freq_all_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ k_srq_sexual_relationships + k_srq_admiration + gender_c + age_c', sep = '\n')

ksrq_noadmrtn_sex_freq_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c', sep = '\n')
ksrq_noadmrtn_sex_freq_all_model <- paste(ksrq_model, 
                                 'ordered_sex_freq ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c + age_c', sep = '\n')

uppsp_ksrq_sex_freq_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_nosr_sex_freq_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_sex_freq_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

uppsp_ksrq_nosr_sex_freq_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'ordered_sex_freq ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

ksrq_sex_freq_modelsFN <- file.path(data_dir, 'ksrq_sex_freq_models.rda')
if(!file.exists(fsmi_sex_freq_modelsFN)){
    ksrq_sex_freq_sem <- lavaan::lavaan(
        model = ksrq_sex_freq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_sex_freq_all_sem <- lavaan::lavaan(
        model = ksrq_sex_freq_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_sex_freq_null_sem <- lavaan::lavaan(
        model = ksrq_sex_freq_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_sex_freq_null_all_sem <- lavaan::lavaan(
        model = ksrq_sex_freq_null_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_sex_freq_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_sex_freq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_sex_grp_partnered_freq_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_sex_freq_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE,
        group = 'partnered', group.equal = 'loadings')
    
    ksrq_noadmrtn_sex_freq_all_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_sex_freq_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_sex_freq_sem <- lavaan::lavaan(
        model = uppsp_ksrq_sex_freq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_sex_freq_sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_sex_freq_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_sex_freq_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_sex_freq_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_sex_freq_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_sex_freq_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_sex_freq_null_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_sex_freq_sem,
                                                       ksrq_sex_freq_null_sem)
    ksrq_sex_freq_null_all_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_sex_freq_all_sem,
                                                       ksrq_sex_freq_null_all_sem)
    ksrq_sex_freq_admrtn_lrt <- lavaan::lavTestLRT(ksrq_sex_freq_sem,
                                                   ksrq_noadmrtn_sex_freq_sem)
    ksrq_sex_freq_admrtn_all_lrt <- lavaan::lavTestLRT(ksrq_sex_freq_all_sem,
                                                       ksrq_noadmrtn_sex_freq_all_sem)
    uppsp_ksrq_sex_freq_lrt <- lavaan::lavTestLRT(uppsp_ksrq_sex_freq_sem,
                                                      uppsp_ksrq_nosr_sex_freq_sem)
    uppsp_ksrq_sex_freq_all_lrt <- lavaan::lavTestLRT(uppsp_ksrq_sex_freq_all__sem,
                                                          uppsp_ksrq_nosr_sex_freq_all__sem)
    
    save(ksrq_sex_freq_sem,
         ksrq_sex_freq_all_sem,
         ksrq_sex_freq_null_sem,
         ksrq_sex_freq_null_all_sem,
         ksrq_noadmrtn_sex_freq_sem,
         ksrq_noadmrtn_sex_freq_all_sem,
         ksrq_noadmrtn_sex_grp_partnered_freq_sem,
         uppsp_ksrq_sex_freq_sem,
         uppsp_ksrq_nosr_sex_freq_sem,
         uppsp_ksrq_sex_freq_all__sem,
         uppsp_ksrq_nosr_sex_freq_all__sem,
         ksrq_sex_freq_null_lrt,
         ksrq_sex_freq_null_all_lrt,
         ksrq_sex_freq_admrtn_lrt,
         ksrq_sex_freq_admrtn_all_lrt,
         uppsp_ksrq_sex_freq_lrt,
         uppsp_ksrq_sex_freq_all_lrt,
         file = ksrq_sex_freq_modelsFN)
} else {
    load(ksrq_sex_freq_modelsFN)
}

ksrq_sex_freq_sem_pred <- lavaan::lavPredict(ksrq_sex_freq_sem)
ksrq_sex_freq_sem_sfreq_ <- splt_fsmi_devdemog$ordered_sex_freq[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_sex_freq_sem_sfreq <- ksrq_sex_freq_sem_sfreq_[ksrq_sex_freq_sem@Data@case.idx[[1]]]

ksrq_sex_freq_all_sem_pred <- lavaan::lavPredict(ksrq_sex_freq_all_sem)
ksrq_sex_freq_all_sem_sfreq_ <- splt_fsmi_devdemog$ordered_sex_freq
ksrq_sex_freq_all_sem_sfreq <- ksrq_sex_freq_all_sem_sfreq_[ksrq_sex_freq_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
ggplot2::qplot(ksrq_sex_freq_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_sex_freq_sem_sfreq,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of\nsexual encounters',
               geom = 'jitter')

ggplot2::qplot(ksrq_sex_freq_all_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_sex_freq_all_sem_sfreq,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Number of\nsexual encounters',
               geom = 'jitter')
```

```{r}
ksrq_sex_freq_null_lrt
ksrq_sex_freq_null_all_lrt
ksrq_sex_freq_admrtn_lrt
ksrq_sex_freq_admrtn_all_lrt
uppsp_ksrq_sex_freq_lrt
uppsp_ksrq_sex_freq_all_lrt

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_sex_freq_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_sex_freq_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_noadmrtn_sex_freq_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_noadmrtn_sex_freq_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_sex_freq_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_sex_freq_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_noadmrtn_sex_freq_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_noadmrtn_sex_freq_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_sex_freq_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_sex_freq_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_sex_freq_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_sex_freq_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_sex_freq_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_sex_freq_all__sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_sex_freq_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of sexual encounters among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_sex_freq_all__sem)))
```

K-SRQ Sexual Relationships is associated with number of sexual partners when considering the full sample, and the sign and size of the coefficient is similar when considering only the unpartnered college sample.
Again, Sociability and Sexual Relationships are too highly correlated to be disentangled.
Controlling for the other highly correlated K-SRQ scale, Admiration, yields a standardized effect of Sexual Relationships that has the same sign, but that has bigger magnitude.
As above, the coefficient for the Admiration scale is large and negative when controlling for K-SRQ Sexual Relationships.

### SPLT parameters

```{r fig.width=4, fig.height=4}
    
splt_sfreq_models <- lapply(
    seq_along(rl_var_names_facts),
    function(i){
        splt_sex_freq_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_sex_freq ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_sex_freq_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_sex_freq ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_sex_freq_all_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_sex_freq ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        splt_sex_freq_all_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('ordered_sex_freq ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        return(list(splt_sex_freq_model = splt_sex_freq_model,
                    splt_sex_freq_null_model = splt_sex_freq_null_model,
                    splt_sex_freq_all_model = splt_sex_freq_all_model,
                    splt_sex_freq_all_null_model = splt_sex_freq_all_null_model))
    })
names(splt_sfreq_models) <- names(rl_var_names_facts)

splt_sex_freq_semsFN <-
    file.path(data_dir, 'splt_sex_freq_semsFN.RDS')
library(future)
library(listenv)
future::plan(sequential)
splt_sex_freq_sems_le <- listenv()
if(!file.exists(splt_sex_freq_semsFN)){
    for(i in seq_along(splt_sfreq_models)){
        splt_sex_freq_sems_le[[i]] <- future({
            splt_sex_freq_sem <- lavaan::lavaan(
                model = splt_sfreq_models[[i]]$splt_sex_freq_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_sex_freq_null_sem <- lavaan::lavaan(
                model = splt_sfreq_models[[i]]$splt_sex_freq_null_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_sex_freq_all_sem <- lavaan::lavaan(
                model = splt_sfreq_models[[i]]$splt_sex_freq_all_model, 
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_sex_freq_all_null_sem <- lavaan::lavaan(
                model = splt_sfreq_models[[i]]$splt_sex_freq_all_null_model,
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_sex_freq_lrt <- lavaan::lavTestLRT(splt_sex_freq_sem,
                                                        splt_sex_freq_null_sem)
            splt_sex_freq_all_lrt <- lavaan::lavTestLRT(splt_sex_freq_all_sem,
                                                            splt_sex_freq_all_null_sem)
            
            list(splt_sex_freq_sem = splt_sex_freq_sem,
                 splt_sex_freq_null_sem = splt_sex_freq_null_sem,
                 splt_sex_freq_all_sem = splt_sex_freq_all_sem,
                 splt_sex_freq_all_null_sem = splt_sex_freq_all_null_sem,
                 splt_sex_freq_lrt = splt_sex_freq_lrt,
                 splt_sex_freq_all_lrt = splt_sex_freq_all_lrt)
        })
    }
    splt_sex_freq_sems <- as.list(
        lapply(splt_sex_freq_sems_le, future::value)
    )
    names(splt_sex_freq_sems) <- names(splt_sfreq_models)
    saveRDS(splt_sex_freq_sems, splt_sex_freq_semsFN)
} else {
    splt_sex_freq_sems <- readRDS(splt_sex_freq_semsFN)
}

splt_sex_freq_chisqp <- lapply(splt_sex_freq_sems,
       function(splt_sex_freq_sem){
           print(splt_sex_freq_sem$splt_sex_freq_lrt)
           print(splt_sex_freq_sem$splt_sex_freq_all_lrt)
           p <- splt_sex_freq_sem$splt_sex_freq_lrt[2,'Pr(>Chisq)']
           p_all <- splt_sex_freq_sem$splt_sex_freq_all_lrt[2,'Pr(>Chisq)']
           return(c(p = p , p_all = p_all))
       })

nada <- lapply(seq_along(splt_sex_freq_sems),
       function(i){
           param_label <- splt_param_labels_plaintext[names(splt_sex_freq_sems)[[i]]]
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_sex_freq_sems[[i]]$splt_sex_freq_sem, 
                                                stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of partners among unpartnered college students; N obs. = ',
                   lavaan::nobs(splt_sex_freq_sems[[i]]$splt_sex_freq_sem))))
           
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_sex_freq_sems[[i]]$splt_sex_freq_all_sem, stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
                   lavaan::nobs(splt_sex_freq_sems[[i]]$splt_sex_freq_all_sem))))
       })
```
Again, no $\chi^2$ tests satisfy the $\alpha = .005$ cutoff. The biggest association is with the $\epsilon$ contrast variable, but it has the wrong sign, with higher learning rates being associated with fewer sexual encounters.

## Health-related behavior

### Using protection

#### FSMI mate seeking

```{r fig.width=4, fig.height=4}
splt_fsmi_devdemog$continuous_use_protection <- as.numeric(splt_fsmi_devdemog$ordered_use_protection)

fsmi_use_protection_model <- paste(fsmi_cfa_matestat_model, 
                             'continuous_use_protection ~ fsmi_mate + gender_c', sep = '\n')

fsmi_use_protection_null_model <- paste(fsmi_cfa_matestat_model, 
                             'continuous_use_protection ~ 0*fsmi_mate + gender_c', sep = '\n')

sensseek_urgency_cfa <- milav::create_cfa_from_keylist(
    upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])

uppsp_fsmi_uprot_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_uprot_noupps_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'continuous_use_protection ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
     sep = '\n')

uppsp_fsmi_uprot_nofsmi_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + 0*fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_uprot_nopurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'continuous_use_protection ~ neg_urgency + sensation_seeking + 0*pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_uprot_nonurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'continuous_use_protection ~ 0*neg_urgency + sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_uprot_noss_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
    'continuous_use_protection ~ neg_urgency + 0*sensation_seeking + pos_urgency + fsmi_mate + gender_c',
    sep = '\n')

uppsp_fsmi_uprot_null_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_mate =~ fsmi_qs_55 + fsmi_qs_56 + fsmi_qs_57 + fsmi_qs_58 + fsmi_qs_59 + fsmi_qs_60
',
     'continuous_use_protection ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + 0*fsmi_mate + gender_c',
     sep = '\n')

fsmi_use_protection_modelsFN <- file.path(data_dir, 'fsmi_use_protection_models.rda')
if(!file.exists(fsmi_use_protection_modelsFN)){
    fsmi_use_protection_sem <- lavaan::lavaan(
        model = fsmi_use_protection_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_use_protection_all_sem <- lavaan::lavaan(
        model = fsmi_use_protection_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_use_protection_null_sem <- lavaan::lavaan(
        model = fsmi_use_protection_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_use_protection_all_null_sem <- lavaan::lavaan(
        model = fsmi_use_protection_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    
    
    uppsp_fsmi_uprot_all_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_noupps_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_all_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_noupps_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_nofsmi_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_all_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_nofsmi_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_nopurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_nopurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_nonurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_nonurg_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_noss_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_noss_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_uprot_null_sem <- lavaan::lavaan(
        model = uppsp_fsmi_uprot_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_uprot_lrt <- lavaan::lavTestLRT(fsmi_use_protection_sem,
                                             fsmi_use_protection_null_sem)
    fsmi_uprot_all_lrt <- lavaan::lavTestLRT(fsmi_use_protection_all_sem,
                                             fsmi_use_protection_all_null_sem)
    
    uppsp_fsmi_uprot_all_lrt <- lavaan::lavTestLRT(uppsp_fsmi_uprot_all_sem,
                                                   uppsp_fsmi_uprot_all_noupps_sem)
    
    uppsp_fsmi_uprot_all_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_uprot_all_sem,
                                                   uppsp_fsmi_uprot_all_nofsmi_sem)
    
    uppsp_fsmi_uprot_lrt <- lavaan::lavTestLRT(uppsp_fsmi_uprot_sem,
                                               uppsp_fsmi_uprot_noupps_sem,
                                               uppsp_fsmi_uprot_null_sem)
    
    uppsp_fsmi_uprot_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_uprot_sem,
                                                uppsp_fsmi_uprot_nofsmi_sem,
                                                uppsp_fsmi_uprot_null_sem)
    
    uppsp_fsmi_uprot_lrtpurg <- lavaan::lavTestLRT(uppsp_fsmi_uprot_sem,
                                                   uppsp_fsmi_uprot_nopurg_sem,
                                                   uppsp_fsmi_uprot_null_sem)
    
    uppsp_fsmi_uprot_lrtnurg <- lavaan::lavTestLRT(uppsp_fsmi_uprot_sem,
                                                   uppsp_fsmi_uprot_nonurg_sem,
                                                   uppsp_fsmi_uprot_null_sem)
    
    uppsp_fsmi_uprot_lrtss <- lavaan::lavTestLRT(uppsp_fsmi_uprot_sem,
                                                 uppsp_fsmi_uprot_noss_sem,
                                                 uppsp_fsmi_uprot_null_sem)
    
    save(fsmi_use_protection_sem,
         fsmi_use_protection_all_sem,
         fsmi_use_protection_null_sem,
         fsmi_use_protection_all_null_sem,
         fsmi_uprot_lrt,
         fsmi_uprot_all_lrt,
         uppsp_fsmi_uprot_sem,
         uppsp_fsmi_uprot_all_sem,
         uppsp_fsmi_uprot_noupps_sem,
         uppsp_fsmi_uprot_nofsmi_sem,
         uppsp_fsmi_uprot_nopurg_sem,
         uppsp_fsmi_uprot_nonurg_sem,
         uppsp_fsmi_uprot_noss_sem,
         uppsp_fsmi_uprot_null_sem,
         uppsp_fsmi_uprot_all_noupps_sem,
         uppsp_fsmi_uprot_all_nofsmi_sem,
         uppsp_fsmi_uprot_all_lrt,
         uppsp_fsmi_uprot_all_lrt2,
         uppsp_fsmi_uprot_lrt,
         uppsp_fsmi_uprot_lrt2,
         uppsp_fsmi_uprot_lrtpurg,
         uppsp_fsmi_uprot_lrtnurg,
         uppsp_fsmi_uprot_lrtss,
         file = fsmi_use_protection_modelsFN)
} else {
    load(fsmi_use_protection_modelsFN)
}

fsmi_use_protection_sem_pred <- lavaan::lavPredict(fsmi_use_protection_sem)
fsmi_use_protection_sem_uprot_ <- splt_fsmi_devdemog$continuous_use_protection[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_use_protection_sem_uprot <- fsmi_use_protection_sem_uprot_[fsmi_use_protection_sem@Data@case.idx[[1]]]

fsmi_use_protection_all_sem_pred <- lavaan::lavPredict(fsmi_use_protection_all_sem)
fsmi_use_protection_all_sem_uprot_ <- splt_fsmi_devdemog$continuous_use_protection[grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_use_protection_all_sem_uprot <- fsmi_use_protection_all_sem_uprot_[fsmi_use_protection_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
fsmi_uprot_lrt
fsmi_uprot_all_lrt
uppsp_fsmi_uprot_lrt
uppsp_fsmi_uprot_lrt2
uppsp_fsmi_uprot_lrtpurg
uppsp_fsmi_uprot_lrtnurg
uppsp_fsmi_uprot_lrtss

plot_lav_factor_pred(lavfit = fsmi_use_protection_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'continuous_use_protection',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_use_protection_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(fsmi_use_protection_sem)))

fsmi_use_protection_sem_mate_ci <- dplyr::filter(standardizedsolution(fsmi_use_protection_sem, ci = T), op == '~', rhs == 'fsmi_mate')[,c('est.std', 'ci.lower', 'ci.upper')]

plot_lav_factor_pred(lavfit = fsmi_use_protection_all_sem, 
                     factor_name = 'fsmi_mate', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'continuous_use_protection',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_use_protection_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting safe sex practices among all college participants with SES responses; N obs. = ',
        lavaan::nobs(fsmi_use_protection_all_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_uprot_nofsmi_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting safe sex practices among all college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_fsmi_uprot_nofsmi_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_uprot_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_uprot_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_uprot_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_uprot_all_sem)))
```

There estimate of the association between FSMI Mate-seeking and safe sex practices for unpartnered college students is very close to 0 ($\beta = `r sprintf('%0.3f', round(fsmi_use_protection_sem_mate_ci[,'est.std'],3))`$, 95\% CI = `r sprintf('[%0.2f,%0.2f]', fsmi_use_protection_sem_mate_ci[,'ci.lower'], fsmi_use_protection_sem_mate_ci[,'ci.upper'])`).
Fixing the coefficient for this association to 0 did not result in significant reduction in fit in any model specification

### K-SRQ sexual relationships

```{r fig.width=4, fig.height=4}
ksrq_use_protection_null_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ 0*k_srq_sexual_relationships + gender_c', sep = '\n')
ksrq_use_protection_null_all_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ 0*k_srq_sexual_relationships + gender_c + age_c', sep = '\n')

ksrq_use_protection_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ k_srq_sexual_relationships + k_srq_admiration + gender_c', sep = '\n')
ksrq_use_protection_all_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ k_srq_sexual_relationships + k_srq_admiration + gender_c + age_c', sep = '\n')

ksrq_noadmrtn_use_protection_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c', sep = '\n')
ksrq_noadmrtn_use_protection_all_model <- paste(ksrq_model, 
                                 'continuous_use_protection ~ k_srq_sexual_relationships + 0*k_srq_admiration + gender_c + age_c', sep = '\n')

uppsp_ksrq_use_protection_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_nosr_use_protection_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c',
    sep = '\n')

uppsp_ksrq_use_protection_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

uppsp_ksrq_nosr_use_protection_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'continuous_use_protection ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_sexual_relationships + gender_c + age_c',
    sep = '\n')

ksrq_use_protection_modelsFN <- file.path(data_dir, 'ksrq_use_protection_models.rda')
if(!file.exists(fsmi_use_protection_modelsFN)){
    ksrq_use_protection_sem <- lavaan::lavaan(
        model = ksrq_use_protection_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_use_protection_all_sem <- lavaan::lavaan(
        model = ksrq_use_protection_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_use_protection_null_sem <- lavaan::lavaan(
        model = ksrq_use_protection_null_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_use_protection_null_all_sem <- lavaan::lavaan(
        model = ksrq_use_protection_null_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_use_protection_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_use_protection_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_noadmrtn_use_protection_all_sem <- lavaan::lavaan(
        model = ksrq_noadmrtn_use_protection_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_use_protection_sem <- lavaan::lavaan(
        model = uppsp_ksrq_use_protection_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_use_protection_sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_use_protection_model, 
        data = splt_fsmi_devdemog[splt_fsmi_devdemog$partnered == 0 &
                                      grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_use_protection_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_use_protection_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_use_protection_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_use_protection_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'fiml', estimator = 'ML',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_use_protection_null_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_use_protection_sem,
                                                       ksrq_use_protection_null_sem)
    ksrq_use_protection_null_all_lrt <- lavaan::lavTestLRT(ksrq_noadmrtn_use_protection_all_sem,
                                                       ksrq_use_protection_null_all_sem)
    ksrq_use_protection_admrtn_lrt <- lavaan::lavTestLRT(ksrq_use_protection_sem,
                                                       ksrq_noadmrtn_use_protection_sem)
    ksrq_use_protection_admrtn_all_lrt <- lavaan::lavTestLRT(ksrq_use_protection_all_sem,
                                                             ksrq_noadmrtn_use_protection_all_sem)
    uppsp_ksrq_use_protection_lrt <- lavaan::lavTestLRT(uppsp_ksrq_use_protection_sem,
                                                      uppsp_ksrq_nosr_use_protection_sem)
    uppsp_ksrq_use_protection_all_lrt <- lavaan::lavTestLRT(uppsp_ksrq_use_protection_all__sem,
                                                          uppsp_ksrq_nosr_use_protection_all__sem)
    
    save(ksrq_use_protection_sem,
         ksrq_use_protection_all_sem,
         ksrq_use_protection_null_sem,
         ksrq_use_protection_null_all_sem,
         ksrq_noadmrtn_use_protection_sem,
         ksrq_noadmrtn_use_protection_all_sem,
         uppsp_ksrq_use_protection_sem,
         uppsp_ksrq_nosr_use_protection_sem,
         uppsp_ksrq_use_protection_all__sem,
         uppsp_ksrq_nosr_use_protection_all__sem,
         ksrq_use_protection_null_lrt,
         ksrq_use_protection_null_all_lrt,
         ksrq_use_protection_admrtn_lrt,
         ksrq_use_protection_admrtn_all_lrt,
         uppsp_ksrq_use_protection_lrt,
         uppsp_ksrq_use_protection_all_lrt,
         file = ksrq_use_protection_modelsFN)
} else {
    load(ksrq_use_protection_modelsFN)
}

ksrq_use_protection_sem_pred <- lavaan::lavPredict(ksrq_use_protection_sem)
ksrq_use_protection_sem_uprot_ <- splt_fsmi_devdemog$continuous_use_protection[splt_fsmi_devdemog$partnered == 0 &
                                  grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_use_protection_sem_uprot <- ksrq_use_protection_sem_uprot_[ksrq_use_protection_sem@Data@case.idx[[1]]]

ksrq_use_protection_all_sem_pred <- lavaan::lavPredict(ksrq_use_protection_all_sem)
ksrq_use_protection_all_sem_uprot_ <- splt_fsmi_devdemog$continuous_use_protection
ksrq_use_protection_all_sem_uprot <- ksrq_use_protection_all_sem_uprot_[ksrq_use_protection_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
ggplot2::qplot(ksrq_use_protection_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_use_protection_sem_uprot,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Safe Sex\nPractice Frequency',
               geom = 'jitter')

ggplot2::qplot(ksrq_use_protection_all_sem_pred[,'k_srq_sexual_relationships'],
               ksrq_use_protection_all_sem_uprot,
               xlab = 'K-SRQ Sexual relationship factor',
               ylab = 'Safe Sex\nPractice Frequency',
               geom = 'jitter')
```

```{r}
ksrq_use_protection_null_lrt
ksrq_use_protection_null_all_lrt
ksrq_use_protection_admrtn_lrt
ksrq_use_protection_admrtn_all_lrt
uppsp_ksrq_use_protection_lrt
uppsp_ksrq_use_protection_all_lrt

ksrq_noadmrtn_use_protection_sem_ci <- dplyr::filter(standardizedsolution(ksrq_noadmrtn_use_protection_sem, ci = T), op == '~', rhs == 'k_srq_sexual_relationships')[,c('est.std', 'ci.lower', 'ci.upper')]

knitr::kable(
    dplyr::filter(standardizedsolution(ksrq_use_protection_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_use_protection_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(ksrq_noadmrtn_use_protection_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(ksrq_noadmrtn_use_protection_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(ksrq_use_protection_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_use_protection_all_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(ksrq_noadmrtn_use_protection_all_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_noadmrtn_use_protection_all_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_ksrq_use_protection_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_use_protection_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_ksrq_nosr_use_protection_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among unpartnered college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_use_protection_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_ksrq_use_protection_all__sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_use_protection_all__sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_ksrq_nosr_use_protection_all__sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting safe sex practices among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_use_protection_all__sem)))
```

The standardized coefficient for the association between K-SRQ Sexual Relationships and safe sex practices for unpartnered college students is small ($\beta = `r sprintf('%0.2f', round(ksrq_noadmrtn_use_protection_sem_ci[,'est.std'],2))`$, 95\% CI = `r sprintf('[%0.2f,%0.2f]', ksrq_noadmrtn_use_protection_sem_ci[,'ci.lower'], ksrq_noadmrtn_use_protection_sem_ci[,'ci.upper'])`).
Fixing the coefficient for this association to 0 did not result in significant reduction in fit in any model specification.

### SPLT parameters

```{r fig.width=4, fig.height=4}
    
splt_uprot_models <- lapply(
    seq_along(rl_var_names_facts),
    function(i){
        splt_use_protection_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('continuous_use_protection ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_use_protection_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('continuous_use_protection ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c'), sep = '\n')
        splt_use_protection_all_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('continuous_use_protection ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        splt_use_protection_all_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('continuous_use_protection ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_DtngLHngT_fac + gender_c + age_c'), sep = '\n')
        return(list(splt_use_protection_model = splt_use_protection_model,
                    splt_use_protection_null_model = splt_use_protection_null_model,
                    splt_use_protection_all_model = splt_use_protection_all_model,
                    splt_use_protection_all_null_model = splt_use_protection_all_null_model))
    })
names(splt_uprot_models) <- names(rl_var_names_facts)

splt_use_protection_semsFN <-
    file.path(data_dir, 'splt_use_protection_semsFN.RDS')
library(future)
library(listenv)
future::plan(sequential)
splt_use_protection_sems_le <- listenv()
if(!file.exists(splt_use_protection_semsFN)){
    for(i in seq_along(splt_uprot_models)){
        splt_use_protection_sems_le[[i]] <- future({
            splt_use_protection_sem <- lavaan::lavaan(
                model = splt_uprot_models[[i]]$splt_use_protection_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_use_protection_null_sem <- lavaan::lavaan(
                model = splt_uprot_models[[i]]$splt_use_protection_null_model, 
                data = splt_fsmi_devdemog_betas[splt_fsmi_devdemog_betas$partnered == 0 &
                                                    grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_use_protection_all_sem <- lavaan::lavaan(
                model = splt_uprot_models[[i]]$splt_use_protection_all_model, 
                data = splt_fsmi_devdemog_betas,
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_use_protection_all_null_sem <- lavaan::lavaan(
                model = splt_uprot_models[[i]]$splt_use_protection_all_null_model,
                data = splt_fsmi_devdemog_betas,
                missing = 'fiml', estimator = 'ML',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_use_protection_lrt <- lavaan::lavTestLRT(splt_use_protection_sem,
                                                        splt_use_protection_null_sem)
            splt_use_protection_all_lrt <- lavaan::lavTestLRT(splt_use_protection_all_sem,
                                                            splt_use_protection_all_null_sem)
            
            list(splt_use_protection_sem = splt_use_protection_sem,
                 splt_use_protection_null_sem = splt_use_protection_null_sem,
                 splt_use_protection_all_sem = splt_use_protection_all_sem,
                 splt_use_protection_all_null_sem = splt_use_protection_all_null_sem,
                 splt_use_protection_lrt = splt_use_protection_lrt,
                 splt_use_protection_all_lrt = splt_use_protection_all_lrt)
        })
    }
    splt_use_protection_sems <- as.list(
        lapply(splt_use_protection_sems_le, function(alistenv) try(future::value(alistenv)))
    )
    names(splt_use_protection_sems) <- names(splt_uprot_models)
    saveRDS(splt_use_protection_sems, splt_use_protection_semsFN)
} else {
    splt_use_protection_sems <- readRDS(splt_use_protection_semsFN)
}

splt_use_protection_chisqp <- lapply(splt_use_protection_sems,
       function(splt_use_protection_sem){
           if(!'try-error' %in% class(splt_use_protection_sem)){
               print(splt_use_protection_sem$splt_use_protection_lrt)
               print(splt_use_protection_sem$splt_use_protection_all_lrt)
               p <- splt_use_protection_sem$splt_use_protection_lrt[2,'Pr(>Chisq)']
               p_all <- splt_use_protection_sem$splt_use_protection_all_lrt[2,'Pr(>Chisq)']
               return(c(p = p , p_all = p_all))
           }
       })

nada <- lapply(seq_along(splt_use_protection_sems),
       function(i){
           if(!'try-error' %in% class(splt_use_protection_sems[[i]])){
               param_label <- splt_param_labels_plaintext[names(splt_use_protection_sems)[[i]]]
               print(knitr::kable(
                   dplyr::filter(standardizedsolution(splt_use_protection_sems[[i]]$splt_use_protection_sem, ci = T), op == '~'),
                   digits = 2,
                   caption = paste0(
                       param_label, 
                       ' predicting number of partners among unpartnered college students; N obs. = ',
                       lavaan::nobs(splt_use_protection_sems[[i]]$splt_use_protection_sem))))
               
               print(knitr::kable(
                   dplyr::filter(standardizedsolution(splt_use_protection_sems[[i]]$splt_use_protection_all_sem, ci = T), op == '~'),
                   digits = 2,
                   caption = paste0(
                       param_label, 
                       ' predicting number of partners among all adolescent and college participants with SES responses; N obs. = ',
                       lavaan::nobs(splt_use_protection_sems[[i]]$splt_use_protection_all_sem))))
           }
       })
```
Again, no $\chi^2$ tests satisfy the $\alpha = .005$ cutoff.

## Number of days during which alcohol was consumed

### FSMI Status

```{r fig.width=4, fig.height=4}
fsmi_alc_days_model <- paste(fsmi_cfa_matestat_model, 
                             'alcohol_days_of_lst30 ~ fsmi_stat + gender_c', sep = '\n')

fsmi_alc_days_null_model <- paste(fsmi_cfa_matestat_model, 
                             'alcohol_days_of_lst30 ~ 0*fsmi_stat + gender_c', sep = '\n')

sensseek_urgency_cfa <- milav::create_cfa_from_keylist(
    upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])

uppsp_fsmi_alcdays_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alcdays_noupps_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
     'alcohol_days_of_lst30 ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + fsmi_stat + gender_c',
     sep = '\n')

uppsp_fsmi_alcdays_nofsmi_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alcdays_nopurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + 0*pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alcdays_nonurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_days_of_lst30 ~ 0*neg_urgency + sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alcdays_noss_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_days_of_lst30 ~ neg_urgency + 0*sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alcdays_null_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
     'alcohol_days_of_lst30 ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + 0*fsmi_stat + gender_c',
     sep = '\n')

fsmi_alc_days_modelsFN <- file.path(data_dir, 'fsmi_alc_days_models.rda')
if(!file.exists(fsmi_alc_days_modelsFN)){
    
    fsmi_alc_days_sem <- lavaan::lavaan(
        model = fsmi_alc_days_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_alc_days_null_sem <- lavaan::lavaan(
        model = fsmi_alc_days_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_noupps_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_nofsmi_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_nopurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_nopurg_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_nonurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_nonurg_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_noss_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_noss_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alcdays_null_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alcdays_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_alcdays_lrt <- lavaan::lavTestLRT(fsmi_alc_days_sem, 
                                           fsmi_alc_days_null_sem)
    
    uppsp_fsmi_alcdays_lrt <- lavaan::lavTestLRT(uppsp_fsmi_alcdays_sem,
                                                 uppsp_fsmi_alcdays_noupps_sem,
                                                 uppsp_fsmi_alcdays_null_sem)
    
    uppsp_fsmi_alcdays_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_alcdays_sem,
                                                  uppsp_fsmi_alcdays_nofsmi_sem,
                                                  uppsp_fsmi_alcdays_null_sem)
    
    uppsp_fsmi_alcdays_lrtpurg <- lavaan::lavTestLRT(uppsp_fsmi_alcdays_sem,
                                                     uppsp_fsmi_alcdays_nopurg_sem,
                                                     uppsp_fsmi_alcdays_null_sem)
    
    uppsp_fsmi_alcdays_lrtnurg <- lavaan::lavTestLRT(uppsp_fsmi_alcdays_sem,
                                                     uppsp_fsmi_alcdays_nonurg_sem,
                                                     uppsp_fsmi_alcdays_null_sem)
    
    uppsp_fsmi_alcdays_lrtss <- lavaan::lavTestLRT(uppsp_fsmi_alcdays_sem,
                                                   uppsp_fsmi_alcdays_noss_sem,
                                                   uppsp_fsmi_alcdays_null_sem)
    
    save(fsmi_alc_days_sem,
         uppsp_fsmi_alcdays_sem,
         uppsp_fsmi_alcdays_noupps_sem,
         uppsp_fsmi_alcdays_nofsmi_sem,
         uppsp_fsmi_alcdays_nopurg_sem,
         uppsp_fsmi_alcdays_nonurg_sem,
         uppsp_fsmi_alcdays_noss_sem,
         uppsp_fsmi_alcdays_null_sem,
         fsmi_alcdays_lrt,
         uppsp_fsmi_alcdays_lrt,
         uppsp_fsmi_alcdays_lrt2,
         uppsp_fsmi_alcdays_lrtpurg,
         uppsp_fsmi_alcdays_lrtnurg,
         uppsp_fsmi_alcdays_lrtss,
         file = fsmi_alc_days_modelsFN)
} else {
    load(fsmi_alc_days_modelsFN)
}

fsmi_alc_days_sem_pred <- lavaan::lavPredict(fsmi_alc_days_sem)
fsmi_alc_days_sem_alcdays_ <- splt_fsmi_devdemog$alcohol_days_of_lst30[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_alc_days_sem_alcdays <- fsmi_alc_days_sem_alcdays_[fsmi_alc_days_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
fsmi_alcdays_lrt
uppsp_fsmi_alcdays_lrt
uppsp_fsmi_alcdays_lrt2
uppsp_fsmi_alcdays_lrtpurg
uppsp_fsmi_alcdays_lrtnurg
uppsp_fsmi_alcdays_lrtss

plot_lav_factor_pred(lavfit = fsmi_alc_days_sem, 
                     factor_name = 'fsmi_stat', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'alcohol_days_of_lst30',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(parameterestimates(fsmi_alc_days_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(fsmi_alc_days_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_fsmi_alcdays_nofsmi_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of drinking days among all college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_fsmi_alcdays_nofsmi_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_fsmi_alcdays_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_alcdays_sem)))
```

The following models test whether drinking behavior is associated with FSMI Status, or K-SRQ Admiration variables.
As above, initial models include both the focal motive variable and gender, which are compared to models in which the coefficient for the motive variable is fixed to zero.
Significant decrease in fit is taken as evidence for an association between the motive variable and the behavioral outcome.

In the next step, the initial model is augmented by adding UPPS-P Sensation Seeking, Positive Urgency, and Negative Urgency, with the same constraint of the focal motive variable tested.
Significant difference in fit here indicates that the focal motive is associated with the outcome even when conditioning on (or perhaps because of this conditioning) the UPPS-P impulsivity and sensation-seeking variables.

For the K-SRQ, an additional test is made by including the Sociability variable in the regression.
Significant decrease in fit when the coefficient for this variable is fixed to zero indicates that it has an association with the behavioral outcome over and above the variance it shares with the Admiration variable.
The coefficients between the unconstrained and constrained model will also be examined.

### K-SRQ Admiration

```{r fig.width=4, fig.height=4}
ksrq_alc_days_null_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ 0*k_srq_admiration + gender_c', sep = '\n')
ksrq_alc_days_null_all_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ 0*k_srq_admiration + gender_c + age_c', sep = '\n')

ksrq_alc_days_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ k_srq_admiration + k_srq_sociability + gender_c', sep = '\n')
ksrq_alc_days_all_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ k_srq_admiration + k_srq_sociability + gender_c + age_c', sep = '\n')

ksrq_nosoc_alc_days_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ k_srq_admiration + 0*k_srq_sociability + gender_c', sep = '\n')
ksrq_nosoc_alc_days_all_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ k_srq_admiration + 0*k_srq_sociability + gender_c + age_c', sep = '\n')

ksrq_justsoc_alc_days_all_model <- paste(ksrq_model, 
                                 'alcohol_days_of_lst30 ~ 0*k_srq_admiration + k_srq_sociability + gender_c + age_c', sep = '\n')

uppsp_ksrq_alc_days_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_admiration + gender_c',
    sep = '\n')

uppsp_ksrq_nosr_alc_days_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_admiration + gender_c',
    sep = '\n')

uppsp_ksrq_alc_days_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_admiration + gender_c + age_c',
    sep = '\n')

uppsp_ksrq_nosr_alc_days_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_days_of_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_admiration + gender_c + age_c',
    sep = '\n')

ksrq_alc_days_modelsFN <- file.path(data_dir, 'ksrq_alc_days_models.rda')
if(!file.exists(fsmi_alc_days_modelsFN)){
    ksrq_alc_days_sem <- lavaan::lavaan(
        model = ksrq_alc_days_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_days_all_sem <- lavaan::lavaan(
        model = ksrq_alc_days_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_days_null_sem <- lavaan::lavaan(
        model = ksrq_alc_days_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_days_null_all_sem <- lavaan::lavaan(
        model = ksrq_alc_days_null_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_nosoc_alc_days_sem <- lavaan::lavaan(
        model = ksrq_nosoc_alc_days_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_nosoc_alc_days_all_sem <- lavaan::lavaan(
        model = ksrq_nosoc_alc_days_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_justsoc_alc_days_all_sem <- lavaan::lavaan(
        model = ksrq_justsoc_alc_days_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_alc_days_sem <- lavaan::lavaan(
        model = uppsp_ksrq_alc_days_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_alc_days_sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_alc_days_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_alc_days_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_alc_days_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_alc_days_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_alc_days_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_days_null_lrt <- lavaan::lavTestLRT(ksrq_nosoc_alc_days_sem,
                                                       ksrq_alc_days_null_sem)
    ksrq_alc_days_null_all_lrt <- lavaan::lavTestLRT(ksrq_nosoc_alc_days_all_sem,
                                                       ksrq_alc_days_null_all_sem)
    ksrq_alc_days_socadm_all_lrt <- lavaan::lavTestLRT(ksrq_justsoc_alc_days_all_sem,
                                                       ksrq_alc_days_all_sem)
    ksrq_alc_days_admrtn_lrt <- lavaan::lavTestLRT(ksrq_alc_days_sem,
                                                       ksrq_nosoc_alc_days_sem)
    ksrq_alc_days_admrtn_all_lrt <- lavaan::lavTestLRT(ksrq_alc_days_all_sem,
                                                       ksrq_nosoc_alc_days_all_sem)
    uppsp_ksrq_alc_days_lrt <- lavaan::lavTestLRT(uppsp_ksrq_alc_days_sem,
                                                      uppsp_ksrq_nosr_alc_days_sem)
    uppsp_ksrq_alc_days_all_lrt <- lavaan::lavTestLRT(uppsp_ksrq_alc_days_all__sem,
                                                          uppsp_ksrq_nosr_alc_days_all__sem)
    
    save(ksrq_alc_days_sem,
         ksrq_alc_days_all_sem,
         ksrq_alc_days_null_sem,
         ksrq_alc_days_null_all_sem,
         ksrq_nosoc_alc_days_sem,
         ksrq_nosoc_alc_days_all_sem,
         ksrq_justsoc_alc_days_all_sem,
         ksrq_alc_days_socadm_all_lrt,
         uppsp_ksrq_alc_days_sem,
         uppsp_ksrq_nosr_alc_days_sem,
         uppsp_ksrq_alc_days_all__sem,
         uppsp_ksrq_nosr_alc_days_all__sem,
         ksrq_alc_days_null_lrt,
         ksrq_alc_days_null_all_lrt,
         ksrq_alc_days_admrtn_lrt,
         ksrq_alc_days_admrtn_all_lrt,
         uppsp_ksrq_alc_days_lrt,
         uppsp_ksrq_alc_days_all_lrt,
         file = ksrq_alc_days_modelsFN)
} else {
    load(ksrq_alc_days_modelsFN)
}

ksrq_alc_days_sem_pred <- lavaan::lavPredict(ksrq_alc_days_sem)
ksrq_alc_days_sem_alcdays_ <- splt_fsmi_devdemog$alcohol_days_of_lst30[grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_alc_days_sem_alcdays <- ksrq_alc_days_sem_alcdays_[ksrq_alc_days_sem@Data@case.idx[[1]]]

ksrq_alc_days_all_sem_pred <- lavaan::lavPredict(ksrq_alc_days_all_sem)
ksrq_alc_days_all_sem_alcdays_ <- splt_fsmi_devdemog$alcohol_days_of_lst30
ksrq_alc_days_all_sem_alcdays <- ksrq_alc_days_all_sem_alcdays_[ksrq_alc_days_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
ggplot2::qplot(ksrq_alc_days_sem_pred[,'k_srq_admiration'],
               ksrq_alc_days_sem_alcdays,
               xlab = 'K-SRQ Admiration',
               ylab = 'Number of\nDrinking Days',
               geom = 'jitter')

ggplot2::qplot(ksrq_alc_days_all_sem_pred[,'k_srq_admiration'],
               ksrq_alc_days_all_sem_alcdays,
               xlab = 'K-SRQ Admiration',
               ylab = 'Number of\nDrinking Days',
               geom = 'jitter')
```

```{r}
ksrq_alc_days_null_lrt
ksrq_alc_days_null_all_lrt
ksrq_alc_days_admrtn_lrt
ksrq_alc_days_admrtn_all_lrt
uppsp_ksrq_alc_days_lrt
uppsp_ksrq_alc_days_all_lrt

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_alc_days_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(ksrq_alc_days_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_nosoc_alc_days_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(ksrq_nosoc_alc_days_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_alc_days_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_alc_days_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_nosoc_alc_days_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_nosoc_alc_days_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_alc_days_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_alc_days_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_alc_days_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_alc_days_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_alc_days_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_alc_days_all__sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_alc_days_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_alc_days_all__sem)))
```

K-SRQ Admiration is positively associated with number drinking days when considering the both the college and full sample.
Controlling for levels of K-SRQ Sociability results in a reversal of the sign of the coefficient and an increase in magnitude.
Removing the Sociability scale from this model does significantly decrease fit.
The sign of the Sociability coeficient is positive. 
Together, this indicating that for a given level of Sociability, higher levels on Admiration are negatively associated with number of drinking days.
Comparing a model with Admiration, and UPPS-P Sensation Seeking and (+/-) Urgency, to the same model with the coefficient for Admiration fixed to zero does not result in a significant reduction of fit.
The coefficients for both Sensation Seeking and Admiration in the combine model are positive.


### SPLT parameters

```{r fig.width=4, fig.height=4}
    
splt_alcdays_models <- lapply(
    seq_along(rl_var_names_facts),
    function(i){
        splt_alc_days_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_days_of_lst30 ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c'), sep = '\n')
        splt_alc_days_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_days_of_lst30 ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c'), sep = '\n')
        splt_alc_days_all_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_days_of_lst30 ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c + age_c'), sep = '\n')
        splt_alc_days_all_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_days_of_lst30 ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c + age_c'), sep = '\n')
        return(list(splt_alc_days_model = splt_alc_days_model,
                    splt_alc_days_null_model = splt_alc_days_null_model,
                    splt_alc_days_all_model = splt_alc_days_all_model,
                    splt_alc_days_all_null_model = splt_alc_days_all_null_model))
    })
names(splt_alcdays_models) <- names(rl_var_names_facts)

splt_alc_days_semsFN <-
    file.path(data_dir, 'splt_alc_days_semsFN.RDS')
library(future)
library(listenv)
future::plan(sequential)
splt_alc_days_sems_le <- listenv()
if(!file.exists(splt_alc_days_semsFN)){
    for(i in seq_along(splt_alcdays_models)){
        splt_alc_days_sems_le[[i]] <- future({
            splt_alc_days_sem <- lavaan::lavaan(
                model = splt_alcdays_models[[i]]$splt_alc_days_model, 
                data = splt_fsmi_devdemog_betas[grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_alc_days_null_sem <- lavaan::lavaan(
                model = splt_alcdays_models[[i]]$splt_alc_days_null_model, 
                data = splt_fsmi_devdemog_betas[grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_alc_days_all_sem <- lavaan::lavaan(
                model = splt_alcdays_models[[i]]$splt_alc_days_all_model, 
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_alc_days_all_null_sem <- lavaan::lavaan(
                model = splt_alcdays_models[[i]]$splt_alc_days_all_null_model,
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_alc_days_lrt <- lavaan::lavTestLRT(splt_alc_days_sem,
                                                        splt_alc_days_null_sem)
            splt_alc_days_all_lrt <- lavaan::lavTestLRT(splt_alc_days_all_sem,
                                                            splt_alc_days_all_null_sem)
            
            list(splt_alc_days_sem = splt_alc_days_sem,
                 splt_alc_days_null_sem = splt_alc_days_null_sem,
                 splt_alc_days_all_sem = splt_alc_days_all_sem,
                 splt_alc_days_all_null_sem = splt_alc_days_all_null_sem,
                 splt_alc_days_lrt = splt_alc_days_lrt,
                 splt_alc_days_all_lrt = splt_alc_days_all_lrt)
        })
    }
    splt_alc_days_sems <- as.list(
        lapply(splt_alc_days_sems_le, future::value)
    )
    names(splt_alc_days_sems) <- names(splt_alcdays_models)
    saveRDS(splt_alc_days_sems, splt_alc_days_semsFN)
} else {
    splt_alc_days_sems <- readRDS(splt_alc_days_semsFN)
}

splt_alc_days_chisqp <- lapply(splt_alc_days_sems,
       function(splt_alc_days_sem){
           print(splt_alc_days_sem$splt_alc_days_lrt)
           print(splt_alc_days_sem$splt_alc_days_all_lrt)
           p <- splt_alc_days_sem$splt_alc_days_lrt[2,'Pr(>Chisq)']
           p_all <- splt_alc_days_sem$splt_alc_days_all_lrt[2,'Pr(>Chisq)']
           return(c(p = p , p_all = p_all))
       })

nada <- lapply(seq_along(splt_alc_days_sems),
       function(i){
           param_label <- splt_param_labels_plaintext[names(splt_alc_days_sems)[[i]]]
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_alc_days_sems[[i]]$splt_alc_days_sem, 
                                                stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of drinking dats among college students; N obs. = ',
                   lavaan::nobs(splt_alc_days_sems[[i]]$splt_alc_days_sem))))
           
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_alc_days_sems[[i]]$splt_alc_days_all_sem, stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of drinking dats among all adolescent and college participants with SES responses; N obs. = ',
                   lavaan::nobs(splt_alc_days_sems[[i]]$splt_alc_days_all_sem))))
       })
```
Again, no $\chi^2$ tests satisfy the $\alpha = .005$ cutoff.

## Number of days during which 5+ alcoholic drinks were consumed

### FSMI Status

```{r fig.width=4, fig.height=4}
fsmi_alc_5drnk_model <- paste(fsmi_cfa_matestat_model, 
                             'alcohol_5drnks_lst30 ~ fsmi_stat + gender_c', sep = '\n')

fsmi_alc_5drnk_null_model <- paste(fsmi_cfa_matestat_model, 
                             'alcohol_5drnks_lst30 ~ 0*fsmi_stat + gender_c', sep = '\n')

sensseek_urgency_cfa <- milav::create_cfa_from_keylist(
    upps_key[c('pos_urgency','sensation_seeking','neg_urgency')])

uppsp_fsmi_alc5drk_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alc5drk_noupps_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
     'alcohol_5drnks_lst30 ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + fsmi_stat + gender_c',
     sep = '\n')

uppsp_fsmi_alc5drk_nofsmi_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alc5drk_nopurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + 0*pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alc5drk_nonurg_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_5drnks_lst30 ~ 0*neg_urgency + sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alc5drk_noss_model <- paste(
    sensseek_urgency_cfa,
    'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
    'alcohol_5drnks_lst30 ~ neg_urgency + 0*sensation_seeking + pos_urgency + fsmi_stat + gender_c',
    sep = '\n')

uppsp_fsmi_alc5drk_null_model <- paste(
    sensseek_urgency_cfa,
     'fsmi_stat =~ fsmi_qs_49 + fsmi_qs_50 + fsmi_qs_51 + fsmi_qs_52 + fsmi_qs_53 + fsmi_qs_54
',
     'alcohol_5drnks_lst30 ~ 0*neg_urgency + 0*sensation_seeking + 0*pos_urgency + 0*fsmi_stat + gender_c',
     sep = '\n')

fsmi_alc_5drnk_modelsFN <- file.path(data_dir, 'fsmi_alc_5drnk_models.rda')
if(!file.exists(fsmi_alc_5drnk_modelsFN)){
    fsmi_alc_5drnk_sem <- lavaan::lavaan(
        model = fsmi_alc_5drnk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    fsmi_alc_5drnk_null_sem <- lavaan::lavaan(
        model = fsmi_alc_5drnk_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_noupps_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_noupps_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_nofsmi_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_nofsmi_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_nopurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_nopurg_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_nonurg_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_nonurg_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_noss_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_noss_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_fsmi_alc5drk_null_sem <- lavaan::lavaan(
        model = uppsp_fsmi_alc5drk_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, 
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    
    fsmi_alc_5drnk_lrt <- lavaan::lavTestLRT(fsmi_alc_5drnk_sem,
                                           fsmi_alc_5drnk_null_sem)
    uppsp_fsmi_alc5drk_lrt <- lavaan::lavTestLRT(uppsp_fsmi_alc5drk_sem,
                                                 uppsp_fsmi_alc5drk_noupps_sem,
                                                 uppsp_fsmi_alc5drk_null_sem)
    
    uppsp_fsmi_alc5drk_lrt2 <- lavaan::lavTestLRT(uppsp_fsmi_alc5drk_sem,
                                                  uppsp_fsmi_alc5drk_nofsmi_sem,
                                                  uppsp_fsmi_alc5drk_null_sem)
    
    uppsp_fsmi_alc5drk_lrtpurg <- lavaan::lavTestLRT(uppsp_fsmi_alc5drk_sem,
                                                     uppsp_fsmi_alc5drk_nopurg_sem,
                                                     uppsp_fsmi_alc5drk_null_sem)
    
    uppsp_fsmi_alc5drk_lrtnurg <- lavaan::lavTestLRT(uppsp_fsmi_alc5drk_sem,
                                                     uppsp_fsmi_alc5drk_nonurg_sem,
                                                     uppsp_fsmi_alc5drk_null_sem)
    
    uppsp_fsmi_alc5drk_lrtss <- lavaan::lavTestLRT(uppsp_fsmi_alc5drk_sem,
                                                   uppsp_fsmi_alc5drk_noss_sem,
                                                   uppsp_fsmi_alc5drk_null_sem)
    
    save(fsmi_alc_5drnk_sem,
         uppsp_fsmi_alc5drk_sem,
         uppsp_fsmi_alc5drk_noupps_sem,
         uppsp_fsmi_alc5drk_nofsmi_sem,
         uppsp_fsmi_alc5drk_nopurg_sem,
         uppsp_fsmi_alc5drk_nonurg_sem,
         uppsp_fsmi_alc5drk_noss_sem,
         uppsp_fsmi_alc5drk_null_sem,
         fsmi_alc_5drnk_lrt,
         uppsp_fsmi_alc5drk_lrt,
         uppsp_fsmi_alc5drk_lrt2,
         uppsp_fsmi_alc5drk_lrtpurg,
         uppsp_fsmi_alc5drk_lrtnurg,
         uppsp_fsmi_alc5drk_lrtss,
         file = fsmi_alc_5drnk_modelsFN)
} else {
    load(fsmi_alc_5drnk_modelsFN)
}

fsmi_alc_5drnk_sem_pred <- lavaan::lavPredict(fsmi_alc_5drnk_sem)
fsmi_alc_5drnk_sem_alc5drk_ <- splt_fsmi_devdemog$alcohol_5drnks_lst30[
    splt_fsmi_devdemog$partnered == 0 &
        grepl('yads', splt_fsmi_devdemog$sample)]
fsmi_alc_5drnk_sem_alc5drk <- fsmi_alc_5drnk_sem_alc5drk_[fsmi_alc_5drnk_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
fsmi_alc_5drnk_lrt
uppsp_fsmi_alc5drk_lrt
uppsp_fsmi_alc5drk_lrt2
uppsp_fsmi_alc5drk_lrtpurg
uppsp_fsmi_alc5drk_lrtnurg
uppsp_fsmi_alc5drk_lrtss

plot_lav_factor_pred(lavfit = fsmi_alc_5drnk_sem, 
                     factor_name = 'fsmi_stat', 
                     orig_data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),], 
                     dv_name = 'alcohol_5drnks_lst30',
                     geom = 'jitter')

knitr::kable(
    dplyr::filter(standardizedsolution(fsmi_alc_5drnk_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(fsmi_alc_5drnk_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_alc5drk_nofsmi_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of heavy drinking days among all college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_fsmi_alc5drk_nofsmi_sem)))

knitr::kable(
    dplyr::filter(standardizedsolution(uppsp_fsmi_alc5drk_sem, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'FSMI Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_fsmi_alc5drk_sem)))
```

In the college student sample, model fit does not decrease significantly when the association between number of heavy drinking days and FSMI Status is fixed to 0 for any model.
However, as above, comparing the model that includes FSMI Status along with UPPS-P Sensation Seeking, and Negative and Positive Urgency to the same model with the coefficient for Sensation Seeking fixed to 0 shows significant fit decrease.

### K-SRQ Admiration

```{r fig.width=4, fig.height=4}
ksrq_alc_5drnk_null_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ 0*k_srq_admiration + gender_c', sep = '\n')
ksrq_alc_5drnk_null_all_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ 0*k_srq_admiration + gender_c + age_c', sep = '\n')

ksrq_alc_5drnk_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ k_srq_admiration + k_srq_sociability + gender_c', sep = '\n')
ksrq_alc_5drnk_all_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ k_srq_admiration + k_srq_sociability + gender_c + age_c', sep = '\n')

ksrq_nosoc_alc_5drnk_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ k_srq_admiration + 0*k_srq_sociability + gender_c', sep = '\n')
ksrq_nosoc_alc_5drnk_all_model <- paste(ksrq_model, 
                                 'alcohol_5drnks_lst30 ~ k_srq_admiration + 0*k_srq_sociability + gender_c + age_c', sep = '\n')

uppsp_ksrq_alc_5drnk_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_admiration + gender_c',
    sep = '\n')

uppsp_ksrq_nosr_alc_5drnk_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_admiration + gender_c',
    sep = '\n')

uppsp_ksrq_alc_5drnk_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + k_srq_admiration + gender_c + age_c',
    sep = '\n')

uppsp_ksrq_nosr_alc_5drnk_all_model <- paste(
    ksrq_model,
    sensseek_urgency_cfa,
    'alcohol_5drnks_lst30 ~ neg_urgency + sensation_seeking + pos_urgency + 0*k_srq_admiration + gender_c + age_c',
    sep = '\n')

ksrq_alc_5drnk_modelsFN <- file.path(data_dir, 'ksrq_alc_5drnk_models.rda')
if(!file.exists(fsmi_alc_5drnk_modelsFN)){
    ksrq_alc_5drnk_sem <- lavaan::lavaan(
        model = ksrq_alc_5drnk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_5drnk_all_sem <- lavaan::lavaan(
        model = ksrq_alc_5drnk_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_5drnk_null_sem <- lavaan::lavaan(
        model = ksrq_alc_5drnk_null_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_5drnk_null_all_sem <- lavaan::lavaan(
        model = ksrq_alc_5drnk_null_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_nosoc_alc_5drnk_sem <- lavaan::lavaan(
        model = ksrq_nosoc_alc_5drnk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_nosoc_alc_5drnk_all_sem <- lavaan::lavaan(
        model = ksrq_nosoc_alc_5drnk_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_alc_5drnk_sem <- lavaan::lavaan(
        model = uppsp_ksrq_alc_5drnk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_alc_5drnk_sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_alc_5drnk_model, 
        data = splt_fsmi_devdemog[grepl('yads', splt_fsmi_devdemog$sample),],
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_alc_5drnk_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_alc_5drnk_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    uppsp_ksrq_nosr_alc_5drnk_all__sem <- lavaan::lavaan(
        model = uppsp_ksrq_nosr_alc_5drnk_all_model, 
        data = splt_fsmi_devdemog,
        missing = 'listwise', estimator = 'WLSMV',
        int.ov.free = TRUE, int.lv.free = FALSE, 
        auto.fix.first = T, std.lv = F, std.ov = F,
        auto.fix.single = TRUE, auto.var = TRUE, 
        auto.cov.lv.x = TRUE, auto.th = TRUE, 
        auto.delta = TRUE, auto.cov.y = TRUE)
    
    ksrq_alc_5drnk_null_lrt <- lavaan::lavTestLRT(ksrq_nosoc_alc_5drnk_sem,
                                                       ksrq_alc_5drnk_null_sem)
    ksrq_alc_5drnk_null_all_lrt <- lavaan::lavTestLRT(ksrq_nosoc_alc_5drnk_all_sem,
                                                       ksrq_alc_5drnk_null_all_sem)
    ksrq_alc_5drnk_admrtn_lrt <- lavaan::lavTestLRT(ksrq_alc_5drnk_sem,
                                                       ksrq_nosoc_alc_5drnk_sem)
    ksrq_alc_5drnk_admrtn_all_lrt <- lavaan::lavTestLRT(ksrq_alc_5drnk_all_sem,
                                                    ksrq_nosoc_alc_5drnk_all_sem)
    uppsp_ksrq_alc_5drnk_lrt <- lavaan::lavTestLRT(uppsp_ksrq_alc_5drnk_sem,
                                                      uppsp_ksrq_nosr_alc_5drnk_sem)
    uppsp_ksrq_alc_5drnk_all_lrt <- lavaan::lavTestLRT(uppsp_ksrq_alc_5drnk_all__sem,
                                                          uppsp_ksrq_nosr_alc_5drnk_all__sem)
    
    save(ksrq_alc_5drnk_sem,
         ksrq_alc_5drnk_all_sem,
         ksrq_alc_5drnk_null_sem,
         ksrq_alc_5drnk_null_all_sem,
         ksrq_nosoc_alc_5drnk_sem,
         ksrq_nosoc_alc_5drnk_all_sem,
         uppsp_ksrq_alc_5drnk_sem,
         uppsp_ksrq_nosr_alc_5drnk_sem,
         uppsp_ksrq_alc_5drnk_all__sem,
         uppsp_ksrq_nosr_alc_5drnk_all__sem,
         ksrq_alc_5drnk_null_lrt,
         ksrq_alc_5drnk_null_all_lrt,
         ksrq_alc_5drnk_admrtn_lrt,
         ksrq_alc_5drnk_admrtn_all_lrt,
         uppsp_ksrq_alc_5drnk_lrt,
         uppsp_ksrq_alc_5drnk_all_lrt,
         file = ksrq_alc_5drnk_modelsFN)
} else {
    load(ksrq_alc_5drnk_modelsFN)
}

ksrq_alc_5drnk_sem_pred <- lavaan::lavPredict(ksrq_alc_5drnk_sem)
ksrq_alc_5drnk_sem_alc5drk_ <- splt_fsmi_devdemog$alcohol_5drnks_lst30[grepl('yads', splt_fsmi_devdemog$sample)]
ksrq_alc_5drnk_sem_alc5drk <- ksrq_alc_5drnk_sem_alc5drk_[ksrq_alc_5drnk_sem@Data@case.idx[[1]]]

ksrq_alc_5drnk_all_sem_pred <- lavaan::lavPredict(ksrq_alc_5drnk_all_sem)
ksrq_alc_5drnk_all_sem_alc5drk_ <- splt_fsmi_devdemog$alcohol_5drnks_lst30
ksrq_alc_5drnk_all_sem_alc5drk <- ksrq_alc_5drnk_all_sem_alc5drk_[ksrq_alc_5drnk_all_sem@Data@case.idx[[1]]]
```

```{r fig.width=3.25, fig.height=2}
ggplot2::qplot(ksrq_alc_5drnk_sem_pred[,'k_srq_admiration'],
               ksrq_alc_5drnk_sem_alc5drk,
               xlab = 'K-SRQ Admiration',
               ylab = 'Number of\nHeavy Drinking Days',
               geom = 'jitter')

ggplot2::qplot(ksrq_alc_5drnk_all_sem_pred[,'k_srq_admiration'],
               ksrq_alc_5drnk_all_sem_alc5drk,
               xlab = 'K-SRQ Admiration',
               ylab = 'Number of\nHeavy Drinking Days',
               geom = 'jitter')
```

```{r}
ksrq_alc_5drnk_null_lrt
ksrq_alc_5drnk_null_all_lrt
ksrq_alc_5drnk_admrtn_lrt
ksrq_alc_5drnk_admrtn_all_lrt
uppsp_ksrq_alc_5drnk_lrt
uppsp_ksrq_alc_5drnk_all_lrt

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_alc_5drnk_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(ksrq_alc_5drnk_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_nosoc_alc_5drnk_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(ksrq_nosoc_alc_5drnk_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_alc_5drnk_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_alc_5drnk_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(ksrq_nosoc_alc_5drnk_all_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(ksrq_nosoc_alc_5drnk_all_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_alc_5drnk_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_alc_5drnk_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_alc_5drnk_sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among college students; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_alc_5drnk_sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_alc_5drnk_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_alc_5drnk_all__sem)))

knitr::kable(
    dplyr::filter(parameterestimates(uppsp_ksrq_nosr_alc_5drnk_all__sem, stan = T, ci = T), op == '~'),
    digits = 2,
    caption = paste0(
        'K-SRQ Predicting number of heavy drinking days among all adolescent and college participants with SES responses; N obs. = ',
        lavaan::nobs(uppsp_ksrq_nosr_alc_5drnk_all__sem)))
```

K-SRQ Admiration is positively associated with number heavy drinking days when considering the both the college and full sample.
Controlling for levels of K-SRQ Sociability results in a reversal of the sign of the coefficient.
Removing the Sociability scale from this model does significantly decrease fit.
The sign of the Sociability coeficient is positive in the model with both K-SRQ scales. 
Together, this indicates that for a given level of Sociability, higher levels on Admiration are negatively associated with more heavy-drinking days.
Comparing a model with Admiration, and UPPS-P Sensation Seeking and (+/-) Urgency, to the same model with the coefficient for Admiration fixed to zero does not result in a significant reduction of fit.
The coefficients for both Sensation Seeking and Admiration in the combined model are positive.

### SPLT parameters

```{r fig.width=4, fig.height=4}
    
splt_alc5drk_models <- lapply(
    seq_along(rl_var_names_facts),
    function(i){
        splt_alc_5drnk_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_5drnks_lst30 ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c'), sep = '\n')
        splt_alc_5drnk_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_5drnks_lst30 ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c'), sep = '\n')
        splt_alc_5drnk_all_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_5drnks_lst30 ~ ',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c + age_c'), sep = '\n')
        splt_alc_5drnk_all_null_model <- paste(
            rl_var_names_facts[[i]], 
            paste0('alcohol_5drnks_lst30 ~ 0*',
                   names(rl_var_names_facts)[[i]],
                   '_PplrUHngT_fac + gender_c + age_c'), sep = '\n')
        return(list(splt_alc_5drnk_model = splt_alc_5drnk_model,
                    splt_alc_5drnk_null_model = splt_alc_5drnk_null_model,
                    splt_alc_5drnk_all_model = splt_alc_5drnk_all_model,
                    splt_alc_5drnk_all_null_model = splt_alc_5drnk_all_null_model))
    })
names(splt_alc5drk_models) <- names(rl_var_names_facts)

splt_alc_5drnk_semsFN <-
    file.path(data_dir, 'splt_alc_5drnk_semsFN.RDS')
library(future)
library(listenv)
future::plan(sequential)
splt_alc_5drnk_sems_le <- listenv()
if(!file.exists(splt_alc_5drnk_semsFN)){
    for(i in seq_along(splt_alc5drk_models)){
        splt_alc_5drnk_sems_le[[i]] <- future({
            splt_alc_5drnk_sem <- lavaan::lavaan(
                model = splt_alc5drk_models[[i]]$splt_alc_5drnk_model, 
                data = splt_fsmi_devdemog_betas[grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_alc_5drnk_null_sem <- lavaan::lavaan(
                model = splt_alc5drk_models[[i]]$splt_alc_5drnk_null_model, 
                data = splt_fsmi_devdemog_betas[grepl('yads', splt_fsmi_devdemog_betas$sample),],
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_alc_5drnk_all_sem <- lavaan::lavaan(
                model = splt_alc5drk_models[[i]]$splt_alc_5drnk_all_model, 
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            splt_alc_5drnk_all_null_sem <- lavaan::lavaan(
                model = splt_alc5drk_models[[i]]$splt_alc_5drnk_all_null_model,
                data = splt_fsmi_devdemog_betas,
                missing = 'listwise', estimator = 'WLSMV',
                int.ov.free = TRUE, int.lv.free = FALSE, 
                auto.fix.first = T, std.lv = F, std.ov = F,
                auto.fix.single = TRUE, auto.var = TRUE, 
                auto.cov.lv.x = TRUE, auto.th = TRUE, 
                auto.delta = TRUE, auto.cov.y = TRUE)
            
            splt_alc_5drnk_lrt <- lavaan::lavTestLRT(splt_alc_5drnk_sem,
                                                        splt_alc_5drnk_null_sem)
            splt_alc_5drnk_all_lrt <- lavaan::lavTestLRT(splt_alc_5drnk_all_sem,
                                                            splt_alc_5drnk_all_null_sem)
            
            list(splt_alc_5drnk_sem = splt_alc_5drnk_sem,
                 splt_alc_5drnk_null_sem = splt_alc_5drnk_null_sem,
                 splt_alc_5drnk_all_sem = splt_alc_5drnk_all_sem,
                 splt_alc_5drnk_all_null_sem = splt_alc_5drnk_all_null_sem,
                 splt_alc_5drnk_lrt = splt_alc_5drnk_lrt,
                 splt_alc_5drnk_all_lrt = splt_alc_5drnk_all_lrt)
        })
    }
    splt_alc_5drnk_sems <- as.list(
        lapply(splt_alc_5drnk_sems_le, future::value)
    )
    names(splt_alc_5drnk_sems) <- names(splt_alc5drk_models)
    saveRDS(splt_alc_5drnk_sems, splt_alc_5drnk_semsFN)
} else {
    splt_alc_5drnk_sems <- readRDS(splt_alc_5drnk_semsFN)
}

splt_alc_5drnk_chisqp <- lapply(splt_alc_5drnk_sems,
       function(splt_alc_5drnk_sem){
           print(splt_alc_5drnk_sem$splt_alc_5drnk_lrt)
           print(splt_alc_5drnk_sem$splt_alc_5drnk_all_lrt)
           chisq <- splt_alc_5drnk_sem$splt_alc_5drnk_lrt[2,'Chisq diff']
           df <- splt_alc_5drnk_sem$splt_alc_5drnk_lrt[2,'Df diff']
           p <- splt_alc_5drnk_sem$splt_alc_5drnk_lrt[2,'Pr(>Chisq)']
           chisq_all <- splt_alc_5drnk_sem$splt_alc_5drnk_all_lrt[2,'Chisq diff']
           df_all <- splt_alc_5drnk_sem$splt_alc_5drnk_all_lrt[2,'Df diff']
           p_all <- splt_alc_5drnk_sem$splt_alc_5drnk_all_lrt[2,'Pr(>Chisq)']
           return(c(chisq = chisq,
                    df = df,
                    p = p, 
                    chisq_all = chisq_all,
                    df_all = df_all,
                    p_all = p_all))
       })

nada <- lapply(seq_along(splt_alc_5drnk_sems),
       function(i){
           param_label <- splt_param_labels_plaintext[names(splt_alc_5drnk_sems)[[i]]]
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_alc_5drnk_sems[[i]]$splt_alc_5drnk_sem, 
                                                stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of heavy drinking dats among college students; N obs. = ',
                   lavaan::nobs(splt_alc_5drnk_sems[[i]]$splt_alc_5drnk_sem))))
           
           print(knitr::kable(
               dplyr::filter(parameterestimates(splt_alc_5drnk_sems[[i]]$splt_alc_5drnk_all_sem, stan = T), op == '~'),
               digits = 2,
               caption = paste0(
                   param_label, 
                   ' predicting number of heavy drinking dats among all adolescent and college participants with SES responses; N obs. = ',
                   lavaan::nobs(splt_alc_5drnk_sems[[i]]$splt_alc_5drnk_all_sem))))
       })
```
Again, no $\chi^2$ tests satisfy the $\alpha = .005$ cutoff. The largest effect size is with the $\epsilon$ contrast variable, but it has the wrong sign, with higher learning rates in the Popular/Unpopular condition (relative to baseline) being associated with fewer numbers of heavy drinking days.


```{r}
splt_sems <- lapply(ls(pattern = 'splt_.*_sems$'), function(a) {
    sems <- eval(parse(text = a))
    chisqs <- lapply(seq_along(sems), function(i){
        if(!'try-error' %in% class(sems[[i]])){
            return(c(splt_var = names(sems)[[i]],
                     get_chisq_tests(sems[[i]], verbose = F)))
        }
    })
    chisqs_df <- as.data.frame(do.call(rbind, chisqs))
    return(chisqs_df)
})
names(splt_sems) <- ls(pattern = 'splt_.*_sems$')
splt_sems_df <- dplyr::bind_rows(splt_sems, .id = 'outcome_var')

outcomevar_labels <- c(
    'splt_num_partners_sems' = 'Number of partners',
    'splt_sex_freq_sems' = 'Number sexual encounters',
    'splt_use_protection_sems' = 'Safe sex practice',
    'splt_alc_days_sems' = 'Days with 1+ drinks',
    'splt_alc_5drnk_sems' = 'Days with 5+ drinks'
)

outcomevar_con_labels <- c(
    'splt_num_partners_sems' = 'Dating/Looking',
    'splt_sex_freq_sems' = 'Dating/Looking',
    'splt_use_protection_sems' = 'Dating/Looking',
    'splt_alc_5drnk_sems' = 'Popular/Unpopular',
    'splt_alc_days_sems' = 'Popular/Unpopular'
)

splt_param_labels_plaintext_sems <- sub('(First|Last)-half optimal responses', 
                                        '\\1 1/2 $p_{\\\\text{opt}}$', 
                                        splt_param_labels_plaintext)

splt_sems_df_4table <- dplyr::select(
    dplyr::arrange(
        dplyr::mutate(
            splt_sems_df,
            chisq = sprintf('%0.1f', as.numeric(chisq)),
            p = sub('^0\\.', '.', sprintf('%0.2f', as.numeric(p))),
            chisq_all = sprintf('%0.1f', as.numeric(chisq_all)),
            p_all = sub('^0\\.', '.', sprintf('%0.2f', as.numeric(p_all))),
            splt_var = splt_param_labels_plaintext_sems[splt_var],
            contrast = outcomevar_con_labels[outcome_var],
            ordernum = as.numeric(factor(outcomevar_labels[outcome_var], 
                                         levels = outcomevar_labels)),
            outcome_var = outcomevar_labels[outcome_var],
            togroup = outcome_var),
        ordernum),
    togroup, contrast, outcome_var, splt_var, chisq, p, chisq_all, p_all)

splt_sems_df_4table <- dplyr::mutate(
    dplyr::group_by(splt_sems_df_4table, togroup),
    outcome_var = c(outcome_var[[1]], 
                    'SPLT contrast: ',
                    contrast[[1]],
                    rep('', n()-3)))

knitr::kable(splt_sems_df_4table[,-(1:2)],
             col.names = c('Behavior variable',
                           'SPLT variable',
                           '$\\Delta\\chi_{\\text{ltd}}^{2}$',
                           '$p_{\\text{ltd}}$',
                           '$\\Delta\\chi_{\\text{full}}^{2}$',
                           '$p_{\\text{full}}$'),
             align = c('l', 'l', 'r', 'r', 'r', 'r'))
```

$\Delta\chi^2$

# References

```{r echo = F, eval = T}
save.image(file = file.path(save_out_dir, 'fsmi-cfa.rda'))
```
